# Developer Documentation: Sending Data to Java API for Payment Initialization

## Overview

This document provides an updated, step-by-step guide for developers integrating with the Java-based payment gateway API. It provides insights into the payment initiation request, response handling, logging, and real-world examples.

### Table of Contents

1. [Introduction](#introduction)
2. [API Endpoint Details](#api-endpoint-details)
3. [Request Payload Structure](#request-payload-structure)
4. [Message Verifier Generation](#message-verifier-generation)
5. [Sending the Request](#sending-the-request)
6. [Handling the Response](#handling-the-response)
7. [PHP Implementation Example](#php-implementation-example)
8. [Error Handling and Troubleshooting](#error-handling-and-troubleshooting)
9. [Testing and Debugging](#testing-and-debugging)

## Introduction

The Java API is used to initiate payment transactions by providing merchant and payment details. This guide ensures that developers prepare the correct request payload, generate required verifications, and manage both responses and errors effectively.

## API Endpoint Details

- **URL**: `https://java-api-endpoint.com/IPGWeb/servlet/`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Authentication**: Requests must include necessary authentication headers if required by the API.

## Request Payload Structure

The payload for the payment initiation request must be in JSON format, with the following fields:

| Field Name           | Type    | Description                                                               | Mandatory |
|----------------------|---------|---------------------------------------------------------------------------|-----------|
| `msgName`            | String  | Name of the message (`PaymentInitRequest`).                               | Yes       |
| `version`            | String  | Version of the API, e.g., `1`.                                            | Yes       |
| `action`             | String  | Type of transaction (`1` for Purchase, `4` for Authorization).            | Yes       |
| `currencyCode`       | String  | Currency code for the transaction, e.g., `USD`, `EUR`.                    | Yes       |
| `amt`                | String  | Transaction amount in the format `NNNNNNNNNN.NN`, e.g., `100.00`.         | Yes       |
| `trackId`            | String  | Unique identifier for the transaction, generated by the merchant.         | Yes       |
| `responseURL`        | String  | URL to which the user will be redirected upon successful payment.         | Yes       |
| `errorURL`           | String  | URL to which the user will be redirected if an error occurs.              | Yes       |
| `recurAction`        | String  | Recurring payment action*                                                 | Yes       |
| `payInst`            | String  | Payment instrument, e.g., `CC` for Credit Card.                           | No        |
| `paymentTimeout`     | String  | Duration of the payment session in minutes, e.g., `30`.                   | No        |
| `cardSHA2`           | String  | Whether the card SHA2 hash should be sent (`Y` or `N`).                   | No        |
| `bankStmtFreeText`   | String  | Free text to be included in the bank statement.                           | No        |
| `notificationFormat` | String  | Format of the notification, either `xml` or `json`.                       | No        |
| `paymentPageMode`    | String  | Payment page mode (`0` for Standard, `1` for Lightbox).                   | No        |
| `langId`             | String  | Language**                                                                | No        |
| `udf1` - `udf5`      | String  | User-defined fields for custom information to be passed back.             | No        |

* recurAction Possible values (case insensitive): `""` for normal e-commerce order, `activation` for new Recurring Payment activation, `consumer_initiated` for card-on-file consumer-initiated payment.
** langId in which HPP will be displayed and for notification email. Supported values are: `ITA` (Italian), `USA` (English), `FRA` (French), `DEU` (German), `ESP` (Spanish), `SLO` (Slovenian), `SRB` (Serbian), `POR` (Portuguese), `RUS` (Russian).

### Message Verifier Generation

To ensure data integrity, the `msgVerifier` field must be generated by concatenating specific fields, hashing them with SHA-256, and encoding the hash in Base64.

The fields used for generating the `msgVerifier` are as follows (concatenated in the exact order):

- `msgName`, `version`, `id`, `password`, `amt`, `trackid`, `udf1`, `SECRET KEY`, `udf5`

**Steps:**
1. **Concatenate the field values** (remove any spaces).
2. **Hash the concatenated string** using SHA-256.
3. **Encode the hash** using Base64 to create the final `msgVerifier` value.

### Example of `msgVerifier` Generation

```java
public static void main(String[] args) { 
    try { 
        String messageVerifierBase = "PaymentInitRequest189110001test123415.00TRACK123AAYXKZPOQ9RRLGPDED5D3PC5BJEE"; 
        MessageDigest digest = MessageDigest.getInstance("SHA-256"); 
        byte[] hashBytes = digest.digest(messageVerifierBase.getBytes()); 
        String msgVerifier = Base64.getEncoder().encodeToString(hashBytes); 
        System.out.println("msgVerifier: " + msgVerifier); 
    } catch (Exception e) {
        e.printStackTrace(); 
    }
}
```

## Sending the Request

To send data to the Java API:

1. **Prepare the JSON Payload**: Create a JSON object with the required parameters.
2. **Initiate the Request**: Use an HTTP client (e.g., cURL, Postman, or a custom script) to send the JSON payload to the API.
3. **Set Headers**: Set `Content-Type` to `application/json`.

## Handling the Response

The Java API responds with a JSON object containing:

- **`paymentId`**: A unique identifier for the payment.
- **`browserRedirectionURL`**: URL to redirect the user to complete payment.

### Sample Response

```json
{
  "paymentId": "1234567890",
  "browserRedirectionURL": "https://payment-gateway.com/redirect?paymentID=1234567890",
  "responsecode": "00",
  "msgVerifier": "s6VGF9LprNkHnYXqFdBmpYkuPKvhtB2kiRs6Zf+qDM4="
}
```

### Redirection

Use the `browserRedirectionURL` to redirect the user to continue the payment process. Store the `paymentId` for tracking purposes.

## PHP Implementation Example

Below is a sample PHP script for sending the payment initiation request following WooCommerce and WordPress coding standards:

```php
<?php
// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

$request_data = [
    'msgName'            => 'PaymentInitRequest',
    'version'            => '1',
    'action'             => '1',
    'currencyCode'       => 'USD',
    'amt'                => '100.00',
    'trackId'            => uniqid( 'TRACK' ),
    'responseURL'        => esc_url( 'https://your-website.com/success' ),
    'errorURL'           => esc_url( 'https://your-website.com/error' ),
    'recurAction'        => '',
    'payInst'            => 'VPAS',
    'paymentTimeout'     => '30',
    'cardSHA2'           => 'Y',
    'notificationFormat' => 'json',
    'paymentPageMode'    => '0',
    'langId'             => 'USA',
    'udf1'               => sanitize_text_field( 'AA' ),
    'udf2'               => sanitize_text_field( 'BB' ),
    'udf3'               => sanitize_text_field( 'CC' ),
    'udf4'               => sanitize_text_field( 'DD' ),
    'udf5'               => sanitize_text_field( 'EE' ),
];

// Convert request data to JSON.
$request_payload = wp_json_encode( $request_data );

// Endpoint URL.
$api_url = esc_url( 'https://java-api-endpoint.com/IPGWeb/servlet/' );

// Use cURL to send the request.
$ch = curl_init( $api_url );
curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
curl_setopt( $ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
] );
curl_setopt( $ch, CURLOPT_POST, true );
curl_setopt( $ch, CURLOPT_POSTFIELDS, $request_payload );

// Execute the request.
$response = curl_exec( $ch );

// Handle response and errors.
if ( curl_errno( $ch ) ) {
    error_log( 'Error: ' . curl_error( $ch ) );
} else {
    // Log the response for debugging purposes.
    error_log( 'Response: ' . print_r( $response, true ) );
}

curl_close( $ch );
?>
```

## Error Handling and Troubleshooting

- **API Errors**: Handle error fields like `errorCode`, `errorService`, and `errorDesc` to understand what went wrong.
- **Network Issues**: Detect issues using `curl_errno()` in PHP, and handle them gracefully.
- **Logging**: Log request and response data using `error_log()`, but **never** log sensitive information.

### Example Error Response

```json
{
  "errorCode": "05",
  "errorService": "Authorization Service",
  "errorDesc": "Do not honor",
  "msgVerifier": "xyzGeneratedVerifier"
}
```

## Testing and Debugging

- **Use Postman**: Validate API responses manually.
- **Mock URLs**: Use mock URLs during development to ensure correct handling of both success and failure responses.
- **Testing Environments**: Use IPG's test environments to validate the end-to-end payment flow.

## Conclusion

This updated developer guide integrates insights from real-world logs, ensuring that developers have the most accurate and comprehensive reference for integrating with the payment gateway API. Proper alignment between the API payload and logging ensures smoother development and testing phases.

Feel free to reach out for more detailed troubleshooting or questions regarding your specific integration scenario.