This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repopack on: 2024-10-29T18:15:49.473Z

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.
</notes>

<additional_info>

For more information about Repopack, visit: https://github.com/yamadashy/repopack
</additional_info>

</file_summary>

<repository_structure>
assets/
  css/
    ipg-admin.css
    ipg-styles.css
  js/
    ipg-admin.js
    ipg-scripts.js
includes/
  Core/
    class-novabankaipggateway.php
  Exceptions/
    class-novabankaipgexception.php
  Services/
    class-notificationservice.php
    class-paymentservice.php
  Utils/
    class-apihandler.php
    class-config.php
    class-logger.php
    class-messagehandler.php
    class-sharedutilities.php
    class-threedshandler.php
.cursorignore
.cursorrules
.gitignore
Asoft IPG 3DS eCommerce Transaction flow.md
AsoftIPG-integration-guide.xml
class-novabankaipg.php
dev-class_responsibilities.md
dev-message_verifier_hash_example.md
dev-payment-example.md
dev-plugin_config_option_example.md
dev-proces_payment_example.md
dev-response_interface_example.md
gateway-33-config.json
ipg-gateway-example-php.md
java-api-developer-guide.md
</repository_structure>

<repository_files>
This section contains the contents of the repository's files.

<file path="assets/css/ipg-admin.css">
/* assets/css/ipg-admin.css */

.ipg-admin-section {
    padding: 20px;
    background: #fff;
    border: 1px solid #ddd;
    margin: 10px 0;
}

.ipg-field-row {
    margin: 15px 0;
}

.ipg-field-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.ipg-field-row input[type="text"],
.ipg-field-row input[type="password"] {
    width: 400px;
    max-width: 100%;
}

.ipg-field-description {
    color: #666;
    font-style: italic;
    margin-top: 5px;
}

.ipg-test-mode-notice {
    background: #fff8e5;
    border-left: 4px solid #ffb900;
    padding: 10px;
    margin: 10px 0;
}

/* Transaction details table */
.ipg-transaction-details {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.ipg-transaction-details th,
.ipg-transaction-details td {
    padding: 8px;
    text-align: left;
    border: 1px solid #ddd;
}

.ipg-transaction-details th {
    background: #f8f8f8;
}
</file>

<file path="assets/css/ipg-styles.css">
/* assets/css/ipg-styles.css */

/* Payment form styling */
.ipg-payment-form {
    max-width: 600px;
    margin: 20px auto;
    padding: 20px;
}

/* Loading overlay for redirect */
.ipg-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.ipg-loading-overlay.active {
    display: flex;
}

.ipg-loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Payment status messages */
.ipg-status-message {
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
}

.ipg-status-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.ipg-status-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

/* Animation keyframes */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</file>

<file path="assets/js/ipg-admin.js">
// assets/js/ipg-admin.js

(function($) {
    'use strict';

    const NovaBankaIPGAdmin = {
        init: function() {
            this.initializeTooltips();
            this.handleTestMode();
            this.initializeValidation();
        },

        initializeTooltips: function() {
            $('.ipg-help-tip').tipTip({
                'attribute': 'data-tip',
                'fadeIn': 50,
                'fadeOut': 50,
                'delay': 200
            });
        },

        handleTestMode: function() {
            const testModeCheckbox = $('#woocommerce_novabankaipg_testmode');
            const credentialsSection = $('.ipg-credentials-section');

            testModeCheckbox.on('change', function() {
                if ($(this).is(':checked')) {
                    credentialsSection.before(
                        '<div class="ipg-test-mode-notice">' +
                        'Test mode is enabled - test credentials will be used.' +
                        '</div>'
                    );
                } else {
                    $('.ipg-test-mode-notice').remove();
                }
            });

            // Trigger on page load
            testModeCheckbox.trigger('change');
        },

        initializeValidation: function() {
            const form = $('form#mainform');

            form.on('submit', function(e) {
                const terminal_id = $('#woocommerce_novabankaipg_terminal_id').val();
                const terminal_password = $('#woocommerce_novabankaipg_terminal_password').val();
                const secret_key = $('#woocommerce_novabankaipg_secret_key').val();

                if ($('#woocommerce_novabankaipg_enabled').is(':checked')) {
                    if (!terminal_id || !terminal_password || !secret_key) {
                        e.preventDefault();
                        alert('Please provide all required credentials for the payment gateway.');
                        return false;
                    }
                }
            });
        }
    };

    // Initialize on document ready
    $(document).ready(function() {
        NovaBankaIPGAdmin.init();
    });

})(jQuery);
</file>

<file path="assets/js/ipg-scripts.js">
(function($) {
    'use strict';

    const NovaBankaIPG = {
        init: function() {
            this.form = $('form.checkout');
            this.submitButton = $('button#place_order');
            this.loadingOverlay = $('.ipg-loading-overlay');
            this.initializeEvents();
        },

        initializeEvents: function() {
            // Handle form submission
            this.form.on('checkout_place_order_novabankaipg', this.handleSubmit.bind(this));

            // Handle HPP return
            if (window.location.href.indexOf('novabankaipg-return') > -1) {
                this.handleReturn();
            }
        },

        handleSubmit: function() {
            this.showLoading();
            return true; // Allow form submission
        },

        showLoading: function() {
            this.loadingOverlay.addClass('active');
            this.submitButton.prop('disabled', true);
        },

        hideLoading: function() {
            this.loadingOverlay.removeClass('active');
            this.submitButton.prop('disabled', false);
        },

        handleReturn: function() {
            // Handle return from HPP
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('payment_status');

            if (status === 'success') {
                this.showMessage('Payment completed successfully.', 'success');
            } else if (status === 'cancel') {
                this.showMessage('Payment was cancelled.', 'error');
            } else if (status === 'error') {
                this.showMessage('Payment failed. Please try again.', 'error');
            }
        },

        showMessage: function(message, type) {
            // Remove existing messages
            $('.woocommerce-error, .woocommerce-message, .ipg-status-message').remove();

            // Create message element using WooCommerce classes for consistency
            const messageHtml = type === 'success' 
                ? `<div class="woocommerce-message">${message}</div>`
                : `<div class="woocommerce-error">${message}</div>`;
            
            // Add message to WooCommerce notices wrapper
            $('.woocommerce-notices-wrapper').first().html(messageHtml);

            // Scroll to message
            $('html, body').animate({
                scrollTop: $('.woocommerce-notices-wrapper').first().offset().top - 100
            }, 500);
        }
    };

    // Initialize on document ready
    $(document).ready(function() {
        NovaBankaIPG.init();
    });

})(jQuery);
</file>

<file path="includes/Core/class-novabankaipggateway.php">
<?php
/**
 * NovaBanka IPG Gateway Class
 *
 * @package NovaBankaIPG
 * @subpackage Core
 */

namespace NovaBankaIPG\Core;

use WC_Payment_Gateway;
use WC_Order;
use NovaBankaIPG\Services\PaymentService;
use NovaBankaIPG\Services\NotificationService;
use NovaBankaIPG\Exceptions\NovaBankaIPGException;

/**
 * Main gateway class for NovaBanka IPG integration.
 */
class NovaBankaIPGGateway extends WC_Payment_Gateway {
	/**
	 * Payment Service instance.
	 *
	 * @var PaymentService
	 */
	private $payment_service;

	/**
	 * Notification Service instance.
	 *
	 * @var NotificationService
	 */
	private $notification_service;

	/**
	 * Constructor.
	 *
	 * @param PaymentService      $payment_service      Payment Service instance.
	 * @param NotificationService $notification_service Notification Service instance.
	 */
	public function __construct(
		PaymentService $payment_service,
		NotificationService $notification_service
	) {
		$this->id                 = 'novabankaipg';
		$this->method_title       = __( 'NovaBanka IPG', 'novabanka-ipg-gateway' );
		$this->method_description = __( 'NovaBanka IPG payment gateway integration', 'novabanka-ipg-gateway' );

		// Initialize basic gateway settings.
		$this->init_form_fields();
		$this->init_settings();

		$this->payment_service      = $payment_service;
		$this->notification_service = $notification_service;

		// Set basic gateway properties.
		$this->title       = $this->get_option( 'title' );
		$this->description = $this->get_option( 'description' );
		$this->enabled     = $this->get_option( 'enabled' );

		// Add actions.
		add_action( 'woocommerce_update_options_payment_gateways_' . $this->id, array( $this, 'process_admin_options' ) );
		add_action( 'woocommerce_api_novabankaipg', array( $this, 'process_notification' ) );
	}

	/**
	 * Process payment.
	 *
	 * @param int $order_id Order ID.
	 * @return array|void
	 */
	public function process_payment( $order_id ) {
		try {
			return $this->payment_service->process_payment( $order_id, $this->get_payment_settings() );
		} catch ( \Exception $e ) {
			wc_add_notice( esc_html( $e->getMessage() ), 'error' );
			return;
		}
	}

	/**
	 * Process IPG notification.
	 *
	 * @throws NovaBankaIPGException When JSON payload is invalid.
	 */
	public function process_notification(): void {
		try {
			$raw_post          = file_get_contents( 'php://input' );
			$notification_data = json_decode( $raw_post, true );

			if ( JSON_ERROR_NONE !== json_last_error() ) {
				throw new NovaBankaIPGException( 'Invalid JSON payload' );
			}

			// Delegate all notification processing to NotificationService.
			$this->notification_service->handle_notification( $notification_data );

		} catch ( \Exception $e ) {
			wp_send_json_error(
				array(
					'message' => $e->getMessage(),
				),
				400
			);
		}
	}

	/**
	 * Get payment gateway settings.
	 *
	 * @return array
	 */
	private function get_payment_settings(): array {
		return array(
			'action'            => $this->get_option( 'action' ),
			'terminal_id'       => $this->get_option( 'terminal_id' ),
			'terminal_password' => $this->get_option( 'terminal_password' ),
			'payment_timeout'   => $this->get_option( 'payment_timeout' ),
			'payment_mode'      => $this->get_option( 'payment_mode' ),
		);
	}
}
</file>

<file path="includes/Exceptions/class-novabankaipgexception.php">
<?php
/**
 * Custom Exception Handler
 *
 * Handles custom exceptions for the NovaBanka IPG plugin with proper error codes,
 * messages, and data handling.
 *
 * @package NovaBankaIPG\Exceptions
 * @since 1.0.1
 */

namespace NovaBankaIPG\Exceptions;

use Exception;

/**
 * NovaBankaIPGException Class
 *
 * Custom exception class for handling IPG specific errors.
 */
class NovaBankaIPGException extends Exception {
	/**
	 * Error codes and their messages.
	 *
	 * @var array
	 */
	private const ERROR_CODES = array(
		// API Errors (1000-1999).
		'API_ERROR'             => array(
			'code'    => 1000,
			'message' => 'API communication error.',
		),
		'INVALID_RESPONSE'      => array(
			'code'    => 1001,
			'message' => 'Invalid response from gateway.',
		),
		'INVALID_SIGNATURE'     => array(
			'code'    => 1002,
			'message' => 'Invalid message signature.',
		),

		// Validation Errors (2000-2999).
		'INVALID_AMOUNT'        => array(
			'code'    => 2000,
			'message' => 'Invalid amount format or value.',
		),
		'INVALID_CURRENCY'      => array(
			'code'    => 2001,
			'message' => 'Unsupported currency.',
		),
		'MISSING_FIELD'         => array(
			'code'    => 2002,
			'message' => 'Required field missing.',
		),

		// Payment Errors (3000-3999).
		'PAYMENT_FAILED'        => array(
			'code'    => 3000,
			'message' => 'Payment failed.',
		),
		'PAYMENT_CANCELLED'     => array(
			'code'    => 3001,
			'message' => 'Payment cancelled by user.',
		),
		'3DS_ERROR'             => array(
			'code'    => 3002,
			'message' => '3D Secure authentication failed.',
		),

		// Order Errors (4000-4999).
		'ORDER_NOT_FOUND'       => array(
			'code'    => 4000,
			'message' => 'Order not found.',
		),
		'INVALID_ORDER_STATE'   => array(
			'code'    => 4001,
			'message' => 'Invalid order state.',
		),

		// Configuration Errors (5000-5999).
		'INVALID_CONFIGURATION' => array(
			'code'    => 5000,
			'message' => 'Invalid gateway configuration.',
		),
	);

	/**
	 * Additional error data.
	 *
	 * @var mixed
	 */
	private $error_data;

	/**
	 * Error type.
	 *
	 * @var string
	 */
	private $error_type;

	/**
	 * Constructor.
	 *
	 * @param string    $message    Error message.
	 * @param string    $error_type Error type from ERROR_CODES.
	 * @param mixed     $error_data Additional error data.
	 * @param Exception $previous   Previous exception.
	 */
	public function __construct(
		string $message = '',
		string $error_type = 'API_ERROR',
		mixed $error_data = null,
		Exception $previous = null
	) {
		$error_code      = self::ERROR_CODES[ $error_type ]['code'] ?? 1000;
		$default_message = self::ERROR_CODES[ $error_type ]['message'] ?? 'Unknown error.';

		parent::__construct(
			$message ? esc_html( $message ) : esc_html( $default_message ),
			$error_code,
			$previous
		);

		$this->error_type = $error_type;
		$this->error_data = $error_data;
	}

	/**
	 * Get error data.
	 *
	 * @return mixed Error data.
	 */
	public function get_error_data() {
		return $this->error_data;
	}

	/**
	 * Get error type.
	 *
	 * @return string Error type.
	 */
	public function get_error_type(): string {
		return $this->error_type;
	}

	/**
	 * Create API error exception.
	 *
	 * @param string $message Error message.
	 * @param mixed  $data    Error data.
	 * @return self
	 */
	public static function api_error( string $message = '', $data = null ): self {
		return new self( $message, 'API_ERROR', $data );
	}

	/**
	 * Create validation error exception.
	 *
	 * @param string $message Error message.
	 * @param mixed  $data    Error data.
	 * @return self
	 */
	public static function validation_error( string $message = '', $data = null ): self {
		return new self( $message, 'MISSING_FIELD', $data );
	}

	/**
	 * Create payment error exception.
	 *
	 * @param string $message Error message.
	 * @param mixed  $data    Error data.
	 * @return self
	 */
	public static function payment_error( string $message = '', $data = null ): self {
		return new self( $message, 'PAYMENT_FAILED', $data );
	}

	/**
	 * Create invalid signature exception.
	 *
	 * @param string $message Error message.
	 * @param mixed  $data    Additional error data.
	 * @return self
	 */
	public static function invalid_signature( string $message = '', $data = null ): self {
		return new self( $message, 'INVALID_SIGNATURE', $data );
	}

	/**
	 * Create order not found exception.
	 *
	 * @param string $message Error message.
	 * @param mixed  $data    Additional error data.
	 * @return self
	 */
	public static function order_not_found( string $message = '', $data = null ): self {
		return new self( $message, 'ORDER_NOT_FOUND', $data );
	}

	/**
	 * Create invalid configuration exception.
	 *
	 * @param string $message Error message.
	 * @param mixed  $data    Additional error data.
	 * @return self
	 */
	public static function invalid_configuration( string $message = '', $data = null ): self {
		return new self( $message, 'INVALID_CONFIGURATION', $data );
	}

	/**
	 * Get error details as array.
	 *
	 * @return array Error details.
	 */
	public function get_error_details(): array {
		return array(
			'type'    => $this->error_type,
			'code'    => $this->getCode(),
			'message' => $this->getMessage(),
			'data'    => $this->error_data,
		);
	}

	/**
	 * Get error message with code.
	 *
	 * @return string Formatted error message.
	 */
	public function get_error_message(): string {
		return sprintf(
			/* translators: 1: Error code, 2: Error message */
			esc_html__( '[Error %1$d] %2$s', 'novabanka-ipg-gateway' ),
			$this->getCode(),
			$this->getMessage()
		);
	}
}
</file>

<file path="includes/Services/class-notificationservice.php">
<?php
/**
 * Notification Service Class
 *
 * Handles payment notifications from the IPG gateway.
 *
 * @package NovaBankaIPG\Services
 * @since 1.0.1
 */

namespace NovaBankaIPG\Services;

use WC_Order;
use NovaBankaIPG\Utils\Logger;
use NovaBankaIPG\Utils\MessageHandler;
use NovaBankaIPG\Utils\SharedUtilities;
use NovaBankaIPG\Exceptions\NovaBankaIPGException;

/**
 * Handles payment notification processing.
 */
class NotificationService {
	/**
	 * Logger instance.
	 *
	 * @var Logger
	 */
	private $logger;

	/**
	 * Message Handler instance.
	 *
	 * @var MessageHandler
	 */
	private $message_handler;

	/**
	 * Payment Service instance.
	 *
	 * @var PaymentService
	 */
	private $payment_service;

	/**
	 * Constructor.
	 *
	 * @param Logger         $logger          Logger instance.
	 * @param MessageHandler $message_handler Message Handler instance.
	 * @param PaymentService $payment_service Payment Service instance.
	 */
	public function __construct(
		Logger $logger,
		MessageHandler $message_handler,
		PaymentService $payment_service
	) {
		$this->logger          = $logger;
		$this->message_handler = $message_handler;
		$this->payment_service = $payment_service;
	}

	/**
	 * Handle notification from IPG.
	 *
	 * @param array $notification_data Notification data from IPG.
	 * @return array Response data.
	 * @throws NovaBankaIPGException When notification processing fails.
	 */
	public function handle_notification( array $notification_data ): array {
		try {
			$this->logger->info(
				'Processing payment notification.',
				array( 'notification' => SharedUtilities::redact_sensitive_data( $notification_data ) )
			);

			SharedUtilities::validate_required_fields( $notification_data, array( 'paymentid', 'trackid', 'result' ) );
			$order  = $this->get_order( $notification_data );
			$result = $this->process_notification( $order, $notification_data );

			$this->logger->info(
				'Payment notification processed successfully.',
				array(
					'order_id' => $order->get_id(),
					'result'   => $result,
				)
			);

			return $result;

		} catch ( \Exception $e ) {
			$this->logger->log_error_and_throw(
				'Payment notification processing failed.',
				array(
					'error' => $e->getMessage(),
					'data'  => SharedUtilities::redact_sensitive_data( $notification_data ),
				)
			);
		}
	}

	/**
	 * Get order from notification data.
	 *
	 * @param array $notification_data Notification data.
	 * @return WC_Order Order object.
	 * @throws NovaBankaIPGException When order cannot be found.
	 */
	private function get_order( array $notification_data ): WC_Order {
		$order_id = absint( $notification_data['trackid'] );
		$order    = wc_get_order( $order_id );

		if ( ! $order ) {
			$this->logger->log_error_and_throw(
				sprintf(
					/* translators: %d: order ID */
					esc_html__( 'Order not found: %d', 'novabanka-ipg-gateway' ),
					$order_id
				),
				array( 'order_id' => $order_id ),
				'ORDER_NOT_FOUND'
			);
		}

		return $order;
	}

	/**
	 * Process notification for order.
	 *
	 * @param WC_Order $order            Order to process.
	 * @param array    $notification_data Notification data.
	 * @return array Response data.
	 */
	private function process_notification( WC_Order $order, array $notification_data ): array {
		$result = $notification_data['result'];

		if ( $this->payment_service->is_payment_successful( $result ) ) {
			$this->process_successful_payment( $order, $notification_data );
		} else {
			$this->process_failed_payment( $order, $notification_data );
		}

		/**
		 * Fires after payment notification is processed.
		 *
		 * @param WC_Order $order            The order object.
		 * @param array    $notification_data The notification data.
		 */
		do_action( 'novabankaipg_after_notification', $order, $notification_data );

		return array(
			'success'  => true,
			'order_id' => $order->get_id(),
			'result'   => $result,
		);
	}

	/**
	 * Process successful payment notification.
	 *
	 * @param WC_Order $order            Order object.
	 * @param array    $notification_data Notification data.
	 */
	private function process_successful_payment( WC_Order $order, array $notification_data ): void {
		$order->payment_complete( $notification_data['paymentid'] );
		$order->add_order_note(
			sprintf(
				/* translators: %s: payment ID */
				esc_html__( 'Payment completed successfully. Payment ID: %s', 'novabanka-ipg-gateway' ),
				esc_html( $notification_data['paymentid'] )
			)
		);
	}

	/**
	 * Process failed payment notification.
	 *
	 * @param WC_Order $order            Order object.
	 * @param array    $notification_data Notification data.
	 */
	private function process_failed_payment( WC_Order $order, array $notification_data ): void {
		$order->update_status( 'failed' );
		$order->add_order_note(
			sprintf(
				/* translators: 1: result code, 2: payment ID */
				esc_html__( 'Payment failed. Result: %1$s, Payment ID: %2$s', 'novabanka-ipg-gateway' ),
				esc_html( $notification_data['result'] ),
				esc_html( $notification_data['paymentid'] )
			)
		);
	}
}
</file>

<file path="includes/Services/class-paymentservice.php">
<?php
/**
 * Payment Service Class
 *
 * Handles payment processing operations for the NovaBanka IPG plugin.
 * Implements payment flow according to IPG integration guide.
 *
 * @package NovaBankaIPG\Services
 * @since 1.0.1
 */

namespace NovaBankaIPG\Services;

use WC_Order;
use NovaBankaIPG\Utils\APIHandler;
use NovaBankaIPG\Utils\Logger;
use NovaBankaIPG\Utils\MessageHandler;
use NovaBankaIPG\Utils\SharedUtilities;
use NovaBankaIPG\Exceptions\NovaBankaIPGException;

/**
 * Handles payment processing operations.
 */
class PaymentService {
	/**
	 * API Handler instance.
	 *
	 * @var APIHandler
	 */
	private $api_handler;

	/**
	 * Message Handler instance.
	 *
	 * @var MessageHandler
	 */
	private $message_handler;

	/**
	 * Logger instance.
	 *
	 * @var Logger
	 */
	private $logger;

	/**
	 * Supported currency codes mapping.
	 *
	 * @var array<string, string>
	 */
	private const CURRENCY_CODES = array(
		'EUR' => '978',
		'USD' => '840',
		'GBP' => '826',
		'BAM' => '977',
	);

	/**
	 * Constructor.
	 *
	 * @param APIHandler     $api_handler     API Handler instance.
	 * @param MessageHandler $message_handler Message Handler instance.
	 * @param Logger         $logger          Logger instance.
	 */
	public function __construct(
		APIHandler $api_handler,
		MessageHandler $message_handler,
		Logger $logger
	) {
		$this->api_handler     = $api_handler;
		$this->message_handler = $message_handler;
		$this->logger          = $logger;
	}

	/**
	 * Process payment for an order.
	 *
	 * @param int   $order_id Order ID.
	 * @param array $settings Gateway settings.
	 * @return array Payment processing result.
	 * @throws NovaBankaIPGException When payment processing fails.
	 */
	public function process_payment( int $order_id, array $settings ): array {
		$order        = $this->get_order( $order_id );
		$payment_data = $this->prepare_payment_data( $order, $settings );

		try {
			$response = $this->initiate_payment( $payment_data );
			return $this->handle_payment_response( $order, $response );
		} catch ( \Exception $e ) {
			$this->logger->log_error_and_throw(
				'Payment processing failed',
				array(
					'order_id' => $order_id,
					'error'    => $e->getMessage(),
				)
			);
		}
	}

	/**
	 * Check if payment status indicates success.
	 *
	 * @param string $status Payment status from IPG.
	 * @return bool
	 */
	public function is_payment_successful( string $status ): bool {
		return in_array( $status, array( 'CAPTURED', 'APPROVED' ), true );
	}

	/**
	 * Get order object.
	 *
	 * @param int $order_id Order ID.
	 * @return WC_Order
	 * @throws NovaBankaIPGException When order is invalid.
	 */
	private function get_order( int $order_id ): WC_Order {
		$order = wc_get_order( $order_id );
		if ( ! $order ) {
			$this->logger->log_error_and_throw(
				'Invalid order ID',
				array( 'order_id' => $order_id ),
				'ORDER_NOT_FOUND'
			);
		}
		return $order;
	}

	/**
	 * Prepare payment data for API request.
	 *
	 * @param WC_Order $order    Order object.
	 * @param array    $settings Gateway settings.
	 * @return array
	 * @throws NovaBankaIPGException When currency is not supported.
	 */
	private function prepare_payment_data( WC_Order $order, array $settings ): array {
		$currency = $order->get_currency();
		if ( ! isset( self::CURRENCY_CODES[ $currency ] ) ) {
			$this->logger->log_error_and_throw(
				sprintf( 'Unsupported currency: %s', $currency ),
				array( 'currency' => $currency ),
				'INVALID_CURRENCY'
			);
		}

		return array(
			'merchantid'   => $settings['merchant_id'],
			'password'     => $settings['merchant_password'],
			'amt'          => SharedUtilities::format_amount( $order->get_total() ),
			'currencycode' => self::CURRENCY_CODES[ $currency ],
			'trackid'      => $order->get_id(),
			'customerid'   => $order->get_customer_id(),
			'udf1'         => $order->get_billing_email(),
			'udf2'         => $order->get_billing_phone(),
			'udf3'         => wp_json_encode(
				array(
					'billing'  => $order->get_address( 'billing' ),
					'shipping' => $order->get_address( 'shipping' ),
				)
			),
		);
	}

	/**
	 * Initiate payment with IPG.
	 *
	 * @param array $payment_data Payment data.
	 * @return array
	 * @throws NovaBankaIPGException When API request fails.
	 */
	private function initiate_payment( array $payment_data ): array {
		$response = $this->api_handler->send_request( 'initiate_payment', $payment_data );

		if ( is_wp_error( $response ) ) {
			$this->logger->log_error_and_throw(
				'API request failed',
				array( 'error' => $response->get_error_message() ),
				'API_ERROR'
			);
		}

		return $this->validate_payment_response( $response );
	}

	/**
	 * Validate payment response from IPG.
	 *
	 * @param array $response API response data.
	 * @return array
	 * @throws NovaBankaIPGException When response is invalid.
	 */
	private function validate_payment_response( array $response ): array {
		if ( empty( $response['browserRedirectionURL'] ) ) {
			$this->logger->log_error_and_throw(
				'Missing redirect URL in response',
				array( 'response' => $response ),
				'INVALID_RESPONSE'
			);
		}

		return $response;
	}

	/**
	 * Handle payment response.
	 *
	 * @param WC_Order $order    Order object.
	 * @param array    $response Payment response data.
	 * @return array
	 */
	private function handle_payment_response( WC_Order $order, array $response ): array {
		if ( ! empty( $response['paymentid'] ) ) {
			$order->update_meta_data( '_novabanka_payment_id', sanitize_text_field( $response['paymentid'] ) );
			$order->save();
		}

		return array(
			'result'   => 'success',
			'redirect' => $response['browserRedirectionURL'],
		);
	}
}
</file>

<file path="includes/Utils/class-apihandler.php">
<?php
/**
 * API Handler Class
 *
 * Handles HTTP communication with the NovaBanka IPG API.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */

namespace NovaBankaIPG\Utils;

use NovaBankaIPG\Exceptions\NovaBankaIPGException;
use WP_Error;

/**
 * Class APIHandler
 *
 * Handles HTTP communication with the NovaBanka IPG API.
 * Makes API requests and handles basic response validation.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */
class APIHandler {
	/**
	 * API endpoint URL.
	 *
	 * @var string
	 */
	private string $api_endpoint;

	/**
	 * Logger instance.
	 *
	 * @var Logger
	 */
	private Logger $logger;

	/**
	 * Success HTTP status codes.
	 *
	 * @var array
	 */
	private const SUCCESS_STATUS_CODES = array(
		200, // OK.
		201, // Created.
		202, // Accepted.
	);

	/**
	 * Constructor.
	 *
	 * @param string $api_endpoint API endpoint URL.
	 * @param Logger $logger Logger instance.
	 */
	public function __construct( string $api_endpoint, Logger $logger ) {
		$this->api_endpoint = $api_endpoint;
		$this->logger       = $logger;
	}

	/**
	 * Send a POST request to the API.
	 *
	 * @param string $endpoint API endpoint path.
	 * @param array  $data Request data.
	 * @param int    $timeout Request timeout in seconds.
	 * @return array Response data.
	 * @throws NovaBankaIPGException If request fails.
	 */
	public function send_request( string $endpoint, array $data, int $timeout = 30 ): array {
		$url = $this->get_api_url( $endpoint );

		$this->logger->debug(
			'Sending API request',
			array(
				'endpoint' => $endpoint,
				'data'     => $data,
			)
		);

		$response = wp_remote_post(
			$url,
			array(
				'headers' => $this->get_request_headers(),
				'body'    => wp_json_encode( $data ),
				'timeout' => $timeout,
			)
		);

		if ( is_wp_error( $response ) ) {
			$this->handle_request_error( $response );
		}

		return $this->parse_response( $response );
	}

	/**
	 * Send a GET request to the API.
	 *
	 * @param string $endpoint API endpoint path.
	 * @param array  $params Query parameters.
	 * @return array Response data.
	 * @throws NovaBankaIPGException If request fails.
	 */
	public function get_request( string $endpoint, array $params = array() ): array {
		$url = $this->get_api_url( $endpoint );
		if ( ! empty( $params ) ) {
			$url = add_query_arg( $params, $url );
		}

		$response = wp_remote_get(
			$url,
			array(
				'headers' => $this->get_request_headers(),
				'timeout' => 30,
			)
		);

		if ( is_wp_error( $response ) ) {
			$this->handle_request_error( $response );
		}

		return $this->parse_response( $response );
	}

	/**
	 * Get request headers.
	 *
	 * @return array Request headers.
	 */
	private function get_request_headers(): array {
		return array(
			'Content-Type'  => 'application/json',
			'Accept'        => 'application/json',
			'Cache-Control' => 'no-cache',
		);
	}

	/**
	 * Get full API URL.
	 *
	 * @param string $endpoint API endpoint path.
	 * @return string Full API URL.
	 */
	private function get_api_url( string $endpoint ): string {
		return rtrim( $this->api_endpoint, '/' ) . '/' . ltrim( $endpoint, '/' );
	}

	/**
	 * Handle request error.
	 *
	 * @param WP_Error $error WordPress error object.
	 * @throws NovaBankaIPGException Always throws exception with error details.
	 */
	private function handle_request_error( WP_Error $error ): void {
		$this->logger->error(
			'API request failed',
			array(
				'error_message' => $error->get_error_message(),
				'error_code'    => $error->get_error_code(),
			)
		);

		throw new NovaBankaIPGException(
			'API_ERROR',
			sprintf( 'API request failed: %s', esc_html( $error->get_error_message() ) )
		);
	}

	/**
	 * Parse API response.
	 *
	 * @param array $response WordPress response array.
	 * @return array Parsed response data.
	 * @throws NovaBankaIPGException If response is invalid.
	 */
	private function parse_response( array $response ): array {
		$body = wp_remote_retrieve_body( $response );
		$data = json_decode( $body, true );

		if ( JSON_ERROR_NONE !== json_last_error() ) {
			$this->logger->error(
				'Invalid JSON response',
				array(
					'response'   => $body,
					'json_error' => json_last_error_msg(),
				)
			);

			throw new NovaBankaIPGException(
				'INVALID_RESPONSE',
				'Invalid JSON response from API'
			);
		}

		$this->logger->debug(
			'API response received',
			array(
				'response' => $data,
			)
		);

		return $data;
	}

	/**
	 * Check if HTTP status code indicates success.
	 *
	 * @param int $status_code HTTP status code.
	 * @return bool
	 */
	private function is_success_status( int $status_code ): bool {
		return in_array( $status_code, self::SUCCESS_STATUS_CODES, true );
	}
}
</file>

<file path="includes/Utils/class-config.php">
<?php
/**
 * Config Class
 *
 * Manages configuration settings for the NovaBanka IPG plugin.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */

namespace NovaBankaIPG\Utils;

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Class Config
 */
class Config {
	/**
	 * Plugin settings
	 *
	 * @var array
	 */
	private array $settings;

	/**
	 * Required gateway settings
	 */
	private const REQUIRED_SETTINGS = array(
		'terminal_id' => array(
			'title'    => 'Terminal ID',
			'type'     => 'text',
			'required' => true,
			'default'  => '89110001',
		),
		'password'    => array(
			'title'    => 'Password',
			'type'     => 'password',
			'required' => true,
			'default'  => 'test1234',
		),
		'secret_key'  => array(
			'title'    => 'Secret Key',
			'type'     => 'password',
			'required' => true,
			'default'  => 'YXKZPOQ9RRLGPDED5D3PC5BJ',
		),
		'ipg_url'     => array(
			'title'    => 'IPG URL',
			'type'     => 'text',
			'required' => true,
			'default'  => 'https://ipgtest.novabanka.com/IPGWeb/servlet/',
		),
	);

	/**
	 * Optional gateway settings
	 */
	private const OPTIONAL_SETTINGS = array(
		'enabled'             => array(
			'title'   => 'Enable/Disable',
			'type'    => 'checkbox',
			'label'   => 'Enable NovaBanka IPG Payment',
			'default' => 'no',
		),
		'title'               => array(
			'title'       => 'Title',
			'type'        => 'text',
			'description' => 'This controls the title which the user sees during checkout.',
			'default'     => 'Credit Card',
		),
		'description'         => array(
			'title'       => 'Description',
			'type'        => 'textarea',
			'description' => 'This controls the description which the user sees during checkout.',
			'default'     => 'Pay securely using your credit card.',
		),
		'message_type'        => array(
			'title'   => 'Message Type',
			'type'    => 'select',
			'options' => array(
				'VISEC' => 'VISEC / VIREC first transaction',
			),
			'default' => 'VISEC',
		),
		'message_version'     => array(
			'title'   => 'Message Version',
			'type'    => 'select',
			'options' => array( '1' => '1' ),
			'default' => '1',
		),
		'action'              => array(
			'title'   => 'Action',
			'type'    => 'select',
			'options' => array(
				'1' => 'PURCHASE',
				'4' => 'AUTHORIZATION',
			),
			'default' => '1',
		),
		'notification_format' => array(
			'title'   => 'Notification Format',
			'type'    => 'select',
			'options' => array( 'json' => 'JSON' ),
			'default' => 'json',
		),
		'payment_page_mode'   => array(
			'title'   => 'Payment Page Mode',
			'type'    => 'select',
			'options' => array( '0' => 'STANDARD' ),
			'default' => '0',
		),
		'language'            => array(
			'title'   => 'Language',
			'type'    => 'text',
			'default' => 'USA',
		),
		'card_sha2'           => array(
			'title'   => 'Card SHA2',
			'type'    => 'select',
			'options' => array(
				'Y' => 'Yes',
				'N' => 'No',
			),
			'default' => 'Y',
		),
		'payment_timeout'     => array(
			'title'   => 'Payment Timeout',
			'type'    => 'text',
			'default' => '30',
		),
	);

	/**
	 * Constructor
	 *
	 * @param array $settings Plugin settings
	 */
	public function __construct( array $settings ) {
		$this->settings = $settings;
	}

	/**
	 * Get all settings
	 *
	 * @return array
	 */
	public function get_all_settings(): array {
		return $this->settings;
	}

	/**
	 * Get setting value
	 *
	 * @param string $key Setting key
	 * @param mixed  $default Default value
	 * @return mixed
	 */
	public function get_setting( string $key, $default = null ) {
		return $this->settings[ $key ] ?? $default;
	}

	/**
	 * Get API credentials
	 *
	 * @return array
	 */
	public function get_api_credentials(): array {
		return array(
			'terminal_id' => $this->get_setting( 'terminal_id' ),
			'password'    => $this->get_setting( 'password' ),
			'secret_key'  => $this->get_setting( 'secret_key' ),
		);
	}

	/**
	 * Get API endpoint
	 *
	 * @return string
	 */
	public function get_api_endpoint(): string {
		return $this->get_setting( 'ipg_url' );
	}

	/**
	 * Get notification URL
	 *
	 * @return string
	 */
	public function get_notification_url(): string {
		return add_query_arg( 'wc-api', 'novabankaipg', home_url( '/' ) );
	}

	/**
	 * Get error URL
	 *
	 * @return string
	 */
	public function get_error_url(): string {
		return add_query_arg( 'wc-api', 'novabankaipg_error', home_url( '/' ) );
	}

	/**
	 * Validate configuration
	 *
	 * @return bool
	 */
	public function validate_config(): bool {
		foreach ( self::REQUIRED_SETTINGS as $key => $setting ) {
			if ( $setting['required'] && empty( $this->get_setting( $key ) ) ) {
				return false;
			}
		}
		return true;
	}

	/**
	 * Get form fields for WooCommerce settings
	 *
	 * @return array
	 */
	public function get_form_fields(): array {
		return array_merge( self::REQUIRED_SETTINGS, self::OPTIONAL_SETTINGS );
	}

	/**
	 * Get sensitive fields that should be redacted in logs
	 *
	 * @return array
	 */
	public static function get_sensitive_fields(): array {
		return array( 'password', 'secret_key' );
	}
}
</file>

<file path="includes/Utils/class-logger.php">
<?php
/**
 * Logger Utility Class
 *
 * Handles logging operations for the NovaBanka IPG plugin using WooCommerce's logging system.
 * Provides methods for different log levels and handles sensitive data redaction.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */

namespace NovaBankaIPG\Utils;

use WC_Logger;

/**
 * Logger Class
 *
 * Handles logging operations for the NovaBanka IPG plugin.
 */
class Logger {
	/**
	 * WooCommerce Logger instance.
	 *
	 * @var WC_Logger
	 */
	private $wc_logger;

	/**
	 * Source identifier for log entries.
	 *
	 * @var string
	 */
	private const LOG_SOURCE = 'novabanka-ipg';

	/**
	 * Constructor.
	 */
	public function __construct() {
		$this->wc_logger = wc_get_logger();
	}

	/**
	 * Log debug message.
	 *
	 * @param string $message Message to log.
	 * @param array  $context Additional context data.
	 */
	public function debug( string $message, array $context = array() ): void {
		if ( ! Config::is_debug_mode() ) {
			return;
		}

		/**
		 * Filter debug message before logging.
		 *
		 * @since 1.0.1
		 * @param string $message The message to log.
		 * @param array  $context The context data.
		 */
		$message = apply_filters( 'novabankaipg_debug_message', $message, $context );

		$this->log( 'debug', $message, $context );
	}

	/**
	 * Log info message.
	 *
	 * @param string $message Message to log.
	 * @param array  $context Additional context data.
	 */
	public function info( string $message, array $context = array() ): void {
		/**
		 * Filter info message before logging.
		 *
		 * @since 1.0.1
		 * @param string $message The message to log.
		 * @param array  $context The context data.
		 */
		$message = apply_filters( 'novabankaipg_info_message', $message, $context );

		$this->log( 'info', $message, $context );
	}

	/**
	 * Log error message.
	 *
	 * @param string $message Message to log.
	 * @param array  $context Additional context data.
	 */
	public function error( string $message, array $context = array() ): void {
		/**
		 * Filter error message before logging.
		 *
		 * @since 1.0.1
		 * @param string $message The message to log.
		 * @param array  $context The context data.
		 */
		$message = apply_filters( 'novabankaipg_error_message', $message, $context );

		$this->log( 'error', $message, $context );

		/**
		 * Action after logging an error.
		 *
		 * @since 1.0.1
		 * @param string $message The logged message.
		 * @param array  $context The context data.
		 */
		do_action( 'novabankaipg_after_error_log', $message, $context );
	}

	/**
	 * Log warning message.
	 *
	 * @param string $message Message to log.
	 * @param array  $context Additional context data.
	 */
	public function warning( string $message, array $context = array() ): void {
		/**
		 * Filter warning message before logging.
		 *
		 * @since 1.0.1
		 * @param string $message The message to log.
		 * @param array  $context The context data.
		 */
		$message = apply_filters( 'novabankaipg_warning_message', $message, $context );

		$this->log( 'warning', $message, $context );
	}

	/**
	 * Internal logging method.
	 *
	 * @param string $level   Log level.
	 * @param string $message Message to log.
	 * @param array  $context Additional context data.
	 */
	private function log( string $level, string $message, array $context = array() ): void {
		if ( ! $this->wc_logger ) {
			return;
		}

		$message = sanitize_text_field( $message );
		$context = SharedUtilities::redact_sensitive_data( $context );

		$log_entry = $this->format_message( $message, $context );

		$log_entry = apply_filters( 'novabankaipg_log_entry', $log_entry, $level, $message, $context );

		$this->wc_logger->{$level}(
			$log_entry,
			array(
				'source' => self::LOG_SOURCE,
			)
		);

		do_action( 'novabankaipg_after_log', $level, $message, $context, $log_entry );
	}

	/**
	 * Format log message with context.
	 *
	 * @param string $message Message to format.
	 * @param array  $context Context data.
	 * @return string Formatted message.
	 */
	private function format_message( string $message, array $context ): string {
		$context_string = empty( $context ) ? '' : ' | Context: ' . wp_json_encode( $context );

		return sprintf(
			'[%s] %s%s',
			wp_date( 'Y-m-d H:i:s' ),
			$message,
			$context_string
		);
	}

	/**
	 * Log error and throw exception.
	 *
	 * @param string $message    Error message.
	 * @param array  $context    Error context.
	 * @param string $error_type Error type for exception.
	 * @throws NovaBankaIPGException
	 */
	public function log_error_and_throw(
		string $message,
		array $context = array(),
		string $error_type = 'API_ERROR'
	): void {
		$this->error( $message, $context );
		throw new NovaBankaIPGException( $message, $error_type );
	}
}
</file>

<file path="includes/Utils/class-messagehandler.php">
<?php
/**
 * Message Handler Class
 *
 * Handles message verification and signature generation for IPG communication.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */

namespace NovaBankaIPG\Utils;

use NovaBankaIPG\Exceptions\NovaBankaIPGException;

/**
 * Handles message verification and signature generation.
 */
class MessageHandler {

	/**
	 * Terminal ID.
	 *
	 * @var string
	 */
	private $terminal_id;

	/**
	 * Terminal password.
	 *
	 * @var string
	 */
	private $terminal_password;

	/**
	 * Secret key.
	 *
	 * @var string
	 */
	private $secret_key;

	/**
	 * Data Handler instance.
	 *
	 * @var DataHandler
	 */
	private $data_handler;

	/**
	 * Logger instance.
	 *
	 * @var Logger
	 */
	private $logger;

	/**
	 * Constructor.
	 *
	 * @param string      $terminal_id      Terminal ID.
	 * @param string      $terminal_password Terminal password.
	 * @param string      $secret_key       Secret key.
	 * @param DataHandler $data_handler     Data Handler instance.
	 * @param Logger      $logger           Logger instance.
	 */
	public function __construct(
		string $terminal_id,
		string $terminal_password,
		string $secret_key,
		DataHandler $data_handler,
		Logger $logger
	) {
		$this->terminal_id       = $terminal_id;
		$this->terminal_password = $terminal_password;
		$this->secret_key        = $secret_key;
		$this->data_handler      = $data_handler;
		$this->logger            = $logger;
	}

	/**
	 * Generate message verifier for IPG requests.
	 *
	 * @param string $msg_name Message name.
	 * @param string $version  Version.
	 * @param string $id       Terminal ID.
	 * @param string $password Terminal password.
	 * @param string $amount   Transaction amount.
	 * @param string $track_id Track ID.
	 * @return string Generated message verifier.
	 */
	public function generate_message_verifier(
		string $msg_name,
		string $version,
		string $id,
		string $password,
		string $amount,
		string $track_id
	): string {
		// Build message verifier base string.
		$verifier_base = $msg_name . $version . $id . $password . $amount . $track_id . '' . $this->secret_key . '';

		// Generate SHA-256 hash.
		$hash = hash( 'sha256', $verifier_base );

		// Convert to binary.
		$hash_bytes = hex2bin( $hash );

		// Convert to base64.
		$verifier = base64_encode( $hash_bytes );

		$this->logger->debug(
			'Generated message verifier.',
			array(
				'msg_name' => $msg_name,
				'track_id' => $track_id,
				'verifier' => $verifier,
			)
		);

		return $verifier;
	}

	/**
	 * Verify notification signature.
	 *
	 * @param array $notification_data Notification data to verify.
	 * @return bool True if signature is valid.
	 */
	public function verify_notification_signature( array $notification_data ): bool {
		if ( ! isset( $notification_data['msgVerifier'] ) ) {
			return false;
		}

		// Build verification string.
		$verifier_base = $notification_data['msgName'] .
			$notification_data['version'] .
			$notification_data['paymentid'] .
			$this->secret_key .
			( $notification_data['browserRedirectionURL'] ?? '' );

		// Generate SHA-256 hash.
		$hash = hash( 'sha256', $verifier_base );

		// Convert to binary.
		$hash_bytes = hex2bin( $hash );

		// Convert to base64.
		$expected_verifier = base64_encode( $hash_bytes );

		$is_valid = hash_equals( $expected_verifier, $notification_data['msgVerifier'] );

		$this->logger->debug(
			'Verified notification signature.',
			array(
				'payment_id' => $notification_data['paymentid'] ?? 'unknown',
				'is_valid'   => $is_valid,
			)
		);

		return $is_valid;
	}
}
</file>

<file path="includes/Utils/class-sharedutilities.php">
<?php
/**
 * Utility Class for Shared Functions
 *
 * This class is responsible for housing shared utility functions used across various components.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */

namespace NovaBankaIPG\Utils;

use NovaBankaIPG\Exceptions\NovaBankaIPGException;

/**
 * SharedUtilities Class
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */
class SharedUtilities {

	/**
	 * Get the API endpoint URL based on test mode setting.
	 *
	 * @param string $path Path to append to the API endpoint URL.
	 * @return string The API endpoint URL with the appended path.
	 */
	public static function get_api_endpoint( string $path ): string {
		$base_url = Config::is_test_mode()
			? Config::get_setting( 'test_api_endpoint' )
			: Config::get_setting( 'live_api_endpoint' );

		return rtrim( $base_url, '/' ) . '/' . ltrim( $path, '/' );
	}

	/**
	 * Format amount according to IPG requirements.
	 *
	 * @param float|string $amount Amount to format.
	 * @return string Formatted amount.
	 * @throws NovaBankaIPGException If amount is invalid.
	 */
	public static function format_amount( $amount ): string {
		if ( ! is_numeric( $amount ) ) {
			throw new NovaBankaIPGException( 'Invalid amount format' );
		}
		return number_format( (float) $amount, 2, '.', '' );
	}

	/**
	 * Generate message verifier for IPG requests.
	 *
	 * Example from logs:
	 * Input: PaymentInitRequest189110001test12341.00113YXKZPOQ9RRLGPDED5D3PC5BJ.
	 * Output: Base64(SHA-256()).
	 *
	 * @param string $msg_name Message name (e.g., 'PaymentInitRequest').
	 * @param string $version Version number.
	 * @param string $terminal_id Terminal ID.
	 * @param string $password Terminal password.
	 * @param string $amount Transaction amount.
	 * @param string $trackid Order tracking ID.
	 * @param string $udf1 User defined field 1.
	 * @param string $secret_key Secret key.
	 * @param string $udf5 User defined field 5.
	 * @return string
	 */
	public static function generate_message_verifier(
		string $msg_name,
		string $version,
		string $terminal_id,
		string $password,
		string $amount,
		string $trackid,
		string $udf1 = '',
		string $secret_key = '',
		string $udf5 = ''
	): string {
		// Create message string exactly as IPG expects.
		$message = $msg_name .
					$version .
					$terminal_id .
					$password .
					self::format_amount( $amount ) . // Use our format_amount method.
					$trackid .
					$udf1 .
					$secret_key .
					$udf5;

		// Remove any whitespace.
		$message = preg_replace( '/\s+/', '', $message );

		// Debug logging matching the example format.
		Logger::debug(
			'Message Verifier Base loaded',
			array(
				'messageVerifierBase'        => $message,
				'messageVerifierBase.length' => strlen( $message ),
			)
		);

		// Generate SHA-256 hash and encode in base64.
		$hash   = hash( 'sha256', $message, true );
		$base64 = base64_encode( $hash );

		// Debug logging matching example format.
		Logger::debug(
			'REST client message verifier',
			array(
				'SHA256(messageVerifierBase)' => strtoupper( bin2hex( $hash ) ),
				'msgVerifier'                 => $base64,
			)
		);

		return $base64;
	}

	/**
	 * Validate required fields.
	 *
	 * @param array $data Data to validate.
	 * @param array $fields Required field names.
	 * @throws NovaBankaIPGException If a required field is missing.
	 */
	public static function validate_required_fields( array $data, array $fields ): void {
		foreach ( $fields as $field ) {
			if ( empty( $data[ $field ] ) ) {
				throw new NovaBankaIPGException( esc_html( "Missing required field: {$field}" ) );
			}
		}
	}

	/**
	 * Add buyer information to request.
	 *
	 * @param array $request Request array to modify.
	 * @param array $data Source data.
	 */
	public static function add_buyer_information( array &$request, array $data ): void {
		$buyer_fields = array(
			'buyerFirstName'    => 50,
			'buyerLastName'     => 50,
			'buyerPhoneNumber'  => 20,
			'buyerEmailAddress' => 255,
			'buyerUserId'       => 50,
		);

		foreach ( $buyer_fields as $field => $max_length ) {
			if ( ! empty( $data[ $field ] ) ) {
				$request[ $field ] = substr( sanitize_text_field( $data[ $field ] ), 0, $max_length );
			}
		}
	}

	/**
	 * Add UDF fields to request.
	 *
	 * @param array $request Request array to modify.
	 * @param array $data Source data.
	 */
	public static function add_udf_fields( array &$request, array $data ): void {
		for ( $i = 1; $i <= 5; $i++ ) {
			$field = "udf{$i}";
			if ( isset( $data[ $field ] ) ) {
				$request[ $field ] = DataHandler::format_udf( $data[ $field ] );
			}
		}
	}

	/**
	 * Parse transaction rows from response.
	 *
	 * @param array $rows Transaction rows.
	 * @return array Processed transaction data.
	 */
	public static function parse_transaction_rows( array $rows ): array {
		$transactions = array();

		foreach ( $rows as $row ) {
			$transaction = array(
				'action'         => $row['action'],
				'transaction_id' => $row['tranid'],
				'timestamp'      => $row['msgDateTime'],
				'amount'         => $row['amt'],
				'result'         => $row['result'],
				'auth_code'      => $row['auth'] ?? null,
				'card_type'      => $row['cardtype'] ?? null,
				'response_code'  => $row['responsecode'] ?? null,
				'reference'      => $row['ref'] ?? null,
			);

			// Add UDF fields if present.
			for ( $i = 1; $i <= 5; $i++ ) {
				$udf = "udf{$i}";
				if ( ! empty( $row[ $udf ] ) ) {
					$transaction['udf'][ $udf ] = $row[ $udf ];
				}
			}

			$transactions[] = $transaction;
		}

		return $transactions;
	}

	/**
	 * Get human-readable status description.
	 *
	 * @param string $status Status code from response.
	 * @return string
	 */
	public static function get_status_description( string $status ): string {
		$statuses = array(
			'INITIALIZED' => 'Payment initialized but not yet displayed to customer',
			'PRESENTED'   => 'Payment page presented but process not completed',
			'PROCESSED'   => 'Payment has been processed completely',
			'TIMEOUT'     => 'Payment expired due to timeout',
		);

		return $statuses[ $status ] ?? $status;
	}

	/**
	 * Field lengths for various data types.
	 *
	 * @var array
	 */
	public const FIELD_LENGTHS = array(
		'phone'    => 20,
		'email'    => 255,
		'name'     => 50,
		'address1' => 100,
		'address2' => 100,
		'address3' => 40,
		'city'     => 40,
		'zip'      => 20,
	);

	/**
	 * Format a field according to its type.
	 *
	 * @param string $value The value to format.
	 * @param string $field_type The type of field to format.
	 * @return string The formatted value.
	 * @throws NovaBankaIPGException If the field type is invalid.
	 */
	public static function format_field( string $value, string $field_type ): string {
		if ( ! isset( self::FIELD_LENGTHS[ $field_type ] ) ) {
			throw new NovaBankaIPGException(
				sprintf(
					/* translators: %s: field type that was invalid */
					esc_html__( 'Invalid field type: %s', 'novabanka-ipg-gateway' ),
					esc_html( $field_type )
				)
			);
		}

		return substr( sanitize_text_field( $value ), 0, self::FIELD_LENGTHS[ $field_type ] );
	}

	/**
	 * Redact sensitive data.
	 *
	 * @param array $data Data to redact.
	 * @return array Redacted data.
	 */
	public static function redact_sensitive_data( array $data ): array {
		$sensitive_fields = array( 'password', 'terminal_password', 'secret_key' );

		foreach ( $sensitive_fields as $field ) {
			if ( isset( $data[ $field ] ) ) {
				$data[ $field ] = '***REDACTED***';
			}
		}

		return $data;
	}
}
</file>

<file path="includes/Utils/class-threedshandler.php">
<?php
/**
 * ThreeDSHandler Class
 *
 * This class is responsible for handling 3D Secure (3DS) authentication for NovaBanka IPG.
 * It manages the process of initiating and verifying 3D Secure authentication during payments.
 *
 * @package NovaBankaIPG\Services
 * @since 1.0.1
 */

namespace NovaBankaIPG\Utils;

use NovaBankaIPG\Utils\APIHandler;
use NovaBankaIPG\Utils\Logger;
use NovaBankaIPG\Utils\Config;
use NovaBankaIPG\Utils\SharedUtilities;
use NovaBankaIPG\Exceptions\NovaBankaIPGException;
use WC_Order;
use Exception;

/**
 * Class ThreeDSHandler
 *
 * Handles 3D Secure (3DS) authentication flow for NovaBanka IPG payments.
 * Manages initiation and verification of 3DS authentication process.
 *
 * @package NovaBankaIPG\Utils
 * @since 1.0.1
 */
class ThreeDSHandler {

	/**
	 * API Handler instance.
	 *
	 * @var APIHandler
	 */
	private $api_handler;

	/**
	 * Logger instance.
	 *
	 * @var Logger
	 */
	private $logger;

	/**
	 * Constructor for the ThreeDSHandler class.
	 *
	 * @param APIHandler $api_handler API handler instance.
	 * @param Logger     $logger      Logger instance.
	 */
	public function __construct( APIHandler $api_handler, Logger $logger ) {
		$this->api_handler = $api_handler;
		$this->logger      = $logger;
	}

	/**
	 * Initiate 3D Secure authentication.
	 *
	 * @param WC_Order $order The order to initiate 3D Secure for.
	 * @param array    $auth_data The authentication data to be sent to IPG.
	 * @return array The response from the IPG.
	 * @throws NovaBankaIPGException When the 3D Secure initiation fails.
	 */
	public function initiate_3ds( WC_Order $order, array $auth_data ): array {
		try {
			// Prepare the 3DS request data.
			$auth_data = $this->prepare_auth_data( $order, $auth_data );

			// Log the initiation request if in debug mode.
			if ( Config::get_setting( 'debug', false ) ) {
				$this->logger->debug( 'Initiating 3D Secure authentication', array( 'auth_data' => $auth_data ) );
			}

			// Send the 3DS initiation request to the IPG.
			$response = $this->api_handler->send_3ds_initiation( $auth_data );

			// Handle the response from IPG.
			if ( 'PENDING_AUTH' !== $response['status'] ) {
				throw NovaBankaIPGException::threeDSInitiationFailed( '3D Secure initiation failed.', $response );
			}
			$this->logger->info(
				'3D Secure initiation successful.',
				array(
					'order_id' => $order->get_id(),
					'response' => $response,
				)
			);
			return $response;
		} catch ( NovaBankaIPGException $e ) {
			$this->logger->error(
				'3D Secure initiation failed.',
				array(
					'order_id' => $order->get_id(),
					'error'    => $e->getMessage(),
				)
			);
			throw $e;
		} catch ( Exception $e ) {
			$this->logger->error(
				'3D Secure initiation failed due to an unexpected error.',
				array(
					'order_id' => $order->get_id(),
					'error'    => $e->getMessage(),
				)
			);
			throw new NovaBankaIPGException( '3D Secure initiation failed: ' . esc_html( $e->getMessage() ) );
		}
	}

	/**
	 * Verify 3D Secure authentication.
	 *
	 * @param WC_Order $order The order to verify 3D Secure for.
	 * @param array    $verification_data The verification data returned from IPG.
	 * @return array The response from the IPG.
	 * @throws NovaBankaIPGException When the 3D Secure verification fails.
	 */
	public function verify_3ds( WC_Order $order, array $verification_data ): array {
		try {
			// Prepare verification data.
			$verification_data = $this->prepare_verification_data( $order, $verification_data );

			// Log verification data if in debug mode.
			if ( Config::get_setting( 'debug', false ) ) {
				$this->logger->debug( 'Verifying 3D Secure authentication', array( 'verification_data' => $verification_data ) );
			}

			// Send the verification request to the IPG.
			$response = $this->api_handler->verify_3ds_authentication( $verification_data );

			// Handle the response from IPG.
			if ( 'AUTHENTICATED' === $response['status'] ) {
				$this->logger->info(
					'3D Secure authentication verified successfully.',
					array(
						'order_id' => $order->get_id(),
						'response' => $response,
					)
				);
				return $response;
			} else {
				throw NovaBankaIPGException::paymentError( '3D Secure verification failed.', $response );
			}
		} catch ( NovaBankaIPGException $e ) {
			$this->logger->error(
				'3D Secure verification failed.',
				array(
					'order_id' => $order->get_id(),
					'error'    => $e->getMessage(),
				)
			);
			throw $e;
		} catch ( Exception $e ) {
			$this->logger->error(
				'3D Secure verification failed due to an unexpected error.',
				array(
					'order_id' => $order->get_id(),
					'error'    => $e->getMessage(),
				)
			);
			throw new NovaBankaIPGException( '3D Secure verification failed: ' . esc_html( $e->getMessage() ) );
		}
	}

	/**
	 * Check if 3D Secure is required for the transaction.
	 *
	 * @param array $transaction_data The data associated with the current transaction.
	 * @return bool True if 3D Secure is required, false otherwise.
	 */
	public static function is_3ds_required( array $transaction_data ): bool {
		return isset( $transaction_data['threeDSRequired'] ) &&
				true === $transaction_data['threeDSRequired'];
	}

	/**
	 * Generate the URL for 3D Secure authentication.
	 *
	 * @param array $transaction_data The data associated with the current transaction.
	 * @return string The URL for 3D Secure authentication.
	 * @throws NovaBankaIPGException If 3DS URL is missing or invalid.
	 */
	public static function generate_3ds_url( array $transaction_data ): string {
		if ( empty( $transaction_data['threeDSURL'] ) ) {
			throw new NovaBankaIPGException( '3D Secure URL is missing from the transaction data.' );
		}
		return $transaction_data['threeDSURL'];
	}

	/**
	 * Handle the response from the 3D Secure process.
	 *
	 * @param array $response_data The response data from the 3D Secure authentication process.
	 * @return bool True if the 3DS authentication was successful, false otherwise.
	 * @throws NovaBankaIPGException If the response data is invalid or indicates a failure.
	 */
	public static function handle_3ds_response( array $response_data ): bool {
		if ( empty( $response_data['status'] ) || 'AUTHENTICATED' !== $response_data['status'] ) {
			throw new NovaBankaIPGException( '3D Secure authentication failed or returned an invalid status.' );
		}
		return true;
	}

	/**
	 * Verify the authentication response signature for added security.
	 *
	 * @param array  $response_data The response data from the 3DS.
	 * @param string $signature The expected signature for validation.
	 * @return bool True if the signature is valid, false otherwise.
	 */
	public static function verify_3ds_signature( array $response_data, string $signature ): bool {
		$calculated_signature = hash( 'sha256', json_encode( $response_data ) . Config::get_setting( 'secret_key' ) );
		return hash_equals( $calculated_signature, $signature );
	}

	/**
	 * Prepare authentication data for 3D Secure initiation.
	 *
	 * @param WC_Order $order The order to prepare authentication data for.
	 * @param array    $auth_data The initial authentication data.
	 * @return array The prepared authentication data.
	 */
	private function prepare_auth_data( WC_Order $order, array $auth_data ): array {
		$auth_data['order_id'] = $order->get_id();
		$auth_data['amount']   = $order->get_total();
		$auth_data['currency'] = $order->get_currency();
		return $auth_data;
	}

	/**
	 * Prepare verification data for 3D Secure verification.
	 *
	 * @param WC_Order $order The order to prepare verification data for.
	 * @param array    $verification_data The initial verification data.
	 * @return array The prepared verification data.
	 */
	private function prepare_verification_data( WC_Order $order, array $verification_data ): array {
		$verification_data['order_id'] = $order->get_id();
		return $verification_data;
	}

	/**
	 * Prepare 3DS data for PaymentInit request.
	 *
	 * @param array $order_data Order and customer data.
	 * @return array Prepared 3DS data.
	 */
	public function prepare_3ds_data( array $order_data ): array {
		$threeds_data = array(
			'payinst'                                 => 'VPAS',
			'acctInfo'                                => $this->prepare_account_info( $order_data ),
			'threeDSRequestorAuthenticationInfo'      => $this->prepare_authentication_info( $order_data ),
			'threeDSRequestorPriorAuthenticationInfo' => $this->prepare_prior_auth_info( $order_data ),
		);

		$this->logger->debug( 'Prepared 3DS data', array( 'data' => $threeds_data ) );
		return $threeds_data;
	}

	/**
	 * Prepare account information for 3DS.
	 *
	 * @param array $order_data Order and customer data.
	 * @return array Account information.
	 */
	private function prepare_account_info( array $order_data ): array {
		$user_id      = $order_data['user_id'] ?? 0;
		$account_data = array();

		if ( $user_id ) {
			$user                    = get_userdata( $user_id );
			$registration_date       = $user->user_registered;
			$days_since_registration = ( time() - strtotime( $registration_date ) ) / DAY_IN_SECONDS;

			$account_data['chAccAgeInd'] = $days_since_registration > 365 ? '05' : '02';
			$account_data['chAccDate']   = gmdate( 'Ymd', strtotime( $registration_date ) );
		}

		return $account_data;
	}

	/**
	 * Prepare authentication information for 3DS request.
	 *
	 * @param array $order_data Order and customer data.
	 * @return array Authentication information.
	 */
	private function prepare_authentication_info( array $order_data ): array {
		$auth_info = array(
			'threeDSReqAuthMethod' => '02', // Example: 02 means two-factor authentication.
		);
		return $auth_info;
	}

	/**
	 * Prepare prior authentication information for 3DS request.
	 *
	 * @param array $order_data Order and customer data.
	 * @return array Prior authentication information.
	 */
	private function prepare_prior_auth_info( array $order_data ): array {
		$prior_auth_info = array(
			'threeDSReqPriorAuthData'   => 'ABC123', // Example data, this would come from prior transactions.
			'threeDSReqPriorAuthMethod' => '01',  // 01 indicates Frictionless flow.
		);
		return $prior_auth_info;
	}
}
</file>

<file path=".cursorignore">
# Add directories or file patterns to ignore during indexing (e.g. foo/ or *.csv)
</file>

<file path=".cursorrules">
Here's a strict breakdown of each file's responsibilities according to our Project Priorities:
1. class-novabankaipg.php (Main Plugin File)
Acts as the plugin bootstrap
Defines plugin constants
Handles autoloading
Initializes the dependency container
NO business logic, only initialization .
Core/class-novabankaipggateway.php
Extends WC_Payment_Gateway
Handles WooCommerce integration points
Manages gateway settings
Delegates all complex operations to services
NO direct API calls or data processing .
Services/class-paymentservice.php
Handles ALL payment-related business logic
Manages payment flow and states
Formats payment data
Uses APIHandler for communication
Provides hooks for customization
NO direct HTTP calls .
Services/class-notificationservice.php
Handles ALL notification processing
Validates notification data
Updates order statuses
Manages notification responses
NO direct API calls .
Utils/class-apihandler.php
ONLY handles raw HTTP communication
Makes API requests
Handles basic response validation
NO business logic
NO payment processing .
Utils/class-messagehandler.php
ONLY handles message construction
Generates message verifiers
Validates message signatures
NO HTTP calls
NO business logic .
Utils/class-datahandler.php
ONLY handles data formatting
Sanitizes input/output
Validates data structures
NO business logic
NO API calls .
Utils/class-logger.php
ONLY handles logging operations
Formats log messages
Manages log levels
Redacts sensitive data
NO business logic .
Services/class-PaymentService.php
ONLY creates PaymentService instances
Manages dependency injection
NO business logic
NO direct service calls .
Key Principles:
1. Each class has ONE primary responsibility
Services handle business logic
Utils handle technical operations
Core handles WooCommerce integration
NO circular dependencies
ALL public methods are documented
ALL sensitive data is redacted in logs
ALL user input is sanitized
ALL output is escaped
ALL errors are logged .
This structure ensures:
Clear separation of concerns
Easy testing
Simple maintenance
Secure operations
WordPress/WooCommerce compliance .

ALWAYS use latest WordPress/WooCommerce coding standards. Always use latest PHP coding standards. Always use . in inline comments. Alyways have SoC in mind. Always have simple and clean code. Always use the existing code as an example. Always try to keep the code DRY. Always have the user in mind. Always try to make the code more readable. Always have the user in mind. Always try to handle errors and exceptions gracefully.
</file>

<file path=".gitignore">
repopack-output-main-branch.xml
</file>

<file path="Asoft IPG 3DS eCommerce Transaction flow.md">
# 3DS E-commerce Transactions ​

## Introduction

This section describes the stages of an e-commerce transaction using the IPG platform and HPP web interface, focusing on the actions carried out by each party involved. ​

### The Buyer Perspective ​

1. Chooses products.  
2. Enters personal details for shipment and clicks "Buy". ​  
3. Is redirected to the HPP.  
4. Enters credit card data and clicks "Pay".  
5. If the card is 3-D Secure enabled, the Buyer is redirected to their bank's website to enter the password and then returns to the HPP. ​  
6. Is redirected to a specific page on the Merchant website displaying the payment result. ​  
7. Receives an email notification of payment if enabled by the Merchant. ​

### The Merchant Perspective ​

1. Receives a purchase order from the Buyer. ​  
2. Sends a PaymentInit message to IPG. ​  
3. Receives a unique PaymentID and the URL of the HPP. ​  
4. Redirects the Buyer to the HPP URL with the PaymentID. ​  
5. Receives a transaction notification from IPG. ​  
6. Responds with the URL for the Buyer to be redirected to for the transaction result. ​  
7. Presents the result to the Buyer. ​  
8. Receives an email notification of payment if enabled. ​

### The IPG Perspective ​

1. Receives a PaymentInit message from the Merchant. ​  
2. Responds with the HPP URL and a PaymentID. ​  
3. Presents the HPP to the Buyer. ​  
4. Receives the Buyer's credit card data. ​  
5. If the card is 3-D Secure enabled, redirects the Buyer to the bank's site for authentication and awaits the result. ​  
6. Processes the transaction by sending the request to the credit card company and gets a response. ​  
7. Sends a result notification message to the Merchant. ​  
8. Receives the URL for Buyer redirection. ​  
9. Redirects the Buyer to the specified URL. ​  
10. Sends an email notification of payment to the Buyer and/or Merchant if enabled. ​

### Diagram of Information Flow ​

The following pattern of actions/communications occurs during a transaction:

1. Buyer completes the shopping cart. ​  
2. Merchant prepares and returns the checkout page. ​  
3. Buyer fills out required fields and clicks "Buy".  
4. Merchant sends PaymentInit request to IPG. ​  
5. IPG verifies the request, saves transaction data, and returns the HPP URL and PaymentID. ​  
6. Merchant saves the PaymentID and redirects the browser to the HPP URL with the PaymentID. ​  
7. IPG checks the PaymentID, prepares the payment page, and returns it to the Buyer's browser. ​  
8. Buyer enters necessary data and clicks "Pay".  
9. If 3-D Secure, IPG redirects the browser to the bank's site for authentication. ​  
10. Buyer provides authentication data and is redirected back to IPG.  
11. IPG combines data and sends the request to the authorization system. ​  
12. Authorization system processes the request and returns the result to IPG. ​  
13. IPG sends a POST message to the Merchant with the transaction result. ​  
14. Merchant updates the transaction status and returns the URL for Buyer redirection. ​  
15. IPG redirects the browser to the specified URL and displays the final page with payment details. ​  
16. Buyer reviews the Merchant result page. ​

### Description of the Steps ​

The table below presents the full flow of activities in a payment transaction:

| Buyer | Merchant | Website IPG | Authorization Centre |
| ----- | ----- | ----- | ----- |
| 1\. Completes Shopping Cart. ​ | 2\. Prepares and returns the Check Out page. ​ |  |  |
| 3\. Fills out the required fields and clicks the "Buy” button. ​ | 4\. Prepares the HTTP PaymentInit request with all transaction data and sends it via POST to IPG. ​ | 5\. After verifying the validity of the request received, IPG saves the transaction data, associates a PaymentID to it and returns to the Merchant the URL where the Cardholder browser must be redirected and the PaymentID to use in redirection. ​ |  |
|  | 6\. Saves the PaymentID among other transaction data, then redirects the browser to the URL of the HPP specifying the PaymentID as the GET parameter. ​ | 7\. After checking the PaymentID received, IPG prepares the payment page and returns it to the buyer‘s browser. ​ |  |
| 8\. Enters the necessary data, and clicks the "Pay" button. Note: If the Buyer clicks the "Cancel" button, the transaction is not processed, and the flow proceeds to step 13\. ​ |  | 9\. (if the card is enabled for 3-D Secure) Redirects the browser to an external site to authenticate the Cardholder. ​ |  |
| 10\. (if the card is enabled for 3-D Secure) Provides their authentication data to the external site (the site of the bank that issued the credit card) and, at the end, is redirected to IPG. ​ |  | 11\. Receives data, combines it with data from the Merchant and the transaction and sends the request to the Authorisation System. ​ | 12\. Receives and processes the request and returns the result to IPG. ​ |
|  |  | 13\. Sends a POST message to the Merchant communicating the result of the transaction. ​ |  |
|  | 14\. Receives the message and updates the transaction status with the result received. ​ It then returns the URL where the buyer browser is to be redirected to for the presentation of the response page. ​ |  |  |
|  |  | 15\. Redirects the buyer browser to the URL specified by the merchant in previous step and displays the final page, with details of the payment result. ​ |  |
| 16\. Receives and reviews Merchant result page. ​ |  |  |  |

## Merchant Integration

### Introduction

IPG includes direct communications with the Merchant server to complete transactions. ​ This can be implemented via:

* A special plug-in. ​  
* Creating a custom communication interface. ​

### Messages Between the Merchant Site and IPG ​

Server-to-server messages are divided into:

* Online messages: Occur during the transaction and are mandatory.  
* Offline messages: Occur after the transaction and are optional. ​

### Online Messages

* PaymentInit Request: Sent by the Merchant to IPG to initialize the transaction. ​  
* PaymentInit Response: Sent by IPG to the Merchant containing the HPP URL and PaymentID. ​  
* Notification: Sent by IPG to the Merchant with transaction results. ​  
* Notification Response: Sent by the Merchant to IPG with the final redirection URL. ​

### Offline Messages

* Payment Request: Used for various accounting transactions post-payment. ​  
* PaymentQuery: Allows the Merchant to check the status and details of a transaction in real-time. ​

### Message Verifier

All messages are signed using a Message Verifier (msgVerifier) generated by:

1. Concatenating specified message data. ​  
2. Removing spaces.  
3. Hashing the string using SHA256. ​  
4. Base64 encoding the hash bytes. ​

Example for PaymentInit request:

* Concatenate: msgName \+ version \+ id \+ password \+ amt \+ trackid \+ udf1 \+ SECRET KEY \+ udf5 ​  
* Remove spaces.  
* Hash using SHA256. ​  
* Base64
</file>

<file path="AsoftIPG-integration-guide.xml">
This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repopack on: 2024-10-28T08:12:41.151Z

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.
</notes>

<additional_info>

For more information about Repopack, visit: https://github.com/yamadashy/repopack
</additional_info>

</file_summary>

<repository_structure>
AsoftIPG_Merchant_Integration.Guide_Payment3DS_v12.txt
</repository_structure>

<repository_files>
This section contains the contents of the repository's files.

<file path="AsoftIPG_Merchant_Integration.Guide_Payment3DS_v12.txt">
Asoft IPG 

Merchant Integration Guide 
Payment 3DS 
Version 1.12 

Table of Contents 
History of revisions................................................................................................................. 5 
Introduction ..................................................................................................................................... 6 
Hosted Payment Page (HPP) ................................................................................................ 6 
3DS e-commerce transactions ........................................................................................................ 7 
Introduction ............................................................................................................................ 7 
The Buyer perspective .................................................................................................. 7 
The Merchant perspective ............................................................................................ 7 
The IPG perspective ..................................................................................................... 7 
Diagram of information flow .......................................................................................... 8 
Description of the steps ................................................................................................ 9 
Merchant Integration ............................................................................................................ 10 
Introduction ................................................................................................................. 10 
Messages between the merchant site and IPG ........................................................... 10 
Online messages ........................................................................................................ 11 
Offline messages ........................................................................................................ 11 
Message Verifier ......................................................................................................... 12 
PaymentInit request .................................................................................................... 14 
PaymentInit response ................................................................................................. 20 
Notification message .................................................................................................. 20 
Notification response .................................................................................................. 23 
Financial Request message ........................................................................................ 23 
Financial Response message ..................................................................................... 24 
Payment Query Request message ............................................................................. 25 
Payment Query Response message ........................................................................... 26 
MOTO transactions ....................................................................................................................... 28 
Introduction .......................................................................................................................... 28 
The Buyer perspective ................................................................................................ 28 
The Merchant perspective .......................................................................................... 28 
The IPG perspective ................................................................................................... 28 
Merchant Integration ............................................................................................................ 28 
Introduction ................................................................................................................. 28 
Messages between the merchant site and IPG ........................................................... 29 
Message Verifier ......................................................................................................... 29 
Payment Request ....................................................................................................... 30 
Payment response ...................................................................................................... 32 
Plug-in interface specifications ...................................................................................................... 34 
Java plugin .......................................................................................................................... 34 
Java IPG Demo Plugin Simulator ................................................................................ 34 
IPG Payment Service Factory ..................................................................................... 35 
IPG Logger Interface .................................................................................................. 35 
IPG Payment Service Interface ................................................................................... 36 
DLL plugin ............................................................................................................................ 37 
Direct interface specifications ....................................................................................................... 38 
Communication protocol specifications ................................................................................ 38 
Data transmission format ..................................................................................................... 38 
Data reception format .......................................................................................................... 39 
IPG Demo Plugin .......................................................................................................................... 41 
Test environment........................................................................................................................... 42 
Variables to be set for the creation of PaymentInit message ................................................ 42 
Mandatory test cases ........................................................................................................... 42 
HPP Customization ....................................................................................................................... 44 
Examples of Layout1 and Layout2 ....................................................................................... 45 
Customization on Smartphones and Tablets ........................................................................ 45 
Appendix A – Response Codes ..................................................................................................... 46 
 
  Introduction 
The Electronic Commerce service aims at brokering the cash flow from Internet sales. Merchants, who already have their own website on the Internet, are provided with a unique platform for the complete management of E-commerce transactions by credit card: 
•
 Online: manage all phases of the economic transaction in a secure way. 

•
 Offline: provides the Merchant with an account to access the web via the administrative interface, in which he is able to check the status of transactions, generate operational reports and proceed to the necessary accounting operations. 


 
Hosted Payment Page (HPP) 
During the payment of an e-commerce transaction with a credit card, the Merchant redirects the 
browser of the Buyer to the Internet Payment Gateway site 
(hereafter IPG) to enter credit card data. In this way, the Merchant reaches many significant goals: 
•
 The Merchant is unaware of the credit card data used by the Buyer, thus eliminating the burden of having to implement all the safety requirements, physical and logical, required by the management and storage of this type of data. 

•
 IPG is delegated the E-Commerce protocol management intended to be used and for which the service has been obtained from the bank. 

•
 The Merchant can customise the payment page presented to the Buyer, so to maintain the same look and feel of the Merchant’s site and thus creating a transparent redirection for the Buyer, without affecting their shopping experience. 


 
The payment page presented by IPG to the Buyer is called Hosted Payment Page (HPP). It 
handles all payment protocols (also known as Payment Instruments) supported by the Merchant. 
A further benefit of this solution is the fact that should any evolutions of these protocols occur in 
the future, or the introduction of new ones, IPG will implement them on HPP, without the Merchant needing to make any changes to his site. 
 
 
  3DS e-commerce transactions 
Introduction 
This chapter aims to describe all the stages of an e-commerce transaction using the IPG platform 
and HPP web interface on it, initially focusing on the actions carried out by each of the parties involved and then integrating them into a smooth, continuous flow of successive stages. 
The Buyer perspective 
To make a purchase on the Merchant site, Buyer: 
•
 Chooses products 

•
 Enters their personal details to allow the shipment of goods and clicks on "Buy" button. 

•
 Is redirected to the HPP. 

•
 Enters their credit card data and clicks on the "Pay" button 

•
 If the card is 3-D Secure enabled, the Buyer is redirected to their bank website to enter the password associated with the credit card, and returns to the HPP upon completion 

•
 Is redirected to a specific page on the Merchant website which displays the result of the payment 

•
 Receives an e-mail message notification of payment if the setting is enabled by the Merchant, to be used as virtual receipt 


The Merchant perspective 
The Merchant receives a purchase order from the Buyer and: 
•
 Sends a payment initialization message (PaymentInit) to IPG 

•
 Receives a unique payment code (PaymentID) in response and the URL of the HPP 

•
 Redirects the Buyer to the URL of the HPP and attaches the PaymentID information 

•
 Receives the notification of the transaction from IPG 

•
 Responds with the URL to which the Buyer should be redirected for the presentation of the transaction result 

•
 Presents the result to the Buyer 

•
 Receives an e-mail message notification of payment if the setting is enabled by the Merchant, to be used as virtual receipt 


 
The IPG perspective 
IPG receives an initialization message (PaymentInit) from the Merchant and: 
•
 Responds with the URL of the HPP and a transaction identification code (PaymentID) 

•
 Presents the HPP to the Buyer 

•
 Receives Credit Card data of the Buyer 

•
 If the card is 3-D Secure enabled, it redirects the Buyer to his bank’s site to enter the password associated with the credit card, and awaits the reverse redirection with the authentication result provided by the bank 

•
 Processes the transaction by sending the request to the credit card company authorisation systems and gets a response 

•
 Sends a result notification message to the Merchant 

•
 Receives the URL to redirect the Buyer in return 

•
 Redirects the Buyer to the URL received 

•
 Sends an e-mail message notification of payment to the Buyer and / or the Merchant (if the setting is enabled by the Merchant) to be used as virtual receipt. 


Diagram of information flow 
By integrating all the previously described activities, the result is the following pattern of actions / 
communications that occur during a transaction between the parties involved: 
 
 
 

Description of the steps 
The table below presents the full flow of activities in a payment transaction: 
 
Buyer  
 Merchant 
 Website IPG 
 Authorisation 
centre 
 
1. Completes Shopping 
Cart. 
 2. Prepares and returns the Check Out page. 
  
  
 
3. Fills out the required 
fields and clicks the 
"Buy” button. 
 4. Prepares the HTTP 
PaymentInit request 
with all transaction 
data and sends it via 
POST to IPG. 
 5. After verifying the 
validity of the request 
received, IPG saves the transaction data, 
associates a PaymentID to it and returns to the 
Merchant the URL 
where the Cardholder 
browser must be 
redirected and the 
PaymentID to use in 
redirection. 
  
 
 
 6. Saves the PaymentID among other transaction data, then redirects the browser to the URL of the HPP specifying the 
PaymentID as the GET 
parameter. 
 7. After checking the 
PaymentID received, 
IPG prepares the 
payment page and 
returns it to the buyer‘s 
browser. 
  
 
8. Enters the necessary data, and clicks the "Pay" button. 
Note: If the Buyer 
clicks the "Cancel" 
button, the transaction 
is not processed, and 
the flow proceeds to 
step 13. 
  
 9. (if the card is enabled for 3-D Secure) Redirects the browser to an external site to authenticate the 
Cardholder. 
  
 
10. (if the card is 
enabled for 3-D 
Secure) Provides their 
authentication data to 
the external site (the 
site of the bank that 
issued the credit card) 
and, at the end, is 
redirected to IPG. 
  
 11. Receives data, 
combines it with data 
from the Merchant and 
the transaction and 
sends the request to 
the Authorisation 
System. 
 12. Receives and 
processes the request 
and returns the result 
to IPG. 
 
 
  
 13. Sends a POST 
  
 


message to the 
Merchant 
communicating the 
result of the 
transaction. 
 
 
 14. Receives the 
message and updates 
the transaction status 
with the result received. It then returns the URL where 
the buyer browser is to be redirected to for the 
presentation of the 
response page. 
  
  
 
 
  
 15. Redirects the buyer 
browser to the URL specified by the merchant in previous step and displays the final page, with details of the payment result. 
  
 
16. Receives and reviews Merchant result page. 
  
  
  
 


 
Merchant Integration 
Introduction 
IPG includes the presence of some direct communications with the Merchant server to complete 
the transactions. This exchange of messages can be implemented in two ways: 
•
 through the installation of a special plug-in 

•
 by creating their own communication interface 


 
The plug-in is easy to integrate and is compatible with all sites developed in Java, C/C++, ColdFusion, ActiveX/COM, VB, ASP, .NET. 
 
If it is not possible or desirable to use the plug-in (e.g. because it is not compatible with the 
technological platform, or the site is published via an external provider in shared hosting) it is 
always possible, according to the specifications provided, to create your own communication 
interface. 
 
Messages between the merchant site and IPG 
Server-to-server messages between the Merchant Site and IPG are divided into two categories: 
•
 Online messages: occur during the transaction (indicated with arrows filled in blue in 


the flow diagram described in section Diagram of information flow) - their implementation is mandatory to complete the transaction successfully; 
•
 Offline messages: take place after the transaction processing is finished and are used by the Merchant for specific purposes - their implementation is optional. 


Online messages 
•
 PaymentInit Request: initialization message sent by the Merchant to IPG (step 4 in above Diagram of information flow); 

•
 PaymentInit Response: message sent by IPG to the merchant containing URL of IPG payment page (HPP) and ID of payment initiation request (Payment ID) - step 5 in above Diagram of information flow; 

•
 Notification: message sent by IPG to the Merchant containing transaction results (step 13 in above Diagram of information flow); 

•
 Notification Response: message sent by the merchant to IPG containing final redirection URL (step 14 in above Diagram of information flow); 


 
Offline messages 
Payment Request - After the payment, the Merchant proceeds with the order. Subsequently, various accounting transactions may be required: for instance, the account crediting (if the transaction did not involve automatic crediting) to the repayment of the Customer in the event of returned goods, and so on.  
IPG offers the ability to manage these requirements quickly and effectively. It is possible to carry 
the operations out in 2 ways: 
•
 By connecting to the BackOffice site and using the features therein 

•
 By sending the request directly from the system to IPG, using the Payment message, in which all of the original transaction parameters must be entered and the appropriate action code is to be set. In 


 
PaymentQuery - allows the Merchant to contact IPG to know in real time, at every 
moment, the processing status and details of a particular transaction. 
 
  
Message Verifier 
 
All messages exchanged between Merchant Site and IPG are signed using Message Verifier (msgVerifier) which is dynamically composed of specific message data (see bellow message specifications). 
Steps for Message Verifier generation are: 
a) Concatenate specified message data to create Message Verifier string; 
b) Remove spaces (if exists) 
c) Hash the string created in previous step using SHA256 algorithm to get HASH bytes 
d) Base64 the HASH bytes to create final msgVerifier field value. 
Example of Message Verifier creation for PaymentInit request message - 
Message data 
 Value 
 
msgName 
 “PaymentInitRequest” 
 
version 
 “1” 
 
id 
 “89110001” 
 
password 
 “test1234” 
 
amt 
 “15.00” 
 
trackid 
 “CTV-TEST-PureBuy-1” 
 
udf1 
 “AA” 
 
SECRET KEY 
 “YXKZPOQ9RRLGPDED5D3PC5BJ” 
 
udf5 
 “EE “ 
 


 
a) Concatenate msgName, version, id, password, amt, trackid, udf1, SECRET KEY and udf5: 
“PaymentInitRequest189110001test123415.00CTV-TEST-PureBuy-1AAYXKZPOQ9RRLGPDED5D3PC5BJEE “ 
 
b) Remove spaces: 
 
“PaymentInitRequest189110001test123415.00CTV-TEST-PureBuy-1AAYXKZPOQ9RRLGPDED5D3PC5BJEE” 
 
c) Hash of step (b) value using SHA256 algorithm to generate hash bytes:  
 
B3A54617D2E9ACD9079D85EA15D066A5892E3CABE1B41DA4891B3A65FFAA0CCE 
 
d) Base64 of step (c) value to generate final msgVerifier value:  
 
s6VGF9LprNkHnYXqFdBmpYkuPKvhtB2kiRs6Zf+qDM4= 
 
 
  
Following is Java code example to message verifier calculation: 
  
public static void main(String[] args) { 
 try { 
 
   // https://hash.online-convert.com/sha256-generator    
   String messageVerifierBase = "PaymentInitRequest189110001test123415.00CTV-TEST-PureBuy-1AAYXKZPOQ9RRLGPDED5D3PC5BJEE"; 
   System.out.println("messageVerifierBase=" + messageVerifierBase); 
    
   MessageDigest digest = MessageDigest.getInstance("SHA-256"); 
   byte[] messageVerifierBase64Hash = digest.digest(messageVerifierBase.getBytes()); 
   System.out.println("SHA256(messageVerifierBase)=" + byteArrayToHex(messageVerifierBase64Hash)); 
 
   String msgVerifier = Base64Codec.encodeBytes(messageVerifierBase64Hash); 
   System.out.println("msgVerifier=Base64(SHA256(messageVerifierBase)=" + msgVerifier); 
             
  } catch (Throwable t) { 
t.printStackTrace(); 
  } 
} 
 
public static String byteArrayToHex(byte[] bytes) { 
  StringBuilder result = new StringBuilder(bytes.length * 2); 
  for (byte singleByte : bytes) { 
    result.append(String.format("%02x", singleByte).toUpperCase()); 
  } 
  return result.toString(); 
 } 
 
Following is printed on Java console: 
 
messageVerifierBase=PaymentInitRequest189110001test123415.00CTV-TEST-PureBuy-1AAYXKZPOQ9RRLGPDED5D3PC5BJEE 
SHA256(messageVerifierBase)=B3A54617D2E9ACD9079D85EA15D066A5892E3CABE1B41DA4891B3A65FFAA0CCE  
msgVerifier=Base64(SHA256(messageVerifierBase))=s6VGF9LprNkHnYXqFdBmpYkuPKvhtB2kiRs6Zf+qDM4= 
 
Note: if Base64(SHA256(messageVerifierBase)) calculation results with different string value, common issue is related to the value of messageVerifierBase.  
Message verifier base must match fields from specific fields from request or response message.  
For example: purchase amount value (15.00) takes part in the message verifier calculation, but different purchase amount value is provided in the JSON message (15). 
  
The same message verifier value could be calculated via https://hash.online-convert.com/sha256-generator: 
 
 

 
 
After clicking on START, following result is displayed: 
 
 

  
PaymentInit request 
This message is sent by the Merchant to IPG to start a transaction. It uses the following items: 
 
<Request> 
 
1st 
levTag 
 2nd 
levTag 
 3rd 
lev Tag 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
  
 M 
 30 
 “PaymentInitRequest” 
 
<version> 
  
  
 M 
 8 
 “1” (integer) 
 
<id> 
  
  
 M 
 8 
 TranPortalID - TranPortalID, assigned during activation of the service 
 
<password> 
  
  
 M 
 16 
 Password associated with TranPortalID 
 
<payinst> 
  
  
 O 
 20 
 "CC"/"VPAS"/"IP"/"MPASS"/"MYBANK" - to be specified if Merchant wants to show only one specific payment Instrument. 
 
<action> 
  
  
 M 
 2 
 Type of transaction: 
1=Purchase 
4=Authorization 
14 = Card Verification 
 
<currencycode> 
  
  
 M 
 3 
 Currency code 
 
<amt> 
  
  
 M 
 10.2 
 Transaction amount 
(NNNNNNNNNN.NN format 
Max. Val. 9999999999.99). 
 
<trackid> 
  
  
 M 
 255 
 Order identification code set by the Merchant. It is advisable that this code is unique to each transaction. 
 
<RecurAction> 
  
  
 M 
 10 
 Possible Values (case insensitive): 
“” – indicates a normal e-commerce order 
“activation” – indicates that the Merchant requires a new Recurring Payment to be activated with this order 
“consumer_initiated” – indicates card-on-file consumer initiated payment 
 
<RecurContractId> 
  
  
 O 
 30 
 Optional information to collect the Recurring Payment Contract Identifier. 
 
<recurid> 
  
  
 C 
 20 
 Recurring Payment identifier. Mandatory if <RecurAction>=”consumer_initiated” in the PaymentInit request and terminal is enabled to Rec. Pymnts.  
 
<pymnDscr> 
  
  
 O 
 255 
 Recurring Payment description 
 
<cardSHA2> 
  
  
 O 
 1 
 “Y” / “N” to receive the card SHA-2 hash in the notification message  
 
<paymentTimeout> 
  
  
 O 
 2 
 payment session validity (from the paymentInit time) – in number of minutes. If not present, IPG default value is used . 
 
 
  
  
  
  
  
 
<bankStmtFreeText> 
  
  
 O 
 50 
 Free Text that will be forwarded to Auth System in p127, to be printed on bank account statement. 
 
<instructedFees> 
  
  
 O 
 255 
 Text field that can host any fees that could be applied to the original amount. 
 


<responseURL> 
  
  
 M 
 255 
 URL used by IPG to send Notification Message to the Merchant. 
 
<errorURL> 
  
  
 M 
 384 
 URL towards which IPG redirects the Buyer in case that any problem occurs when sending the Notification Message. 
 
<notificationFormat> 
  
  
 O 
 10 
 Optional field to specify the format of the Notification Message sent by IPG. Possible values: 
- “xml” – msg is sent in xml format 
- “form” – msg is sent as a HTML form (nvp) 
If empty, the default value is “xml”. Values different from those specified will generate a validation error. 
 
<paymentPageMode> 
  
  
 O 
 1 
 Payment Page mode 
0 = Standard (the customer's browser is redirected to the payment page) 
1 = Light Box (the payment page is presented on the merchant page). 
If omitted, the Standard option is assumed. 
 
<langid> 
  
  
 M 
 3 
 Code to set the language in which HPP will be displayed and for notification email. The following are supported: 
"ITA" = Italian 
"USA" = English 
"FRA" = French 
"DEU" = German 
"ESP" = Spanish 
"SLO" = Slovenian 
"SRB" = Serbian 
"POR" = Portuguese 
"RUS" = Russian 
 
<udf1> 
  
  
 O 
 255 
 User free field 1. 
Field at the discretion of the Merchant used for an additional information. 
 
<udf2> 
  
  
 O 
 255 
 User free field 2 
 
<udf3> 
  
  
 O 
 255 
 User free field 3 
 
<udf4> 
  
  
 O 
 255 
 User free field 4 
 
<udf5> 
  
  
 O 
 255 
 User free field 5 
 
<buyerFirstName> 
  
  
 O 
 50 
 Buyer first name 
 
<buyerLastName> 
  
  
 O 
 50 
 Buyer last name 
 
<buyerUserId> 
  
  
 O 
 50 
 UserId with which the buyer is registered at the merchant web site 
 
<buyerPhoneNumber> 
  
  
 O 
 20 
 Buyer phone number 
 
<buyerEmailAddress> 
  
  
 O 
 255 
 Allows you to pre-set the email field that the 
Buyer can enter on the payment page to 
receive transaction e-mail receipt (option only 
possible if the Merchant has enabled the sending email function to the Buyer using the back office). 
 
<cartContent> 
  
  
 O 
  
 Shopping cart content. 
 
 
 <item> 
  
 C 
  
 [1..n] <item> tags if <cartContent> is present 
 
 
  
 <productId> 
 M 
 30 
 product identifier 
 
 
  
 <productDesc> 
 O 
 255 
 product description 
 
 
  
 <qty> 
 M 
 8 
 product quantity in the cart 
 


 
  
 <singlePrice> 
 M 
 10.2 
 product single price  
 
<shippingInfo> 
  
  
 O 
  
 Shipping Details 
 
 
 <recipientFirstName> 
  
 C 
 50 
 Recipient First Name. Mandatory if <shippingInfo> is present. 
 
 
 <recipientLastName> 
  
 C 
 50 
 Recipient Last Name. Mandatory if <shippingInfo> is present. 
 
 
 <recipientPhoneNumber> 
  
 O 
 20 
 Recipient Phone Number. 
 
 
 <ShippingAddress> 
  
 C 
  
 Shipping Address. Mandatory if <shippingInfo> is present 
 
 
  
 <country> 
 C 
 3 
 Shipping Country. Mandatory if <buyerShippingAddress> is present. ISO 3166-1 (Alpha 3) format required. 
 
 
  
 <city> 
 C 
 40 
 Shipping City. Mandatory if <buyerShippingAddress> is present 
 
 
  
 <zip> 
 C 
 20 
 Shipping Postal Code. Mandatory if <buyerShippingAddress> is present 
 
 
  
 <addrLine1> 
 C 
 100 
 Shipping Address Line 1 (Street name, number). Mandatory if <buyerShippingAddress> is present 
 
 
  
 <addrLine2> 
 O 
 100 
 Shipping Address Line 2 (apt number, suite, etc) 
 
 
  
 <addrLine3> 
 O 
 40 
 Shipping Address Line 3 (all info not containable in first 2 lines) 
 
<billingInfo> 
  
  
 O 
  
 Billing Details 
 
 
 <billingFirstName> 
  
 C 
 50 
 First name of the billed person. Mandatory if <billingInfo> is present 
 
 
 <billingLastName> 
  
 C 
 50 
 Last name of the billed person. Mandatory if <billingInfo> is present 
 
 
 <billingAddress> 
  
 C 
  
 Billing Address. Mandatory if <billingInfo> is present  
 
 
  
 <country> 
 C 
 3 
 Billing Country. Mandatory if <billingAddress> is present. ISO 3166-1 (Alpha 3) format required. 
 
 
  
 <city> 
 C 
 40 
 Billing City. Mandatory if <billingAddress> is present 
 
 
  
 <zip> 
 C 
 20 
 Billing Postal Code. Mandatory if <billingAddress> is present 
 
 
  
 <addrLine1> 
 C 
 100 
 Billing Address Line 1 (Street name, number). Mandatory if <billingAddress> is present 
 
 
  
 <addrLine2> 
 O 
 100 
 Billing Address Line 2 (Street name, number) 
 
 
  
 <addrLine3> 
 O 
 40 
 Billing Address Line 3 (all info not containable in first 2 lines) 
 
<acctType> 
  
  
 O 
 2 
 Account Type 
Accepted Values: 
01 = Not Applicable 
02 = Credit 
03 = Debit 
 
<acctInfo> 
 <chAccAgeInd> 
  
 O 
 2 
 Length of time that the cardholder has had the account with the merchant. 
Accepted Values: 
01 = No account (guest check-out) 
02 = Created during this transaction 
03 = Less than 30 days 
04 = 30−60 days 
05 = More than 60 days 
 
 
 <chAccDate> 
  
 O 
 8 
 Date that the cardholder opened the account with the merchant. 
 


Format accepted: 
Date format = YYYYMMDD 
 
 
 <chAccChangeInd> 
  
 O 
 2 
 Length of time since the cardholder’s account information with the merchant was last changed. 
Accepted Values: 
01 = Changed during this transaction 
02 = Less than 30 days 
03 = 30−60 days 
04 = More than 60 days 
 
 
 <chAccChange> 
  
 O 
 8 
 Date that the cardholder’s account with the merchant was last changed. 
Format accepted: 
Date format = YYYYMMDD 
 
 
 <chAccPwChangeInd> 
  
 O 
 2 
 Indicates the length of time since the cardholder’s account with the merchant had a password change or account reset. 
Accepted Values: 
01 = No change 
02 = Changed during this transaction 
03 = Less than 30 days 
04 = 30−60 days 
05 = More than 60 days 
 
 
 <chAccPwChange> 
  
 O 
 8 
 Date that cardholder’s account with the merchant had a password change or account reset. 
Format accepted: 
Date format = YYYYMMDD 
 
 
 <shipAddressUsageInd> 
  
 O 
 2 
 Indicates when the shipping address used for this transaction was first used with the merchant. 
Accepted Values: 
01 = This transaction 
02 = Less than 30 days 
03 = 30−60 days 
04 = More than 60 days 
 
 
 <shipAddressUsage> 
  
 O 
 8 
 Date when the shipping address used for this transaction was first used with the merchant. 
Format accepted: 
Date format = YYYYMMDD 
 
 
 <txnActivityDay> 
  
 O 
 3 
 Number of transactions (successful and abandoned) for this cardholder account with the merchant across all payment accounts in the previous 24 hours. 
 
 
 <txnActivityYear> 
  
 O 
 3 
 Number of transactions (successful and abandoned) for this cardholder account with the merchant across all payment accounts in the previous year. 
 
 
 <provisionAttemptsDay> 
  
 O 
 3 
 Number of Add Card attempts in the last 24 hours. 
 
 
 <nbPurchaseAccount> 
  
 O 
 4 
 Number of purchases with this cardholder account during the previous six months. 
 
 
 <suspiciousAccActivity> 
  
 O 
 2 
 Indicates whether the merchant has experienced suspicious activity on the cardholder account. 
Values accepted: 
01 = No suspicious activity has been observed 
02 = Suspicious activity has been observed 
 


 
 <shipNameIndicator> 
  
 O 
 2 
 Indicates if the Cardholder Name on the account is identical to the shipping Name used for this transaction. 
Values accepted: 
• 01 = Account Name identical to shipping Name 
• 02 = Account Name different than shipping Name 
 
 
 <paymentAccInd> 
  
 O 
 2 
 Indicates the length of time that the payment account was enrolled in the cardholder’s account with the merchant. 
Values accepted: 
01 = No account (guest check-out) 
02 = During this transaction 
03 = Less than 30 days 
04 = 30−60 days 
05 = More than 60 days 
 
 
 <paymentAccAge> 
  
 O 
 8 
 Date that the payment account was enrolled in the cardholder’s account with the merchant. 
Format accepted: 
Date format = YYYYMMDD 
 
<threeDSRequestorAuthenticationInfo> 
 <threeDSReqAuthMethod> 
  
 O 
 2 
 Mechanism used by the Cardholder to authenticate to the merchant. 
Values accepted: 
01 = No merchant authentication occurred (i.e. cardholder “logged in” as guest) 
02 = Login to the cardholder account at the 3DS Requestor system using merchant’s own credentials 
03 = Login to the cardholder account at the merchant system using federated ID 
04 = Login to the cardholder account at the merchant system using issuer credentials 
05 = Login to the cardholder account at the merchant system using third-party authentication 
06 = Login to the cardholder account at the merchant system using FIDO Authenticator 
07 = Login to the cardholder account at the merchant system using FIDO Authenticator (FIDO assurance data signed) 
08 = SRC Assurance Data 
 
 
 <threeDSReqAuthTimestamp> 
  
 O 
 12 
 Date and time in UTC of the cardholder authentication. 
Format accepted: 
Date format = YYYYMMDDHHMM 
 
 
 <threeDSReqAuthData> 
  
 O 
 20000 
 Data that documents and supports a specific authentication process. 
 
<threeDSRequestorPriorAuthenticationInfo> 
 <threeDSReqPriorAuthMethod> 
  
 O 
 2 
 Mechanism used by the Cardholder to previously authenticate to the merchant. 
Values accepted: 
• 01 = Frictionless authentication occurred by ACS 
• 02 = Cardholder challenge occurred by ACS 
• 03 = AVS verified 
• 04 = Other issuer methods 
 
 
 <threeDSReqPriorRef> 
  
 O 
 36 
 This data element provides additional information to the ACS to determine the best approach for handing a request. 
Value accepted: 
 


This data element contains an ACS Transaction ID for a prior authenticated transaction (for example, the first recurring transaction that was authenticated with the cardholder). 
 
 
 <threeDSReqPriorAuthTimestamp> 
  
 O 
 12 
 Date and time in UTC of the prior cardholder authentication. 
Format accepted: 
Date format = YYYYMMDDHHMM 
 
 
 <threeDSReqPriorAuthData> 
  
 O 
 2048 
 Data that documents and supports a specific authentication process. 
 
<msgVerifier> 
  
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
msgName + version + id + password + amt + trackid + udf1 + SECRET KEY + udf5 
 


PaymentInit response 
The response, that IPG returns to Merchant after getting PaymentInit request and having verified 
the validity, contains the following fields: 
 
<Response> 
  
 contains an attribute “type” whose value can be: “valid” or “error” 
 
1st 
levTag 
 Response Type 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
 M 
 30 
 “PaymentInitResponse” 
 
<version> 
  
 M 
 8 
 “1” (integer) 
 
<msgDateTime> 
  
 M 
 24 
 Message creation date/time, in UTC format 
 
<paymentID> 
 valid 
 M 
 20 
 Order PaymentID.  
 
<browserRedirectionURL> 
 valid 
 M 
 256 
 IPG URL for browser redirection. 
 
<errorCode> 
 error 
 M 
 20 
 Error Code returned by IPG.  
 
<errorService> 
 error 
 M 
 30 
 Error Service returned by IPG. 
 
<errorDesc> 
 error 
 M 
 256 
 Error Description returned by IPG. 
 
<msgVerifier> 
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
1)
 If type=”valid”: msgName + version + msgDateTime + paymentID + SECRET KEY + browserRedirectionURL 

2)
 If type=”error”: msgName + version + msgDateTime + errorCode + SECRET KEY + errorDesc 


 
IMP.: Considerations reported at REQ11 of par. 4.1 apply 
 


 
Notification message 
After payment processing, IPG sends this message to inform the Merchant of the transaction result (if it has been processed) or the error reason (if it has not been processed). The messages exchanged can be formatted in xml or as a html form (nvp), based on the value of the NotificationFormat field of the PaymentInit message. The default, if not specified, is the xml format. 
 
Notification message in the case of xml format has the following structure: 
 
<Request> 
  
  
  
 contains an attribute “type” whose value can be: “valid” or “error” 
  
 
1st 
levTag 
 2rd 
lev Tag 
 Response Type 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
  
 M 
 30 
 “PaymentNotificationRequest” 
 
<version> 
  
  
 M 
 8 
 “1” (integer) 
 
<msgDateTime> 
  
  
 M 
 24 
 Message creation date/time, in UTC format 
 
<paymentID> 
  
  
 M 
 20 
 Order PaymentID. 
 
<tranID> 
  
 valid 
 M 
 20 
 TransactionID. 
 
<action> 
  
 valid 
 M 
 2 
 Action code. 
 
<payinst> 
  
 valid 
 M 
 20 
 Payment Instrument used for the transaction.  
 
<result> 
  
 valid 
 M 
 20 
 Result of the operation: 
"APPROVED" = Successful preauthorization 
"NOT APPROVED" = Not Authorized preauthorization 
"CAPTURED" = Successful purchase  
"NOT CAPTURED" = Not Authorized purchase 
"DENIED BY RISK" = Not processed due to failure to pass any risk criteria imposed by banks 
"HOST TIMEOUT" = Not processed due to no reply by the authorization system 
"ISSUER UNAVAILABLE" = Not processed due to failed connection with the authorization system 
 
<auth> 
  
 valid 
 M 
 35 
 Auth Code. 
 
<currencycode> 
  
 valid 
 M 
 3 
 Currency code. 
 
<amt> 
  
 valid 
 M 
 10.2 
 nnnnnnnnnn.nn. 
 
<trackid> 
  
 valid 
 M 
 255 
 Merchant TrackId. 
 
<ref> 
  
 valid 
 M 
 20 
 Auth system ref number. Mandatory if payinst = “CC”/”VPAS” /"IP"/”MPASS” 
 
<responsecode> 
  
 valid 
 M 
 3 
 Host Response Code. Mandatory if payinst = “CC”/”VPAS” /"IP"/”MPASS” 
 
<cardtype> 
  
 valid 
 M 
 10 
 Brand Id. Mandatory if payinst = “CC”/”VPAS” /"IP"/”MPASS” 
 
<liability> 
  
 valid 
 M 
 1 
 “Y” / “N”. Mandatory if payinst = “CC”/”VPAS” /"IP"/”MPASS” 
 
<RecurContractID> 
  
 valid 
 O 
 30 
 Recurring Payment Contract Identifier. 
 
<recurid> 
  
 valid 
 C 
 20 
 Recurring Payment identifier. Only if Merchant specified <RecurAction>=”ACTIVATION” in the PaymentInit request and terminal is enabled to Rec. Pymnts.  
 
<expDate> 
  
 valid 
 M 
 6 
 Card expiry date 
 
<cardLastFourDigits> 
  
 valid 
 M 
 4 
 Card last 4 digits 
 
<cardCountry> 
  
 valid 
 M 
 2 
 card country. Only if payinst = “CC”,”VPAS”,”MPASS” 
 
<ipCountry> 
  
 valid 
 M 
 2 
 IP address country 
 
<cardSHA2> 
  
 valid 
 C 
 32 
 card number hash value, using sha2 (256) algorithm. Only if Merchant specified the <cardSha2> = “Y” field in the PaymentInit request and payinst = “CC”,”VPAS”,”MPASS” 
 
<udf1> 
  
 valid 
 O 
 255 
 user free field 1 
 
<udf2> 
  
 valid 
 O 
 255 
 user free field 2 
 
<udf3> 
  
 valid 
 O 
 255 
 user free field 3 
 
<udf4> 
  
 valid 
 O 
 255 
 user free field 4 
 
<udf5> 
  
 valid 
 O 
 255 
 user free field 5 
 


<riskLevel> 
  
 valid 
 C 
 20 
 Risk Level (“GREEN”/”YELLOW”/”RED”) – Only if and terminal is Smash enabled. 
 
<riskThreshold> 
  
 valid 
 C 
 4 
 Risk treshold (score that defines the borderline between GREEN and YELLOW zones) – Only if terminal is Smash enabled 
 
<riskScore> 
  
 valid 
 C 
 4 
 Risk score – Only if terminal is Smash enabled. 
 
<riskMaxScore> 
  
 valid 
 C 
 4 
 Max Risk Score for the risk policy that assessed the transaction (sum of “scoreConfigured” values returned by SMASH) – Only if terminal is Smash enabled. 
 
<myBankBuyerBankAlias> 
  
 valid 
 C 
 256 
 Alias of the Buyer Bank choosen by the buyer. Only if payInst=”MYBANK” 
 
<mpShippingFlag> 
  
 valid 
 C 
 3 
 MasterPass shipping flag configured by the Merchant in GUI: “SUP”/”NOT”/”DYN”. Only if payInst=”MPASS”. –  Future use –  
 
 
 <mpShippingOption> 
 valid 
 C 
 20 
 MasterPass shipping option choosen by the buyer after wallet comeback. Only if payInst=”MPASS” and if <mpShippingFlag>=”DYN”. –  Future use – 
 
 
 <mpShippingRecipientName> 
 valid 
 C 
 100 
 Recipient Name. Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpShippingRecipientPhoneNumber> 
 valid 
 C 
 20 
 Recipient Phone Number. Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpShippingCountry> 
 valid 
 C 
 2 
 Shipping Country. Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpShippingCountrySubdivision> 
 valid 
 C 
 5 
 Shipping country subdivision. Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpShippingCity> 
 valid 
 C 
 25 
 Shipping City. Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpShippingpostalCode> 
 valid 
 C 
 20 
 Shipping Postal Code. Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpAddrLine1> 
 valid 
 C 
 40 
 Shipping Address Line 1 (Street name, number). Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpAddrLine2> 
 valid 
 O 
 40 
 Shipping Address Line 2 (apt number, suite, etc). Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
 
 <mpAddrLine3> 
 valid 
 O 
 256 
 Shipping Address Line 3 (all info not containable in first 2 lines). Only if payInst=”MPASS” and if <mpShippingFlag>=”NOT”. –  Future use – 
 
<errorCode> 
  
 error 
 M 
 20 
 Error Code returned by IPG. 
 
<errorService> 
  
 error 
 M 
 30 
 Error Service returned by IPG. 
 
<errorDesc> 
  
 error 
 M 
 256 
 Error Description returned by IPG. 
 
<msgVerifier> 
  
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
1)
 If type=”valid”: msgName + version + msgDateTime + paymentid + tranid + amt + trackid + udf1 + SECRET KEY + udf5 

2)
 If type=”error”: msgName + version + msgDateTime + paymentid + errorCode + SECRET KEY + errorDesc 


 


 
 
Notification response 
In Notification response, the Merchant sends the URL to which he wants the Customer to be redirected for the presentation of the result page. 
The merchant Notification response message must follow the same format chosen for the Notification request. In the xml case the structure is the following: 
 
<Response> 
 
1st 
levTag 
 2nd 
levTag 
 3rd 
lev Tag 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
  
 M 
 30 
 “PaymentNotificationResponse” 
 
<version> 
  
  
 M 
 8 
 “1” (integer) 
 
<paymentID> 
  
  
 M 
 20 
 Order PaymentID 
 
<browserRedirectionURL> 
  
  
 M 
 512 
 URL for the final browser redirection to the Merchant website 
 
<msgVerifier> 
  
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256). 
String to hash in this exact order (only fields values, not tags): 
msgName + version + paymentID + SECRET KEY + browserRedirectionURL 
 


 
 
 
Financial Request message 
Through a simple exchange of server-to-server messages, the Merchant can make automated 
financial operations (Credit, Capture, Purchase Reversal and Void Preauthorization) remotely. 
 
The fields to be included in the request message are: 
<Request> 
 
1st 
levTag 
  
  
 Mand 
 Max 
Size 
 Description 
 
<msgName> 
  
  
 M 
 30 
 “FinancialRequest” 
 
<version> 
  
  
 M 
 8 
 “1” (integer) 
 
<id> 
  
  
 M 
 8 
 TranPortalID, assigned during activation of the 
service 
 
<password> 
  
  
 M 
 16 
 Password associated with TranPortalID 
 
<tranid> 
  
  
 M 
 20 
 Unique identification code of the original 
transaction, created by IPG and communicated to the Merchant in the Notification Message 
 
<action> 
  
  
 M 
 2 
 Type of action: 
2 = Credit 
3 = Purchase Reversal 
5 = Capture 
9 = Void Preauthorization 
 
<currencycode> 
  
  
 O 
 3 
 currency code 
 
<amt> 
  
  
 M 
 10.2 
 operation amount (nnnnnnnnnn.nn) 
 
<trackid> 
  
  
 M 
 255 
 Identification code associated with the order by the Merchant. Usually this is the identification code of the purchase order on the Merchant site. It is advisable that this code is unique to each transaction. 
 


<udf1> 
  
  
 O 
 255 
 Field entry at the discretion of the Merchant and returned unchanged by IPG. 
 
<udf2> 
  
  
 O 
 255 
 Field entry at the discretion of the Merchant and returned unchanged by IPG. 
 
<udf3> 
  
  
 O 
 255 
 Field entry at the discretion of the Merchant and returned unchanged by IPG. 
 
<udf4> 
  
  
 O 
 255 
 Field entry at the discretion of the Merchant and returned unchanged by IPG. 
 
<udf5> 
  
  
 O 
 255 
 Field entry at the discretion of the Merchant and returned unchanged by IPG. 
 
<msgVerifier> 
  
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
msgName + version + id + password + tranid + amt + trackid + udf1 + SECRET KEY + udf5 
 


 
Financial Response message 
The response that IPG returns to Merchant, after evaluating the financial request and processing the 
transaction, contains the following fields: 
<Response> 
  
  
  
 contains an attribute “type” whose value can be: “valid” or “error” 
 
1st 
levTag 
 Response 
Type 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
 M 
 30 
 “FinancialResponse” 
 
<version> 
  
 M 
 8 
 “1” (integer) 
 
<msgDateTime> 
  
 M 
 24 
 Message creation date/time, in UTC format 
 
<recurid> 
 “valid” 
 C 
 20 
 RecurID (if referenced original transaction is under a RecurID, the response reports the RecurID) 
 
<paymentid> 
 “valid” 
 C 
 20 
 PaymentID (if referenced original transaction has a PaymentID, the response reports the PaymentID) 
 
<payinst> 
 “valid” 
 M 
 20 
 Payment instrument used for the transaction (Credit Card, 3D Secure, MasterPass, MyBank) 
 
<tranid> 
 “valid” 
 M 
 20 
 Unique transaction identification code assigned by IPG 
 
<action> 
 “valid” 
 M 
 2 
 Type of action: 
2 = Credit 
3 = Purchase Reversal 
5 = Capture 
9 = Void Preauthorization 
 
<result> 
 “valid” 
 M 
 20 
 Transaction result: 
"CAPTURED" = Successful Captured (if Action 5) 
"CAPTURED" = Successful Credited (if Action = 2) 
"NOT CAPTURED" = Not credited/Re-credited 
“VOIDED” = Successful Written off (if Action =3), or Canceled (if Action=9) 
"DENIED BY RISK" = Denied because exceeding the limits imposed by the bank 
 


"HOST TIMEOUT" = Not processed due to no reply by the authorization system within specified period. 
"ISSUER UNAVAILABLE" = Not processed due to failed connection with the authorization system 
 
<auth> 
 “valid” 
 M 
 35 
 Authorization code released by the credit card company, concerning the original transaction. 
 
<currencycode> 
 “valid” 
 M 
 3 
 Currency code. 
 
<amt> 
 “valid” 
 M 
 10.2 
 nnnnnnnnnn.nn. 
 
<trackid> 
 “valid” 
 M 
 255 
 Merchant TrackId.  
 
<ref> 
 “valid” 
 M 
 20 
 Authorization system reference number. 
 
<responsecode> 
 “valid” 
 M 
 3 
 Code granted by the Issuer that identifies, in case of failure, the reason for denying  
 
<udf1> 
 “valid” 
 O 
 255 
 user free field 1. If sent by the Merchant 
 
<udf2> 
 “valid” 
 O 
 255 
 user free field 2. If sent by the Merchant 
 
<udf3> 
 “valid” 
 O 
 255 
 user free field 3. If sent by the Merchant 
 
<udf4> 
 “valid” 
 O 
 255 
 user free field 4. If sent by the Merchant 
 
<udf5> 
 “valid” 
 O 
 255 
 user free field 5. If sent by the Merchant 
 
<cardtype> 
 “valid” 
 M 
 10 
 Brand Id (Visa, MasterCard, AMEX,...) 
 
<expDate> 
 “valid” 
 M 
 6 
 Card expiry date 
 
<cardLastFourDigits> 
 “valid” 
 M 
 4 
 Card last 4 digits 
 
<errorCode> 
 “error” 
 M 
 20 
 Error Code returned by IPG. 
 
<errorService> 
 “error” 
 M 
 30 
 Error Service returned by IPG. 
 
<errorDesc> 
 “error” 
 M 
 256 
 Error Description returned by IPG. 
 
<msgVerifier> 
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
1)
 If type=”valid”: msgName + version + msgDateTime + tranid + result + amt + trackid + udf1 + SECRET KEY + udf5 

2)
 If type=”error”: msgName + version + msgDateTime + errorCode + SECRET KEY + errorDesc 


 
IMP.: Considerations reported at REQ11 of par. 4.1 apply 
 


 
 
Payment Query Request message 
Through a simple exchange of server-to-server messages, the Merchant can request information about payment order status. 
 
The fields to be included in the request message are: 
<Request> 
 
1st 
levTag 
  
  
 Mand 
 Max 
Size 
 Description 
 
<msgName> 
  
  
 M 
 30 
 “PaymentQueryRequest” 
 
<version> 
  
  
 M 
 8 
 “1” (integer) 
 
<id> 
  
  
 M 
 8 
 TranPortalID, assigned during activation of the 
service 
 
<password> 
  
  
 M 
 16 
 Password associated with TranPortalID 
 
<action> 
  
  
 M 
 2 
 Type of action: 
8 = Payment Query 
 


<paymentid> 
  
  
 M 
 20 
 Unique identification code of the order, created by IPG and communicated to the Merchant in the PaymentInitResponse Message 
 
<msgVerifier> 
  
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
msgName + version + id + password + action + SECRET KEY + paymentid 
 


 
Payment Query Response message 
The response that IPG returns to Merchant, after processing the Payment Query request, contains the following fields: 
<Response> 
  
  
  
 contains an attribute “type” whose value can be: “valid” or “error” 
 
1st 
levTag 
 2nd 
levTag 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
 M 
 30 
 “PaymentQuaryResponse” 
 
<version> 
  
 M 
 8 
 “1” (integer) 
 
<msgDateTime> 
  
 M 
 24 
 Message creation date/time, in UTC format 
 
<merchantid> 
  
 M 
 10 
 Unique merchant identificator 
 
<termid> 
  
 M 
 8 
 TranPortalID, assigned during activation of the 
service 
 
<paymentid> 
  
 M 
 20 
 Order ID 
 
<trackid> 
  
 M 
 255 
 Merchant TrackId.  
 
<tranid> 
  
 M 
 20 
 Unique transaction identification code assigned by IPG 
 
<currencycode> 
  
 M 
 3 
 Currency code. 
 
<amt> 
  
 M 
 10.2 
 nnnnnnnnnn.nn. 
 
<status> 
  
 M 
 12 
 Order status: 
"INITIALIZED" = PaymentInit message received and validated by IPG. Payment page has not been displayed to the customer 
"PRESENTED" = Payment page presented, but the customer has not completed the process.                          
“PROCESSED” = The order has been completely processed by the IPG, and confirmation message received from the host. 
“TIMEOUT” = The order has expired due to the host timing out the process. 
 
<result> 
  
 M 
 20 
 Transaction result: 
"CAPTURED" = Successful Captured (if Action 5) 
"CAPTURED" = Successful Credited (if Action = 2) 
"NOT CAPTURED" = Not credited/Re-credited 
“VOIDED” = Successful Written off (if Action =3), or Canceled (if Action=9) 
"DENIED BY RISK" = Denied because exceeding the limits imposed by the bank 
"HOST TIMEOUT" = Not processed due to no reply by the authorization system within specified period. 
 


"ISSUER UNAVAILABLE" = Not processed due to failed connection with the authorization system 
 
<payinst> 
  
 M 
 20 
 Payment instrument used for the transaction (Credit Card, 3D Secure, Instant Payment, MasterPass, MyBank) 
 
<payinittm> 
  
 M 
 11 
 Order Initialization Date/Time 
 
<payprsntm> 
  
 M 
 11 
 Order Presentment Date/Time 
 
<payprcstm> 
  
 M 
 11 
 Order Processed Date/Time 
 
<udf1> 
  
 O 
 255 
 user free field 1. If sent by the Merchant 
 
<udf2> 
  
 O 
 255 
 user free field 2. If sent by the Merchant 
 
<udf3> 
  
 O 
 255 
 user free field 3. If sent by the Merchant 
 
<udf4> 
  
 O 
 255 
 user free field 4. If sent by the Merchant 
 
<udf5> 
  
 O 
 255 
 user free field 5. If sent by the Merchant 
 
<eci> 
  
 O 
 2 
 3D-Secure Electronic commerce indicator 
 
<cavv> 
  
 O 
 40 
 3D-Secure Cardholder authentication verification value 
 
<xid> 
  
 O 
 40 
 3D-Secure XID value 
 
<liability> 
  
 M 
 1 
 Liability Shift indicator 
 
<riskLevel> 
  
 C 
 20 
 Risk Level (“GREEN”/”YELLOW”/”RED”) – Only if and terminal is Smash enabled. 
 
<riskThreshold> 
  
 C 
 4 
 Risk treshold (score that defines the borderline between GREEN and YELLOW zones) – Only if terminal is Smash enabled 
 
<riskScore> 
  
 C 
 4 
 Risk score – Only if terminal is Smash enabled. 
 
<riskMaxScore> 
  
 C 
 4 
 Max Risk Score for the risk policy that assessed the transaction (sum of “scoreConfigured” values returned by SMASH) – Only if terminal is Smash enabled. 
 
<rows> 
  
 C 
 2 
 Number of transaction data rows 
 
<row> 
  
  
  
 [1..n] <row> tags with order’s transaction data 
 
 
 <action> 
  
 2 
 Action code 
 
 
 <tranid> 
  
 20 
 Transaction ID 
 
 
 <msgDateTime> 
  
 24 
 Message creation date/time, in UTC format 
 
 
 <amt> 
  
 10.2 
 Transaction’s amount 
 
 
 <result> 
  
 20 
 Transaction result 
 
 
 <auth> 
  
 20 
 Authorization Code 
 
 
 <cardtype> 
  
 10 
 Brand Id (Visa, MasterCard, AMEX,...) 
 
 
  <responsecode> 
  
 3 
 Host Response Code. 
 
 
 <ref> 
  
 20 
 Authorization system reference number.  
 
 
 <udf1> 
  
 255 
 user free field 1. If sent by the Merchant 
 
 
 <udf2> 
  
 255 
 user free field 2. If sent by the Merchant 
 
 
 <udf3> 
  
 255 
 user free field 3. If sent by the Merchant 
 
 
 <udf4> 
  
 255 
 user free field 4. If sent by the Merchant 
 
 
 <udf5> 
  
 255 
 user free field 5. If sent by the Merchant 
 
<msgVerifier> 
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
msgName + version + msgDateTime + paymentid + amt + trackid + udf1 + SECRET KEY +  udf5 
 


 
  MOTO transactions 
Introduction 
IPG provides a service for managing payment transactions with credit cards obtained as a result of sales made by mail or through call centers. This chapter describes necessary merchant activities to integrate with IPG in case of MOTO payment transaction processing. 
The Buyer perspective 
To make a purchase, the Buyer: 
•
 Chooses products 

•
 Creates an order, including card details and sends it to the merchant by email or through the call center. 

•
 Receives an e-mail message notification of payment, if the setting is enabled by the Merchant, to be used as a virtual receipt 


The Merchant perspective 
The Merchant receives a purchase order from the Buyer and: 
•
 Sends a payment request message (TransactionRequest) to the IPG 

•
 Receives a response message (TransactionResponse) with transaction result from IPG 

•
 Presents the result to the Buyer 

•
 Receives an e-mail message notification of payment, if the setting is enabled by the Merchant, to be used as a virtual receipt 


The IPG perspective 
IPG receives a payment request (TransactionRequest) from the Merchant and: 
•
 Processes the transaction by sending the request to the credit card company authorisation systems and gets a response 

•
 Sends to the merchant a response message (TransactionResponse) with the transaction result 

•
 Sends an e-mail message notification of payment to the Buyer and / or the Merchant (if the setting is enabled by the Merchant) to be used as virtual receipt. 


Merchant Integration 
Introduction 
IPG includes the presence of some direct communications with the Merchant server to complete 
the transactions. This exchange of messages can be implemented in two ways: 
•
 through the installation of a special plug-in 

•
 by creating their own communication interface 


 
The plug-in is easy to integrate and is compatible with all sites developed in Java, C/C++, ColdFusion, ActiveX/COM, VB, ASP, .NET. 
 
If it is not possible or desirable to use the plug-in (e.g. because it is not compatible with the 
technological platform, or the site is published via an external provider in shared hosting) it is 
always possible, according to the specifications provided, to create your own communication 
interface. 
 
 
Messages between the merchant site and IPG 
Message Verifier 
All messages exchanged between Merchant Site and IPG are signed using Message Verifier (msgVerifier) which is dynamically composed of specific message data (see bellow message specifications). 
Steps for Message Verifier generation are: 
a) Concatenate specified message data to create Message Verifier string; 
b) Remove spaces; 
c) Hash the string created in previous step using SHA256 algorithm. 
Example of Message Verifier creation for PaymentInit request message - 
Message data 
 Value 
 
msgName 
 PaymentInitRequest 
 
version 
 1 
 
id 
 89110001 
 
password 
 test1234 
 
amt 
 15.00 
 
trackid 
 CTV-TEST-PureBuy-1 
 
udf1 
 AA 
 
SECRET KEY 
 YXKZPOQ9RRLGPDED5D3PC5BJ 
 
udf5 
 EE 
 


 
a) Concatenate msgName, version, id, password, amt, trackid, udf1, SECRET KEY and udf5: 
PaymentInitRequest 1 89110001 test1234 15.00 CTV-TEST-PureBuy-1 AA YXKZPOQ9RRLGPDED5D3PC5BJ EE 
 
 
PaymentInitRequest189110001test123415.00CTV-TEST-PureBuy-1AAYXKZPOQ9RRLGPDED5D3PC5BJEE 
 
c) Hash of step (b) value using SHA256 algorithm 
 
b3a54617d2e9acd9079d85ea15d066a5892e3cabe1b41da4891b3a65ffaa0cce 
 
Payment Request 
This message (TransactionRequest) is sent by the Merchant to IPG to start a transaction. It uses the following items:> 
<Request> 
 
1st 
levTag 
 2nd 
levTag 
 3rd 
lev Tag 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
  
 M 
 30 
 “TransactionRequest” 
 
<version> 
  
  
 M 
 8 
 “1” (integer) 
 
<id> 
  
  
 M 
 8 
 tranPortalID 
 
<password> 
  
  
 M 
 16 
 tranPortal pwd 
 
<payinst> 
  
  
 O 
 20 
 fixed: "CC" 
 
<action> 
  
  
 M 
 2 
 action code: 1 or 4 
 
<currencycode> 
  
  
 M 
 3 
 currency code 
 
<amt> 
  
  
 M 
 10.2 
 nnnnnnnnnn.nn 
 
<trackid> 
  
  
 M 
 255 
 Merchant TrackId 
 
<member> 
  
  
 C 
 384 
 cardholder name - Mandatory if recurAction = “” or recurAction = “activation” 
 
<addr> 
  
  
 O 
 255 
 cardholder address 
 
<zip> 
  
  
 O 
 20 
 cardholder postal code 
 
<card> 
  
  
 C 
 19 
 card number – Mandatory if recurAction = “” or recurAction = “activation” 
 
<cvv2> 
  
  
 O 
 4 
 card security code. Could be mandatory for some merchants 
 
<expYear> 
  
  
 C 
 4 
 card expiration year - Mandatory if recurAction = “” or recurAction = “activation” 
 
<expMonth> 
  
  
 C 
 2 
 card expiration month - Mandatory if recurAction = “” or recurAction = “activation” 
 
<eci> 
  
  
 O 
 2 
 3DS ECI value. Only used by ECSEC merchants 
 
<xid> 
  
  
 O 
 40 
 3DS XID value. Only used by ECSEC merchants 
 
<cavv> 
  
  
 O 
 40 
 3DS CAVV value. Only used by ECSEC merchants 
 
<clientIPAddress> 
  
  
 O 
 25 
 buyer browser IP Address. Only used by ECSEC merchants 
 
<clientUserAgent> 
  
  
 O 
 512 
 buyer browser user agent string. Only used by ECSEC merchants 
 
<clientHTTPHeaders> 
  
  
 O 
 2048 
 buyer browser http headers values. Only used by ECSEC merchants 
 
<langid> 
  
  
 O 
 3 
 language used by the buyer on merch. Website. Only used by ECSEC merchants 
 
<buyerUserId> 
  
  
 O 
 50 
 UserId with which the buyer is registered at the merchant web site. Only used by ECSEC merchants 
 
<recurAction> 
  
  
 M 
 10 
 Possible Values (case insensitive): 
“activation” – the Merchant requires a new Recurring Payment to be activated 
“merchant_initiated” – a following transaction on an active recurring payment is requested 
“delete” – a recurring payment cancellation is requested 
“” – indicates a normal s2s transaction 
 


<recurContractID> 
  
  
 O 
 30 
 Optional information to collect the Recurring Payment Contract Identifier (only if recurAction=”activation”, otherwise ignored). 
 
<pymnDscr> 
  
  
 O 
 255 
 Recurring Payment description 
 
<recurid> 
  
  
 C 
 20 
 RecurID: Mandatory if recurAction= “merchant_initiated” or ”delete”, otherwise ignored 
 
<recurNewCardExpDate> 
  
  
 O 
 6 
 Rec.Pymn. new card expiration date (format YYYYMM) – Considered if recurAction=“merchant_initiated”, otherwise ignored 
 
<bankStmtFreeText> 
  
  
 O 
 50 
 Free Text that will be forwarded to Auth System in p127, in order to be printed on bank account statement (replaces “B24POSFTEXT” special value in UDF1) 
 
<udf1> 
  
  
 O 
 255 
 user free field 1 
 
<udf2> 
  
  
 O 
 255 
 user free field 2 
 
<udf3> 
  
  
 O 
 255 
 user free field 3 
 
<udf4> 
  
  
 O 
 255 
 user free field 4 
 
<udf5> 
  
  
 O 
 255 
 user free field 5 
 
<buyerFirstName> 
  
  
 O 
 50 
 Buyer first name 
 
<buyerLastName> 
  
  
 O 
 50 
 Buyer last name 
 
<buyerPhoneNumber> 
  
  
 O 
 20 
 Buyer phone number 
 
<buyerEmailAddress> 
  
  
 O 
 255 
 Buyer email address 
 
<cartContent> 
  
  
 O 
  
 Order content. 
 
 
 <item> 
  
 C 
  
 [1..n] <item> tags if <cartContent> is present 
 
 
  
 <productId> 
 M 
 30 
 product identifier 
 
 
  
 <productDesc> 
 O 
 255 
 product description 
 
 
  
 <qty> 
 M 
 8 
 product quantity in the cart 
 
 
  
 <singlePrice> 
 M 
 10.2 
 product single price  
 
<shippingInfo> 
  
  
 O 
  
 Shipping details 
 
 
 <recipientFirstName> 
  
 C 
 50 
 Recipient First Name. Mandatory if <shippingInfo> is present. 
 
 
 <recipientLastName> 
  
 C 
 50 
 Recipient Last Name. Mandatory if <shippingInfo> is present. 
 
 
 <recipientPhoneNumber> 
  
 O 
 20 
 Recipient Phone Number. 
 
 
 <ShippingAddress> 
  
 C 
  
 Shipping Address. Mandatory if <shippingInfo> is present 
 
 
  
 <country> 
 C 
 3 
 Shipping Country. Mandatory if <buyerShippingAddress> is present. ISO 3166-1 (Alpha 3) format required. 
 
 
  
 <city> 
 C 
 40 
 Shipping City. Mandatory if <buyerShippingAddress> is present 
 
 
  
 <zip> 
 C 
 20 
 Shipping Postal Code. Mandatory if <buyerShippingAddress> is present 
 
 
  
 <addrLine1> 
 C 
 100 
 Shipping Address Line 1 (Street name, number). Mandatory if <buyerShippingAddress> is present 
 
 
  
 <addrLine2> 
 O 
 100 
 Shipping Address Line 2 (apt number, suite, etc) 
 
 
  
 <addrLine3> 
 O 
 40 
 Shipping Address Line 3 (all info not containable in first 2 lines) 
 
<billingInfo> 
  
  
 O 
  
 Billing details 
 


 
 <billingFirstName> 
  
 C 
 50 
 First name of the billed person. Mandatory if <billingInfo> is present 
 
 
 <billingLastName> 
  
 C 
 50 
 Last name of the billed person. Mandatory if <billingInfo> is present 
 
 
 <billingAddress> 
  
 C 
  
 Billing Address. Mandatory if <billingInfo> is present  
 
 
  
 <country> 
 C 
 3 
 Billing Country. Mandatory if <billingAddress> is present. ISO 3166-1 (Alpha 3) format required. 
 
 
  
 <city> 
 C 
 40 
 Billing City. Mandatory if <billingAddress> is present 
 
 
  
 <zip> 
 C 
 20 
 Billing Postal Code. Mandatory if <billingAddress> is present 
 
 
  
 <addrLine1> 
 C 
 100 
 Billing Address Line 1 (Street name, number). Mandatory if <billingAddress> is present 
 
 
  
 <addrLine2> 
 O 
 100 
 Billing Address Line 2 (Street name, number) 
 
 
  
 <addrLine3> 
 O 
 40 
 Billing Address Line 3 (all info not containable in first 2 lines) 
 
<msgVerifier> 
  
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
msgName + version + id + password + recurid + amt + trackid + udf1 + SECRET KEY + udf5 
 


 
Payment response 
After payment processing, IPG sends this message (TransactionResponse) to inform the Merchant of the transaction result (if it has been processed) or the error reason (if it has not been processed). Payment response message has the following structure: 
<Response> 
  
  
  
 contains an attribute “type” whose value can be: “valid” or “error” 
 
1st 
levTag 
 Response 
Type 
 Mand. 
 Max 
Size 
 Description 
 
<msgName> 
  
 M 
 30 
 “TransactionResponse” 
 
<version> 
  
 M 
 8 
 “1” (integer) 
 
<msgDateTime> 
  
 M 
 24 
 Message creation date/time, in UTC format 
 
<tranID> 
 valid 
 M 
 20 
 TransactionID. 
 
<action> 
 valid 
 M 
 2 
 action code. 
 
<payinst> 
 valid 
 M 
 20 
 payment instrument used for the transaction. 
 
<result> 
 valid 
 M 
 20 
 Transaction result. 
 
<auth> 
 valid 
 M 
 35 
 Auth code. 
 
<currencycode> 
 valid 
 M 
 3 
 Currency code. 
 
<amt> 
 valid 
 M 
 10.2 
 nnnnnnnnnn.nn. 
 
<trackid> 
 valid 
 M 
 255 
 Merchant TrackId. 
 
<ref> 
 valid 
 M 
 20 
 Auth system ref number. Mandatory if payinst = “CC”/”VPAS” /"IP"/”MPASS” 
 
<responsecode> 
 valid 
 M 
 3 
 Host Response Code. Mandatory if payinst = “CC”/”VPAS” /"IP"/”MPASS” 
 
<cardtype> 
 valid 
 M 
 10 
 brand Id.  
 
<recurid> 
 valid 
 C 
 20 
 Recurring Payment identifier. Only if Merchant specified in the request: 
 


- <recurAction>=”activation” (in this case, it’s the RecurID of a newly generated recurring payment) 
- <recurAction>=”merchant_initiated”, “delete” (in this case, it’s the RecurID provided by the Merchant in the rec. payment instance request).  
 
<expDate> 
 valid 
 M 
 6 
 Card expiry date 
 
<cardLastFourDigits> 
 valid 
 M 
 4 
 Card last 4 digits 
 
<recurContractID> 
 valid 
 C 
 30 
 Recurring Payments Contract Identifier indicated by the Merchant in the request. 
 
<recurNewCardExpDate> 
 valid 
 C 
 6 
 If a new card expiration date is successfully used for a recurring payment instance, the new exp date is reported to the merchant. 
 
<cardCountry> 
 valid 
 M 
 2 
 card country.  
 
<udf1> 
 valid 
 O 
 255 
 user free field 1 - Only if Merchant sent it in the request 
 
<udf2> 
 valid 
 O 
 255 
 user free field 2 - Only if Merchant sent it in the request 
 
<udf3> 
 valid 
 O 
 255 
 user free field 3 - Only if Merchant sent it in the request 
 
<udf4> 
 valid 
 O 
 255 
 user free field 4 - Only if Merchant sent it in the request 
 
<udf5> 
 valid 
 O 
 255 
 user free field 5 - Only if Merchant sent it in the request 
 
<riskLevel> 
 valid 
 C 
 20 
 Risk Level (“GREEN”/”YELLOW”/”RED”) – Only if terminal is Smash enabled. 
 
<riskThreshold> 
 valid 
 C 
 4 
 Risk threshold (score that defines the borderline between GREEN and YELLOW zones) – Only if terminal is Smash enabled 
 
<riskScore> 
 valid 
 C 
 4 
 Risk score – Only if terminal is Smash enabled. 
 
<riskMaxScore> 
 valid 
 C 
 4 
 Max Risk Score for the risk policy that assessed the transaction (sum of “scoreConfigured” values returned by SMASH) – Only if terminal is Smash enabled. 
 
<errorCode> 
 error 
 M 
 20 
 Error Code returned by IPG. 
 
<errorService> 
 error 
 M 
 30 
 Error Service returned by IPG. 
 
<errorDesc> 
 error 
 M 
 256 
 Error Description returned by IPG. 
 
<msgVerifier> 
  
 M 
 50 
 Salted hash of some fields of this message plus a secret shared key – Hash algorithm: SHA-2 (256).  
String to hash in this exact order (only fields values, not tags): 
1)
 If type=”valid”: msgName + version + msgDateTime + tranid + amt + trackid + udf1 + SECRET KEY + udf5 

2)
 If type=”error”: msgName + version + msgDateTime + errorCode + SECRET KEY + errorDesc 


 
IMP.: Considerations reported at REQ11 of par. 4.1 apply 
 


 
 
 
 
  
  Plug-in interface specifications 
Plug-in is a application module/library which provides integration implementation directly to the merchant. In this way, the developer skips low level integration and works directly with the provided IPG API.  
There are two plug-in APIs provided:  
•
 Java API for integration with java based merchant applications 

•
 DLL API for integration with Windows based merchant application 


Java plugin 
Java Plug-in implementation is provided through the ipg-java-plugin-src-1.x.x.jar file. This file is part of every distribution of IPGDemoPlugin simulator in a following file: IPGDemoPluginServer.zip -> IPGDemoPlugin.war -> WEB-INF/lib/ipg-java-plugin-src-1.0.3.jar.  

• Java Plug-in API is provided with the following interface: rs.asoft.ipg.plugin.service. IPGPaymentService. 1.
 Presents all internet payment methods provided by IPG server. In order to choose optimal integration approach, it is essential to understand all the integration options. 

2.
 Provides ipgdemo.log file with detailed logging description of each action when simulating internet payments. Merchant developers should use it to understand what parameters and data are necessary to be provided for a successful communication with the IPG server. 

3.
 IPGDemoPluginServer.zip -> IPGDemoPlugin.war file demonstrates an example of the deployment package necessary to integrate with the IPG server.   

4.
 IPGDemoPluginServer.zip -> IPGDemoPlugin.war -> IPGDemoPlugin-src-1.*.jar contains all Java classes necessary for the Merchant to develop in order to fully integrate with the IPG server. 

5.
 IPGDemoPluginServer.zip -> IPGDemoPlugin.war -> ipg-java-plugin-src-1.*.*.jar contains Java plugin to be used out of box in order to speed up and simplify the integration 

6.
 If IPG Demo Plugin application is installed on the merchant host server, merchant developer will be able to compare the processing  between merchant and simulator implementation 





Java IPG Demo Plugin Simulator 
IPG Demo Plugin Simulator is the essential tool provided in order to simplify integration with the merchant site. The Java version of IPG Demo Plugin Simulator is provided via IPGDemoPluginServer.zip which is able to download via https://<ipgtesthost> /IPGDemoPlugin/demoPlugin.html?msgName=HelpRequest help page.  
IPGDemoPluginServier.zip contains simple Jetty server and IPG Demo Plugin client application. To run the IPG Demo Plugin simulator, it is enough to unzip the archive and double click IPGDemoPlugin.bat (if having issues please follow the Java installation steps on the help page).  
 
Use of IPG Demo Simulator has following benefits: 
.    
 
IPG Payment Service Factory 
Best way to create an instance of IPGPaymentService is via rs.asoft.ipg.plugin.service. IPGPaymentServiceFactory class by invoking IPGPaymentService getIPGPaymentService(int ipgClientType) method. Currently following IPG client types are supported: 
•
 int IPGPaymentServiceFactory.IPG_CLIENT_TYPE_GENERIC_XML = 1 – Default implementation for using custom XML protocol. 

•
 int IPGPaymentServiceFactory.IPG_CLIENT_TYPE_REST_XML = 2 – REST XML implementation 

•
 int IPGPaymentServiceFactory.IPG_CLIENT_TYPE_REST_JSON = 3 – REST Json implementation 


 
Example: In order to create IPG Generic XML instance following code is to be used: 
int ipgClientType = IPG_CLIENT_TYPE_GENERIC_XML; 
IPGPaymentService ipgPaymentService = IPGPaymentServiceFactory.getIPGPaymentService(ipgClientType); 
IPG Logger Interface 
The default logging implementation is rs.asoft.ipg.plugin.service.IPGLoggerLog4jImpl class as a logging wrapper around Log4j implementation.  
In order to substitute logging implementation create a new implementation by extending rs.asoft.ipg.plugin.service.IPGLogger and use logger following method of IPGPaymentServiceFactory class: 
IPGPaymentService ipgPaymentService = IPGPaymentServiceFactory.getIPGPaymentService(ipgClientType, ipgLogger); 
 
 
IPG Payment Service Interface 
The Java plugin API - IPGPaymentService functions provides main IPG business functions.  The functions are divided in the following groups: 
 
•
  Setup methods – to substitute following IPG Payment Service client modules: 

a)
 void setHttpSender(HttpSender httpSender) – communication with IPG server 

b)
 void setIPGXmlParser(IPGXmlParser ipgXmlParser) – parsing of XML request and response messages (applicable only in case of IPG_CLIENT_TYPE_GENERIC_XML) 


 
•
 3DSecure methods – provides methods to invoke when integrating with standard 3DSecure payment transactions (Cardholder data collected on the IPG server): 

a)
 PaymentInitResponse sendPaymentInitRequest(PaymentInitRequest) – to start 3DSecure payment transaction with IPG server 

b)
 byte[] procesNotificationXmlRequest(String secretKey, byte[] xmlBytes, NotificationUrlBulder notificationUrlBulder) – utility function to parse XML Notification Request submitted by IPG server and create Notification Response XML bytes. 

c)
 byte[] procesNotificationFormRequest(String secretKey, Map requestParameters, NotificationUrlBulder notificationUrlBulder) – utility function to parse HTTP  Notification Request submitted by IPG server and create Notification Response URL bytes 

d)
 byte[] procesNotificationJsonRequest(String secretKey, byte[] jsonBytes, NotificationUrlBulder notificationUrlBulder) – utility function to parse JSON  Notification Request submitted by IPG server and create Notification Response JSON bytes 


 
•
 VI3DSecure methods – provides methods to invoke when integrating with standard 3DSecure payment transactions(Cardholder data collected on the Merchant PCI Compliant server): : 

a)
 TransactionVI3DSResponse sendTransactionVI3DSVerifyEnrollment(TransactionVI3DSVEReqRequest) – to start 3DSecure payment transaction with IPG server 

b)
 TransactionVI3DSResponse sendTransactionVI3DSPARes(TransactionVI3DSPAResRequest) – to finish 3DSecure payment transaction with IPG server 


 
•
 MOTO (Mail Order / Telephone Order) method – provides method to submit MOTO transaction (Cardholder data collected on the Merchant PCI Compliant server): 

a)
 TransactionResponse sendTransactionRequest(TransactionRequest) ) – to process MOTO transaction on IPG server 


 
•
 Financial method – provides method to submit Financial transaction (CREDIT, VOID_PURCHASE, CAPTURE, VOID_CREDIT, VOID_CAPTURE, VOID_AUTHORIZATION, GAMING_PAYMENT): 

a)
 FinancialResponse sendFinancialRequest(FinancialRequest financialRequest) ) – to process Financial transaction on IPG server 


 
•
 Batch method – provides method to submit MOTO transactions via a batch file (Cardholder data collected on the Merchant PCI Compliant server): 

b)
 BatchResponse sendBatchFileRequest(BatchFileRequest) to process MOTO transactions on IPG server, provided in the Batch file 


 
DLL plugin 
Windows DLL Plug-in implementation is provided through the IPGPaymentService.dll and IPGPaymentService.tlb files. These files are part of the IPGDemoPlugin simulator – Windows IIS version.  
If you wish to receive the files, please submit the request to the IPG support contact.   
 
  Direct interface specifications 
If you don‘t have a suitable platform to use plug-in or want to create your own interface, all information on the communication protocol, the transmission and reception of the message formats, their variables and error messages are listed below. 
 
Communication protocol specifications 
•
 Target (action): 


- in a test environment 
<TestEnvironment_IP_address>/IPGWeb/servlet/IPGPaymentXMLServlet 
 
Note: Test environment IP address will be communicated to you via e-mail. 
 
- in a production environment 
<Production_IP_address>/IPGWeb/servlet/PaymentInitHTTPServlet 
•
 Method: POST 

•
 Content-Type: “application/xml” 


Data transmission format 
Examples of messages sent by Merchant to IPG: 
 
PaymentInit Message 
<request> 
  <msgName>PaymentInitRequest</msgName> 
  <version>1</version> 
  <id>89110001</id> 
  <password>test1234</password> 
  <langId>USA</langId> 
  <buyerFirstName /> 
  <buyerLastName /> 
  <buyerUserId /> 
  <buyerPhoneNumber /> 
  <buyerEmailAddress /> 
  <clientIpAddress /> 
  <clientUserAgent /> 
  <clientHttpHeaders /> 
  <action>1</action> 
  <recurAction /> 
  <recurContractId>RECURCNTRID-12345</recurContractId> 
  <amt>12.35</amt> 
  <payinst /> 
  <currencycode>978</currencycode> 
  <trackid>CTV-TEST-PureBuy-1</trackid> 
  <responseURL>http://192.168.100.104:8080/IPGDemoPlugin/paymentNotification.html</responseURL> 
  <errorURL>http://192.168.100.104:8080/IPGDemoPlugin/paymentError.html</errorURL> 
  <cardSHA2>Y</cardSHA2> 
  <paymentTimeout>30</paymentTimeout> 
  <bankStmtFreeText /> 
  <pymnDscr /> 
  <instructedFees /> 
  <notificationFormat>xml</notificationFormat> 
  <paymentPageMode>0</paymentPageMode> 
  <udf1>AA</udf1> 
  <udf2>BB</udf2> 
  <udf3>CC</udf3> 
  <udf4>DD</udf4> 
  <udf5>EE</udf5> 
<msgVerifier>i/CFOYVGoVdNrAg+AdqnMav4QDv6WhXBJlirRTiU5yY=</msgVerifier> 
</request> 
 
Payment Message 
<request> 
  <msgName>FinancialRequest</msgName> 
  <version>1</version> 
  <id>89110001</id> 
  <password>test1234</password> 
  <action>2</action> 
  <amt>1.00</amt> 
  <currencycode>978</currencycode> 
  <trackid>A1B2C3</trackid> 
  <tranid>666311898221172199</tranid> 
  <udf1>AA</udf1> 
  <udf2>BB</udf2> 
  <udf3>CC</udf3> 
  <udf4>DD</udf4> 
  <udf5>EE</udf5> 
  <msgVerifier>FJcbvZ5VE0grZgaOHsh6N+apgEl2yS+v5gksMhMMYCI=</msgVerifier> 
</request> 
Data reception format 
Examples of messages sent by IPG to Merchant: 
 
PaymentInit Response: 
<response type="valid"> 
<msgName>PaymentInitResponse</msgName> 
<version>1</version> 
<msgDateTime>2017-08-07 10:49:01.788</msgDateTime> 
<paymentid>490861957491072190</paymentid> 
<browserRedirectionURL>http://ipg-test:9080/IPGWeb/servlet/PaymentSelection.html</browserRedirectionURL> 
<msgVerifier>K5s0L0+Fpm2C6bvt4Own9ExH0cC82083I23B+mxcEMA=</msgVerifier> 
</response> 
 
Payment Response: 
<response type="valid"> 
<msgName>FinancialResponse</msgName> 
<version>1</version> 
<msgDateTime>2017-08-07 11:23:15.260</msgDateTime> 
<paymentid>375113018221172196</paymentid> 
<action>2</action> 
<currencycode>978</currencycode> 
<amt>5.00</amt> 
<payinst>CC</payinst> 
<cardtype>VISA</cardtype> 
<expdate>203603</expdate> 
<cardlastfourdigits>0004</cardlastfourdigits> 
<result>CAPTURED</result> 
<auth>720479</auth> 
<ref>721911012683</ref> 
<responsecode>00</responsecode> 
<tranid>596343336231172190</tranid> 
<trackid>A1B2C3</trackid> 
<udf1>AA</udf1> 
<udf2>BB</udf2> 
<udf3>CC</udf3> 
<udf4>DD</udf4> 
<udf5>EE</udf5> 
<msgVerifier>MZTL7EJNe3Xsk0qgNPkJJpZaU89K1XotD23AyIsZGUY=</msgVerifier> 
</response> 
 
 
  IPG Demo Plugin 
For better understanding of merchant integration, the IPG Demo Plugin is available. It simulates messages exchanging between merchant server and payment gateway server. Additional technical information are provided through online log which is presented during the plugin is running. Detailed instruction for how to use IPG Demo Plugin are provided in AsoftIPG Transactions User Guide.  
To activate IPG Demo Plugin: 
1.
 access to IPG simulator’s URL address (the address will be provided by Bank’s contact person); 

2.
 Open Help menu; 

3.
 Download IPG Demo Plugin; 

4.
 Unzip the IPGDemoPluginServer.zip file; 

5.
 Update the value of the parameter "webapp.address" in ipgDemoPluginCfg.properties file (replace <merchantsiteurl> with your public IP address); 

6.
 Run IPGDemoPlugin.bat file. 


 
The IPG Demo log provides a detailed insight into the correct processing of the client application and demonstration of an optimal integration method.  
 
For better understanding the procedure of generating Message Verifier (MsgVerifier) fields, do the following: 
1. Perform payment transaction using IPG Demo application with predefined parameters; 
2. Search for “Message Verifier Base loaded, messageVerifierBase:..” row in IPG Demo log file to see how looks like MsgVerifier string for the transaction preformed in previous step; 
3. Inspect method IPGDemoPluginServer.zip -> IPGDemoPlugin.war -> WEB-INF/lib/ipg-java-plugin-src-1.0.3.jar -> rs.asoft.ipg.plugin.service.IPGPaymentServiceSupport.generateMessageVerifier  to consider the way of Message Verifier generating using SHA256 algorithm; 
4. Inspect method IPGDemoPluginServer.zip -> IPGDemoPlugin.war -> WEB-INF/lib/ipg-java-plugin-src-1.0.3.jar -> rs.asoft.ipg.plugin.model.PaymentInitRequest -> PaymentInitRequest.getMessageVerifierBase()  to consider the way of Message Verifier for PaymentInit message generating. 
  Test environment 
IPG provides a test environment where the Merchant can freely perform transactions to properly 
prepare the interface for the transition into production. 
 
The test environment is always available, even if 24-hour availability cannot be guaranteed, as a 
result of corrective and evolutionary maintenance interventions that could make it temporarily 
unusable, without notice. 
 
Variables to be set for the creation of PaymentInit message 
If you use the plug-in, use the following URL for an IPG test connection: 
•
 <TestEnvironment_IP_address>/IPGDemoPlugin/demoPlugin.html 


 
If you are using direct interfacing, the full address to create the connection is as follows: 
•
 <TestEnvironment_IP_address>/IPGWeb/servlet/IPGPaymentXMLServlet 


 
The variables to be set in a fixed manner are the following: 
•
 Response URL: <TestEnvironment_IP_address>/IPGDemoPlugin/paymentNotification.html 

•
 Error URL: <TestEnvironment_IP_address>/IPGDemoPlugin/paymentError.html 


 
Note: Test environment IP address and Secret Key will be communicated to you via e-mail. 
 
Other parameters can be defined freely. 
 
Mandatory test cases 
It is mandatory to perform the following tests, which are the most frequent real case 
studies, before sending the confirmation of the end of the test to Customer support and then 
requesting the transition into production. 
 
Test case n°1 – Successful e-commerce transaction 
 
Create and submit PaymentInit message. 
 
Once the HPP is displayed, use the following card: 
Terminal ID 
 Terminal password 
 Card Number 
 Expiry 
 CVV2 
 
89110001 
 test1234 
 4012001037141112 
 Any future date 
 Any 3-digits number 
 


 
Check that: 
•
 the PaymentNotificationRequest message has been received correctly with all the required fields (paymentid, tranid, trackid, msgDateTime, result, currencycode, amt, auth, udf1, udf2, udf3, udf4, udf5, cardtype, payinst, liability, responsecode). 

•
 the transaction is successful (result = "APPROVED" if you used Action = 4, or 


"CAPTURED" if you used Action = 1) 
•
 The browser has been re-directed properly to the address provided in the PaymentNotificationResponse message. 


 
 
 
Test case n°2 – Transaction not authorized 
 
Create and submit PaymentInit message. 
 
Once the HPP is displayed, use the following card: 
 
Terminal ID 
 Terminal password 
 Card Number 
 Expiry 
 CVV2 
 
89110001 
 test1234 
 4539990000000020 
 Any future date 
 Any 3-digits number 
 


 
Check that: 
•
 the PaymentNotificationRequest message has been received correctly with all the required fields (result = NOT CAPTURED; responsecode = 51) 

•
 The browser has been re-directed properly to the address provided in  


the PaymentNotificationResponse message. 
 
Test case n°3 – Transaction canceled by buyer 
 
Create and submit PaymentInit message. 
 
Once the HPP is displayed, press ‘Cancel’ button. 
 
Check that: 
•
 the PaymentNotificationRequest message has been received correctly with all the required fields (PaymentID, errorCode, errorService, errorDesc) 

•
 the “errorCode” field shows “PY20090” and the “errorDesc” field contains the error 


description “Customer canceled transaction” 
•
 The browser has been re-directed properly to the address provided in  


the PaymentNotificationResponse message. 
 
Test case n°4 – Financial operations 
 
Repeat test case n°1 and memorize Transaction ID contained in Notification message. 
 
Create Payment Request message:  
•
 insert Transaction ID memorized in previous step 

•
 specify appropriate action type (2- Credit or 3-Purchase Reversal if original transaction was 1-Purchase, or, 5-Capture or 9-Preauthorization Void if original transaction was 4-Preauthorization). 


 
Submit Payment Request message. 
 
Check that: 
•
 the PaymentNotificationRequest message has been received correctly with all required fields (paymentid, tranid, trackid, msgDateTime, result, currencycode, amt, auth, udf1, udf2, udf3, udf4, udf5, cardtype, payinst, liability, responsecode). 

•
 the transaction is successful (ResultCode = "CAPTURED" if you used Action = 2 and 5, or 


"VOIDED" if you used Action = 3 and 9) 
•
 The browser has been re-directed properly to the address provided in  


the PaymentNotificationResponse message. 
 
 
Note: Repeat test case for various financial operation (Credit, Purchase Reversal, Capture and Preauthorization Void). 
  HPP Customization 
The Hosted Payment Page presented by IPG to the Buyer can be customized by the Merchant. 
Without customization, the HPP is proposed with the standard graphics and layout prepared by 
the bank. 
 
The Merchant can apply customization autonomously using the specific features on the Back Office site that allow you to: 
•
 Select one of the two graphic templates available, one developed vertically ("Layout1"), and the other horizontally ("Layout2"); 

•
 Vary the number of graphics settings (background colors, text, and button colour; font, borders and backgrounds of the input fields, thickness, color and curvature of the form borders, thickness and curvature of the buttons, etc.); 

•
 Upload an image (banner, logo etc.), and specify its position (template #1 only) 

•
 Set up a line of text with business reference data or another message for users (template #1 only) 

•
 Upload a background image, specifying the position of the screen and any repetition, and set the degree of transparency of the form to see the background beneath it. 


 
Any change is displayed in real time in a sample HPP ("sample page") that is active while using the 
customization features, while it has no effect on the actual production page. 
 
A "Save" button, when clicked, makes sure that the changes are made immediately to the production HPP, unless the bank has requested an approval process. In this case: 
•
 The "Save" button only implies saving changes to the Sample Page (to resume work at a later time); 

•
 On completion of work, the "Submit for Approval" button appears to submit the customization for approval by the bank. Customization is then Pending until approved by the bank. In this status, the customization is "frozen" and cannot be modified further until the decision of the bank; 

•
 At the time of the decision: 


a. The Merchant receives a notification on the Home Page by the Back Office bearing this decision. In case of refusal, the reason shall also be given. The Merchant also receives the notification by email; 
b. If the decision is successful, the customization automatically becomes operational. No action is required by the Merchant. 
c. In any case, the customization is unlocked and can be changed again 
 
The Merchant can update their customization when appropriate without limitation. This allows the 
application of temporary customizations for specific promotional campaigns or other business 
needs. 
 
It is also possible to cancel the customization (using "Revert"). In this case, the Buyers see 
the HPP with the standard graphics as set by the bank 
 
For full details on the customization features available and how they work, see the User Manual 
for the Back Office, which is supplied upon service activation. 
 
Examples of Layout1 and Layout2 
 

Customization on Smartphones and Tablets 
The HPP is carried out using responsive technology. This means that the display is optimal even 
for users making payments using their smartphone or tablet, and the customization applied is 
accurately reflected on these devices without any additional activities. 
 
For smartphones, it is important to note that IPG will always display Layout1 (the vertical model) 
regardless of the layout chosen by the Merchant (this choice has value for users using desktop or 
tablet devices). It is recommended, therefore, to always complete the customization of both 
layouts. 
 
 
 
 
 
 
 
 
Appendix A – Response Codes 
 
 
00 
 Approved or completed successfully 
 
01 
 Refer to card issuer 
 
02 
 Refer to special conditions for card issuer 
 
03 
 Invalid merchant 
 
04 
 Pick-up card 
 
05 
 Do not honor 
 
06 
 Error 
 
07 
 Pick-up card, special condition 
 
08 
 Honor with identification 
 
09 
 Request in progress 
 
11 
 Approved (VIP) 
 
12 
 Invalid transaction 
 
13 
 Invalid amount 
 
14 
 Invalid card number (no such number) 
 
15 
 No such issuer 
 
30 
 Format error 
 
31 
 Bank not supported by switch 
 
33 
 Expired card 
 
34 
 Suspected fraud 
 
35 
 Card acceptor contact acquirer 
 
36 
 Restricted card 
 
37 
 Card acceptor call acquirer security 
 
38 
 Allowable PIN tries exceeded 
 
39 
 No credit account 
 
41 
 Lost card 
 
43 
 Stolen card, pick-up 
 
51 
 Not sufficient funds 
 
54 
 Expired card 
 
55 
 Incorrect personal identification number 
 
56 
 No card record 
 


57 
 Transaction not permitted to cardholder 
 
58 
 Transaction not permitted to terminal 
 
61 
 Exceeds withdrawal amount limit 
 
62 
 Restricted card 
 
65 
 Exceeds withdrawal frequency limit 
 
68 
 Response received too late 
 
75 
 Allowable number of PIN tries exceeded 
 
from 
76 to 
89 
 Reserved for private use 
 
90 
 Cut-off is in process, a switch is ending business for a day and 
starting the next (transaction can be sent again in a few minutes) 
 
91 
 Issuer or switch is inoperative 
 
92 
 Financial institution or intermediate network facility cannot be 
found for routing 
 
94 
 Duplicate transmission 
 
96 
 System malfunction 
 
from 
N0 
to R8 
 Reserved for private use
</file>

</repository_files>
</file>

<file path="class-novabankaipg.php">
<?php
/**
 * NovaBanka IPG33 Payment Gateway Integration
 *
 * @package    NovaBankaIPG
 * @author     Milovan Tatić
 * @copyright  Milovan Tatić
 * @license    Free for private use. Commercial use is not allowed without permission.
 *
 * @wordpress-plugin
 * Plugin Name: NovaBanka IPG33 Payment Gateway
 * Description: 3D Secure payment gateway integration for WooCommerce
 * Version:     1.0.1
 * Author:      Milovan Tatić
 * Text Domain: novabankaipg
 * Domain Path: /languages
 * Requires PHP: 7.4
 * WC requires at least: 5.0
 * WC tested up to: 8.0
 */

namespace NovaBankaIPG;

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

use NovaBankaIPG\Core\NovaBankaIPGGateway;
use NovaBankaIPG\Utils\APIHandler;
use NovaBankaIPG\Utils\Config;
use NovaBankaIPG\Utils\Logger;
use NovaBankaIPG\Utils\MessageHandler;
use NovaBankaIPG\Utils\SharedUtilities;
use NovaBankaIPG\Utils\ThreeDSHandler;
use NovaBankaIPG\Services\NotificationService;
use NovaBankaIPG\Services\PaymentService;

/**
 * Main plugin class for NovaBanka IPG33 Payment Gateway.
 *
 * Handles plugin initialization, component loading, and WooCommerce integration.
 *
 * @since 1.0.0
 */
class NovaBankaIPG {
	/**
	 * Singleton instance of the plugin.
	 *
	 * @var self|null
	 */
	private static $instance = null;

	/**
	 * Container for services.
	 *
	 * @var array
	 */
	private $container = array();

	/**
	 * Plugin version.
	 *
	 * @var string
	 */
	private const VERSION = '1.0.0';

	/**
	 * Plugin directory path.
	 *
	 * @var string
	 */
	private const PLUGIN_DIR = __DIR__;

	/**
	 * Plugin directory URL.
	 *
	 * @var string
	 */
	private const PLUGIN_URL = WP_PLUGIN_URL . '/novabanka-ipg';

	/**
	 * Get the singleton instance of the plugin.
	 *
	 * @return self The singleton instance.
	 */
	public static function instance(): self {
		if ( null === self::$instance ) {
			self::$instance = new self();
		}
		return self::$instance;
	}

	/**
	 * Constructor.
	 */
	private function __construct() {
		$this->define_constants();
		$this->init_autoloader();
		$this->init_container();
		$this->init_hooks();
	}

	/**
	 * Define plugin constants.
	 */
	private function define_constants(): void {
		if ( ! defined( 'NOVABANKAIPG_VERSION' ) ) {
			define( 'NOVABANKAIPG_VERSION', self::VERSION );
		}
		if ( ! defined( 'NOVABANKAIPG_PLUGIN_DIR' ) ) {
			define( 'NOVABANKAIPG_PLUGIN_DIR', self::PLUGIN_DIR );
		}
		if ( ! defined( 'NOVABANKAIPG_PLUGIN_URL' ) ) {
			define( 'NOVABANKAIPG_PLUGIN_URL', self::PLUGIN_URL );
		}
	}

	/**
	 * Initialize autoloader.
	 */
	private function init_autoloader(): void {
		spl_autoload_register( array( $this, 'autoload' ) );
	}

	/**
	 * Initialize container with all dependencies.
	 */
	private function init_container(): void {
		// Initialize basic utilities first.
		$this->container['logger']       = new Logger();

		// Get settings.
		$settings = Config::get_all_settings();

		// Initialize message handler.
		$this->container['message_handler'] = new MessageHandler(
			$settings['terminal_id'],
			$settings['terminal_password'],
			$settings['secret_key'],
			$this->container['logger']
		);

		// Initialize API handler with dependencies.
		$this->container['api_handler'] = new APIHandler(
			$settings['api_endpoint'] ?? '',
			$settings['terminal_id'] ?? '',
			$settings['terminal_password'] ?? '',
			$settings['secret_key'] ?? '',
			$this->container['logger'],
			$settings['test_mode'] ?? 'yes'
		);

		// Initialize services.
		$this->init_services();
	}

	/**
	 * Initialize services.
	 */
	private function init_services(): void {
		$this->container['payment_service'] = new PaymentService(
			$this->container['api_handler'],
			$this->container['message_handler'],
			$this->container['logger']
		);

		$this->container['notification_service'] = new NotificationService(
			$this->container['logger'],
			$this->container['message_handler']
		);
	}

	/**
	 * Initialize hooks.
	 */
	private function init_hooks(): void {
		// Check WooCommerce dependency.
		add_action( 'plugins_loaded', array( $this, 'check_dependencies' ) );

		// Initialize plugin after WooCommerce loads.
		add_action( 'woocommerce_init', array( $this, 'init_plugin' ) );

		// Register payment gateway.
		add_filter( 'woocommerce_payment_gateways', array( $this, 'add_gateway' ) );

		// Register scripts and styles.
		add_action( 'wp_enqueue_scripts', array( $this, 'register_scripts' ) );
		add_action( 'admin_enqueue_scripts', array( $this, 'register_admin_scripts' ) );

		// Handle API endpoints.
		add_action( 'woocommerce_api_novabankaipg', array( $this, 'handle_api_request' ) );

		// Add settings link to plugins page.
		add_filter(
			'plugin_action_links_' . plugin_basename( __FILE__ ),
			array( $this, 'add_settings_link' )
		);
	}

	/**
	 * Check plugin dependencies.
	 */
	public function check_dependencies(): void {
		if ( ! class_exists( 'WooCommerce' ) ) {
			add_action( 'admin_notices', array( $this, 'woocommerce_missing_notice' ) );
			return;
		}
	}

	/**
	 * Initialize the plugin.
	 */
	public function init_plugin(): void {
		load_plugin_textdomain(
			'novabanka-ipg-gateway',
			false,
			dirname( plugin_basename( __FILE__ ) ) . '/languages/'
		);
	}

	/**
	 * Add the gateway to WooCommerce.
	 *
	 * @param array $methods Existing payment methods.
	 * @return array Modified payment methods.
	 */
	public function add_gateway( array $methods ): array {
		$methods[] = NovaBankaIPGGateway::class;
		return $methods;
	}

	/**
	 * Register frontend scripts and styles.
	 */
	public function register_scripts(): void {
		if ( ! is_checkout() ) {
			return;
		}

		wp_enqueue_style(
			'novabankaipg-styles',
			NOVABANKAIPG_PLUGIN_URL . '/assets/css/ipg-styles.css',
			array(),
			NOVABANKAIPG_VERSION
		);

		wp_enqueue_script(
			'novabankaipg-scripts',
			NOVABANKAIPG_PLUGIN_URL . '/assets/js/ipg-scripts.js',
			array( 'jquery' ),
			NOVABANKAIPG_VERSION,
			true
		);

		// Add nonce for AJAX requests.
		wp_localize_script(
			'novabankaipg-scripts',
			'novabankaipg_params',
			array(
				'ajax_url' => admin_url( 'admin-ajax.php' ),
				'nonce'    => wp_create_nonce( 'novabankaipg-nonce' ),
			)
		);
	}

	/**
	 * Register admin scripts and styles.
	 *
	 * @param string $hook Current admin page hook.
	 */
	public function register_admin_scripts( string $hook ): void {
		if ( 'woocommerce_page_wc-settings' !== $hook ) {
			return;
		}

		wp_enqueue_style(
			'novabankaipg-admin',
			NOVABANKAIPG_PLUGIN_URL . '/assets/css/ipg-admin.css',
			array(),
			NOVABANKAIPG_VERSION
		);

		wp_enqueue_script(
			'novabankaipg-admin',
			NOVABANKAIPG_PLUGIN_URL . '/assets/js/ipg-admin.js',
			array( 'jquery' ),
			NOVABANKAIPG_VERSION,
			true
		);

		// Add nonce for admin AJAX requests.
		wp_localize_script(
			'novabankaipg-admin',
			'novabankaipg_admin_params',
			array(
				'ajax_url' => admin_url( 'admin-ajax.php' ),
				'nonce'    => wp_create_nonce( 'novabankaipg-admin-nonce' ),
			)
		);
	}

	/**
	 * Handle API requests.
	 */
	public function handle_api_request(): void {
		// Verify nonce for API requests.
		if ( ! check_ajax_referer( 'novabankaipg-nonce', 'nonce', false ) ) {
			wp_send_json_error( 'Invalid nonce.' );
			return;
		}

		// Sanitize and validate POST data.
		$post_data = array_map( 'sanitize_text_field', wp_unslash( $_POST ) );

		try {
			$this->container['notification_service']->handle_notification( $post_data );
			wp_send_json_success();
		} catch ( \Exception $e ) {
			$this->container['logger']->error( 'API request failed: ' . esc_html( $e->getMessage() ) );
			wp_send_json_error( esc_html( $e->getMessage() ) );
		}
	}

	/**
	 * Add settings link to plugin list.
	 *
	 * @param array $links Existing plugin links.
	 * @return array Modified plugin links.
	 */
	public function add_settings_link( array $links ): array {
		$settings_url  = admin_url( 'admin.php?page=wc-settings&tab=checkout&section=novabankaipg' );
		$settings_link = sprintf(
			'<a href="%s">%s</a>',
			esc_url( $settings_url ),
			esc_html__( 'Settings', 'novabanka-ipg-gateway' )
		);
		array_unshift( $links, $settings_link );
		return $links;
	}

	/**
	 * Display WooCommerce missing notice.
	 */
	public function woocommerce_missing_notice(): void {
		?>
		<div class="error">
			<p>
				<?php
				esc_html_e(
					'NovaBanka IPG requires WooCommerce to be installed and active.',
					'novabanka-ipg-gateway'
				);
				?>
			</p>
		</div>
		<?php
	}

	/**
	 * Autoloader for plugin classes.
	 *
	 * @param string $class_name Full class name.
	 */
	private function autoload( string $class_name ): void {
		// Only handle classes in our namespace.
		if ( 0 !== strpos( $class_name, 'NovaBankaIPG\\' ) ) {
			return;
		}

		// Convert class name to file path.
		$file_path = str_replace(
			array( 'NovaBankaIPG\\', '\\' ),
			array( '', DIRECTORY_SEPARATOR ),
			$class_name
		);

		// Convert to lowercase.
		$file_name = 'class-' . strtolower( basename( $file_path ) ) . '.php';
		$file_path = dirname( $file_path ) . DIRECTORY_SEPARATOR . $file_name;

		$file = NOVABANKAIPG_PLUGIN_DIR . '/includes/' . $file_path;

		if ( file_exists( $file ) ) {
			require_once $file;
		}
	}
}

// Initialize plugin.
add_action(
	'plugins_loaded',
	function () {
		NovaBankaIPG::instance();
	}
);
</file>

<file path="dev-class_responsibilities.md">
## Analysis of Code Overlap and Adherence to DRY and SoC Principles

To analyze the code overlap and adherence to DRY (Don't Repeat Yourself) and SoC (Separation of Concerns) principles across the specified classes, let's break down the responsibilities and identify any redundancies or violations:

1. **NovaBankaIPGGateway**
   - **Responsibilities**: Integrates with WooCommerce as a payment gateway.
   Processes payments through `PaymentService`.
     - Handles notifications through `NotificationService`.
     - Manages WooCommerce-specific settings and actions.
   - **Issues**: 
     - May contain business logic that should be in `PaymentService` or `NotificationService`.
     - Should primarily delegate tasks to services.

2. **NovaBankaIPGException**
   - **Responsibilities**: Custom exception handling for the plugin.
   - **Issues**: 
     - Should only define exceptions, no overlap expected.

3. **NotificationService**
   - **Responsibilities**: Processes IPG notifications, updates order statuses.
   Validates notification data.
     - Updates order statuses based on the notification.
     - Logs notification processing results.
     - Manages error handling specific to notification processing.
   - **Issues**: 
     - Ensure it doesn't duplicate logging or validation logic found in `Logger` or `SharedUtilities`.

4. **PaymentService**
   - **Responsibilities**: Handles payment processing, interacts with IPG.
   - **Issues**: 
     - Ensure no duplicate logic for amount formatting or API calls, which should be in `SharedUtilities` or `APIHandler`.

5. **APIHandler**
   - **Responsibilities**: Handles HTTP communication with the NovaBanka IPG API.
    - Manages request/response formatting.
     - Handles API errors.
   - **Issues**: 
     - Ensure it doesn't handle business logic, which should be in services.

6. **Config**
   - **Responsibilities**: Manages configuration settings.
   - **Issues**: 
     - Ensure it doesn't duplicate logic for determining test/live mode, which should be centralized.

7. **Logger**
   - **Responsibilities**: Handles logging operations.
   - **Issues**: 
     - Ensure it doesn't duplicate sensitive data handling, which should be in `SharedUtilities`.

8. **MessageHandler**
   - **Responsibilities**: Manages message verification and signature generation for IPG communication.
   - Verifies notification signatures.
   - Generates message verifiers.
   - **Issues**: 
     - Ensure it doesn't duplicate logic for data formatting or validation.

9. **SharedUtilities**
   - **Responsibilities**: Provides common utility functions used across various components.
     - Data formatting and validation.
     - Redacting sensitive data.
     - Generating API endpoints.
   - **Issues**: 
     - Ensure it centralizes common logic like data formatting, validation, and logging.

10. **ThreeDSHandler**
    - **Responsibilities**: Manages 3D Secure authentication.
    - **Issues**: 
      - Ensure it doesn't duplicate API call logic, which should be in `APIHandler`.

### Recommendations for Refactoring:

1. **Centralize Common Logic**:
   - Move common data formatting and validation to `SharedUtilities`.
   - Ensure all logging is handled by `Logger`.

2. **Delegate Responsibilities**:
   - `NovaBankaIPGGateway` should delegate all business logic to `PaymentService` and `NotificationService`.
   - `APIHandler` should only handle HTTP requests, not business logic.

3. **Avoid Redundancies**:
   - Ensure `PaymentService` and `NotificationService` do not duplicate logic for handling API responses or logging.
   - Use `Config` for all configuration-related logic, especially for test/live mode checks.

4. **Enhance SoC**:
   - Each class should have a single responsibility. For example, `ThreeDSHandler` should only manage 3D Secure processes.

5. **DRY Principle**:
   - Avoid repeating code for data validation, logging, and API interactions. Use utility classes where possible.
</file>

<file path="dev-message_verifier_hash_example.md">
function getMessageVerifier($messageVerifierFields)
    {
        $messageVerifierBase = '';
        foreach ($messageVerifierFields as &$messageVerifierField) {
            $messageVerifierBase .= $messageVerifierField;
        }
        error_log('Message Verifier Base loaded: ');
        error_log($messageVerifierBase);
        
        $messageVerifierBase_hash = hash('sha256', $messageVerifierBase);
        error_log('Message Verifier Hash Hex loaded: ');
        error_log($messageVerifierBase_hash);
        
        $messageVerifierBase_hash_bytes = hex2bin($messageVerifierBase_hash);
        
        // Convert binary to base64
        $msgVerifier = base64_encode($messageVerifierBase_hash_bytes);
        error_log('Message Verifier Hash Base64 loaded: ');
        error_log($msgVerifier);
        return $msgVerifier;
    }
</file>

<file path="dev-payment-example.md">
qtp1307904972-37 2024-10-26 15:41:25,366 DEBUG  servlet.BaseControllerServlet - Processing user request, msgName: PaymentInitRequest, webAppAddress: https://ipgtest.netradionica.com/IPGDemoPlugin, ipgUrlAddress: https://ipgtest.novabanka.com/IPGWeb/servlet/, terminalId: 89110001, terminalPassword.length: 8
qtp1307904972-37 2024-10-26 15:41:25,420 DEBUG  servlet.BaseControllerServlet - Payment 3DS Init POST method invoked
qtp1307904972-37 2024-10-26 15:41:25,428 DEBUG GPaymentServiceJersey1RESTImpl - Sending payment 3DS init, paymentRequest: PaymentInitRequest[msgName=PaymentInitRequest, version=1, id=89110001, password=test1234, ipgClientType=3, ipgurl=https://ipgtest.novabanka.com/IPGWeb/servlet/, secretKey.length=24, langId=USA, cartContent=CartContent[cartContentItems=[CartContentItem[productId=B3442FD-22, productDescription=Female Bicycle Booster GALAXY red, quantity=1, singlePrice=87.52, CartContentItem[productId=KF85Y321-89, productDescription=Bicycle ALPINA BLIZZARD FS black green, quantity=1, singlePrice=205], clientIpAddress=null, clientUserAgent=null, clientHttpHeaders=null, buyerFirstName=Alberto, buyerLastName=Basso, buyerUserId=435365463, buyerPhoneNumber=+39 555 345 6744, buyerEmailAddress=alberto.basso@yahoo.com, shippingInfo=ShippingInfo[recipientFirstName=Claudio, recipientLastName=Carboni, recipientPhoneNumber=+39 555 386 4628, shippingAddress=ShippingAddress[country=ITA, city=Rome, zip=00144, addrLine1=VIALE EUROPA 21, addrLine2=VIALE EUROPA 22, addrLine3=VIALE EUROPA 23]], billingInfo=BillingInfo[billingFirstName=Drago, billingLastName=Basso, billingAddress=BillingAddress[country=ITA, city=Padova, zip=35100, addrLine1=Via Manara 31, addrLine2=Via Manara 32, addrLine3=Via Manara 33]], acctType=03, accountInfo=AccountInfo[chAccAgeInd=01chAccDate=20140328chAccChangeInd=01chAccChange=20160712chAccPwChangeInd=01chAccPwChange=20170328shipAddressUsageInd=01shipAddressUsage=20160714txnActivityDay=1txnActivityYear=21provisionAttemptsDay=0nbPurchaseAccount=11suspiciousAccActivity=01shipNameIndicator=01paymentAccInd=01paymentAccAge=20160917], currentAuthenticationInfo=AuthenticationInfo[threeDSReqAuthMethod=02, threeDSReqAuthTimestamp=201711071307, threeDSReqAuthData=valid login at UL TS BV], priorAuthenticationInfo=PriorAuthenticationInfo[threeDSReqPriorRef=d7c1ee99-9478-44a6-b1f2-391e29c6b340, threeDSReqPriorAuthMethod=02, threeDSReqPriorAuthTimestamp=201711071307, threeDSReqPriorAuthData=valid login at UL TS BV], action=1, receipturl=https://ipgtest.netradionica.com/IPGDemoPlugin/paymentNotification.html, errorurl=https://ipgtest.netradionica.com/IPGDemoPlugin/paymentError.html, currencycode=977, amt=15.00, trackid=CTV-TEST-PureBuy-1, payinst=, recurAction=, recurid=null, recurContractId=null, recurNewCardExpDate=null, purchaseInstalData=, cardSHA2=Y, paymentTimeout=30, bankStmtFreeText=Bank Statement Free Text, paymentDescription=Payment Description, instructedFees=, notificationFormat=json, paymentPageMode=0, udf1=AA, udf2=BB, udf3=CC, udf4=DD, udf5=EE]
qtp1307904972-37 2024-10-26 15:41:25,782 DEBUG GPaymentServiceJersey1RESTImpl - Message Verifier Base loaded, messageVerifierBase.length: 86
qtp1307904972-37 2024-10-26 15:41:25,784 DEBUG GPaymentServiceJersey1RESTImpl - REST client posting, ipgUrl: https://ipgtest.novabanka.com/IPGWeb/servlet/PaymentInitRequest, connectTimeout: 5000, readTimeout: 55000
qtp1307904972-37 2024-10-26 15:41:26,552 DEBUG GPaymentServiceJersey1RESTImpl - Received REST client response, mediaType.getSubtype: json, mediaType: application/json; charset=UTF-8
qtp1307904972-37 2024-10-26 15:41:26,589 DEBUG GPaymentServiceJersey1RESTImpl - Message Verifier Base loaded, messageVerifierBase.length: 151
qtp1307904972-37 2024-10-26 15:41:26,590 DEBUG GPaymentServiceJersey1RESTImpl - Payment 3DS init response loaded, responseBean: PaymentInitResponse[type=valid, errorCode=null, errorService=null, errorDesc=null, messageName=PaymentInitResponse, messageVersion=1, msgDateTime=2024-10-26 15:41:25.739, messageVerifier=AlG4PHnIz97WGI6tbN09YyJdtjJ8jqwverr8e6hiTos=, merchantRequest=PaymentInitRequest[msgName=PaymentInitRequest, version=1, id=89110001, password=test1234, ipgClientType=3, ipgurl=https://ipgtest.novabanka.com/IPGWeb/servlet/, secretKey.length=24, langId=USA, cartContent=CartContent[cartContentItems=[CartContentItem[productId=B3442FD-22, productDescription=Female Bicycle Booster GALAXY red, quantity=1, singlePrice=87.52, CartContentItem[productId=KF85Y321-89, productDescription=Bicycle ALPINA BLIZZARD FS black green, quantity=1, singlePrice=205], clientIpAddress=null, clientUserAgent=null, clientHttpHeaders=null, buyerFirstName=Alberto, buyerLastName=Basso, buyerUserId=435365463, buyerPhoneNumber=+39 555 345 6744, buyerEmailAddress=alberto.basso@yahoo.com, shippingInfo=ShippingInfo[recipientFirstName=Claudio, recipientLastName=Carboni, recipientPhoneNumber=+39 555 386 4628, shippingAddress=ShippingAddress[country=ITA, city=Rome, zip=00144, addrLine1=VIALE EUROPA 21, addrLine2=VIALE EUROPA 22, addrLine3=VIALE EUROPA 23]], billingInfo=BillingInfo[billingFirstName=Drago, billingLastName=Basso, billingAddress=BillingAddress[country=ITA, city=Padova, zip=35100, addrLine1=Via Manara 31, addrLine2=Via Manara 32, addrLine3=Via Manara 33]], acctType=03, accountInfo=AccountInfo[chAccAgeInd=01chAccDate=20140328chAccChangeInd=01chAccChange=20160712chAccPwChangeInd=01chAccPwChange=20170328shipAddressUsageInd=01shipAddressUsage=20160714txnActivityDay=1txnActivityYear=21provisionAttemptsDay=0nbPurchaseAccount=11suspiciousAccActivity=01shipNameIndicator=01paymentAccInd=01paymentAccAge=20160917], currentAuthenticationInfo=AuthenticationInfo[threeDSReqAuthMethod=02, threeDSReqAuthTimestamp=201711071307, threeDSReqAuthData=valid login at UL TS BV], priorAuthenticationInfo=PriorAuthenticationInfo[threeDSReqPriorRef=d7c1ee99-9478-44a6-b1f2-391e29c6b340, threeDSReqPriorAuthMethod=02, threeDSReqPriorAuthTimestamp=201711071307, threeDSReqPriorAuthData=valid login at UL TS BV], action=1, receipturl=https://ipgtest.netradionica.com/IPGDemoPlugin/paymentNotification.html, errorurl=https://ipgtest.netradionica.com/IPGDemoPlugin/paymentError.html, currencycode=977, amt=15.00, trackid=CTV-TEST-PureBuy-1, payinst=, recurAction=, recurid=null, recurContractId=null, recurNewCardExpDate=null, purchaseInstalData=, cardSHA2=Y, paymentTimeout=30, bankStmtFreeText=Bank Statement Free Text, paymentDescription=Payment Description, instructedFees=, notificationFormat=json, paymentPageMode=0, udf1=AA, udf2=BB, udf3=CC, udf4=DD, udf5=EE], paymentId=610180587411543005, redirectUrl=https://ipgtest.novabanka.com/IPGWeb/servlet/PaymentSelection.html]
qtp1307904972-37 2024-10-26 15:41:26,592 DEBUG  servlet.BaseControllerServlet - Payment 3DS Redirecting, redirectUrl: https://ipgtest.novabanka.com/IPGWeb/servlet/PaymentSelection.html?paymentID=610180587411543005
qtp1307904972-37 2024-10-26 15:41:26,593 DEBUG  servlet.BaseControllerServlet - Base controller servlet forwarding, finalUrl: https://ipgtest.novabanka.com/IPGWeb/servlet/PaymentSelection.html?paymentID=610180587411543005, isError: false, receiptUrl: https://ipgtest.novabanka.com/IPGWeb/servlet/PaymentSelection.html?paymentID=610180587411543005
qtp1307904972-38 2024-10-26 15:41:37,593 DEBUG    servlet.NotificationServlet - Notification request servlet invoked, notificationContentType: application/json
qtp1307904972-38 2024-10-26 15:41:37,600 DEBUG e.IPGPaymentServiceDefaultImpl - Processing Notification JSON request, notificationUrlBulder: rs.asoft.ipg.demoplugin.servlet.IPGDemoNotificationUrlBuilder@5e947333, notificationRequestJson: {
  "msgName" : "PaymentNotificationRequest",
  "version" : "1",
  "msgDateTime" : "2024-10-26 15:41:36.639",
  "msgVerifier" : "/WdMK9tSj6lD/s1DwNB+0pGFpHlNcN5Cy6iwiR3lZ/Q=",
  "type" : "valid",
  "result" : "CAPTURED",
  "errorCode" : null,
  "errorService" : null,
  "errorDesc" : null,
  "action" : "1",
  "payinst" : "VPAS",
  "paymentid" : "610180587411543005",
  "tranid" : "335207428411543002",
  "paymentPageMode" : "0",
  "currencycode" : "977",
  "amt" : "15.00",
  "auth" : "999999",
  "trackid" : "CTV-TEST-PureBuy-1",
  "ref" : "430015007876",
  "responsecode" : "00",
  "responsedescription" : "",
  "cardtype" : "MC",
  "liability" : "Y",
  "recurid" : null,
  "recurContractId" : null,
  "purchaseInstalData" : null,
  "expdate" : "202612",
  "cardlastfourdigits" : "0325",
  "cardcountry" : "LB",
  "ipcountry" : "BA",
  "cardSHA2" : "HNYgYZqUngnGz5H3vQDGqJwvK/ixF605uygt8Alv9qI=",
  "udf1" : "AA",
  "udf2" : "BB",
  "udf3" : "CC",
  "udf4" : "DD",
  "udf5" : "EE",
  "riskLevel" : null,
  "riskScore" : null,
  "riskThreshold" : null,
  "riskMaxScore" : null
}
qtp1307904972-38 2024-10-26 15:41:37,607 DEBUG e.IPGPaymentServiceDefaultImpl - Parsing JSON bytes, httpBody: 7B0D0A2020226D73674E616D6522203A20225061796D656E744E6F74696669636174696F6E52657175657374222C0D0A20202276657273696F6E22203A202231222C0D0A2020226D73674461746554696D6522203A2022323032342D31302D32362031353A34313A33362E363339222C0D0A2020226D7367566572696669657222203A20222F57644D4B3974536A366C442F733144774E422B3070474670486C4E634E3543793669776952336C5A2F513D222C0D0A2020227479706522203A202276616C6964222C0D0A202022726573756C7422203A20224341505455524544222C0D0A2020226572726F72436F646522203A206E756C6C2C0D0A2020226572726F725365727669636522203A206E756C6C2C0D0A2020226572726F724465736322203A206E756C6C2C0D0A202022616374696F6E22203A202231222C0D0A202022706179696E737422203A202256504153222C0D0A2020227061796D656E74696422203A2022363130313830353837343131353433303035222C0D0A2020227472616E696422203A2022333335323037343238343131353433303032222C0D0A2020227061796D656E74506167654D6F646522203A202230222C0D0A20202263757272656E6379636F646522203A2022393737222C0D0A202022616D7422203A202231352E3030222C0D0A2020226175746822203A2022393939393939222C0D0A202022747261636B696422203A20224354562D544553542D507572654275792D31222C0D0A20202272656622203A2022343330303135303037383736222C0D0A202022726573706F6E7365636F646522203A20223030222C0D0A202022726573706F6E73656465736372697074696F6E22203A2022222C0D0A202022636172647479706522203A20224D43222C0D0A2020226C696162696C69747922203A202259222C0D0A2020227265637572696422203A206E756C6C2C0D0A2020227265637572436F6E7472616374496422203A206E756C6C2C0D0A2020227075726368617365496E7374616C4461746122203A206E756C6C2C0D0A2020226578706461746522203A2022323032363132222C0D0A202022636172646C617374666F757264696769747322203A202230333235222C0D0A20202263617264636F756E74727922203A20224C42222C0D0A2020226970636F756E74727922203A20224241222C0D0A202022636172645348413222203A2022484E5967595A71556E676E477A35483376514447714A77764B2F6978463630357579677438416C763971493D222C0D0A2020227564663122203A20224141222C0D0A2020227564663222203A20224242222C0D0A2020227564663322203A20224343222C0D0A2020227564663422203A20224444222C0D0A2020227564663522203A20224545222C0D0A2020227269736B4C6576656C22203A206E756C6C2C0D0A2020227269736B53636F726522203A206E756C6C2C0D0A2020227269736B5468726573686F6C6422203A206E756C6C2C0D0A2020227269736B4D617853636F726522203A206E756C6C0D0A7D
qtp1307904972-38 2024-10-26 15:41:37,622 DEBUG e.IPGPaymentServiceDefaultImpl - Message Verifier Base loaded, messageVerifierBase.length: 137
qtp1307904972-38 2024-10-26 15:41:37,623 DEBUG e.IPGPaymentServiceDefaultImpl - IPG Notification result url loaded, notificationResultUrl: https://ipgtest.netradionica.com/IPGDemoPlugin/paymentResult.html?PaymentID=610180587411543005&paymentPageMode=STANDARD&msgName=PaymentNotificationRequest&version=1&msgDateTime=2024-10-26 15:41:36.639&TransID=335207428411543002&action=1&recurid=&recurContractId=&purchaseInstalData=&resultcode=CAPTURED&type=valid&errorCode=&errorDesc=&Currency=977&Amount=15.00&TrackID=CTV-TEST-PureBuy-1&cardType=MC&payinst=VPAS&liability=Y&responsecode=00&responsedescription=&ref=430015007876&auth=999999&expdate=202612&cardlastfourdigits=0325&cardSHA2=HNYgYZqUngnGz5H3vQDGqJwvK/ixF605uygt8Alv9qI=&udf1=AA&udf2=BB&udf3=CC&udf4=DD&udf5=EE&myBankBuyerBankAlias=&riskLevel=&riskScore=&riskThreshold=&riskMaxScore=&cardcountry=LB&shipOptionId=&paymentAmt=&city=&country=&countrySubdivision=&line1=&line2=&line3=&postalCode=&recipientName=&recipientPhoneNumber=&ipcountry=BA&msgVerifier=/WdMK9tSj6lD/s1DwNB+0pGFpHlNcN5Cy6iwiR3lZ/Q=
qtp1307904972-38 2024-10-26 15:41:37,625 DEBUG e.IPGPaymentServiceDefaultImpl - Message Verifier Base loaded, messageVerifierBase.length: 983
qtp1307904972-38 2024-10-26 15:41:37,627 DEBUG e.IPGPaymentServiceDefaultImpl - IPG Notification response JSON loaded, notificationResponseJson: {"paymentID":"610180587411543005","msgVerifier":"QCl8DfJVzlhzensa+c\/6WGGuaXiDfWOMSL1ShuIKSsI=","msgName":"PaymentNotificationResponse","version":"1","browserRedirectionURL":"https:\/\/ipgtest.netradionica.com\/IPGDemoPlugin\/paymentResult.html?PaymentID=610180587411543005&paymentPageMode=STANDARD&msgName=PaymentNotificationRequest&version=1&msgDateTime=2024-10-26 15:41:36.639&TransID=335207428411543002&action=1&recurid=&recurContractId=&purchaseInstalData=&resultcode=CAPTURED&type=valid&errorCode=&errorDesc=&Currency=977&Amount=15.00&TrackID=CTV-TEST-PureBuy-1&cardType=MC&payinst=VPAS&liability=Y&responsecode=00&responsedescription=&ref=430015007876&auth=999999&expdate=202612&cardlastfourdigits=0325&cardSHA2=HNYgYZqUngnGz5H3vQDGqJwvK\/ixF605uygt8Alv9qI=&udf1=AA&udf2=BB&udf3=CC&udf4=DD&udf5=EE&myBankBuyerBankAlias=&riskLevel=&riskScore=&riskThreshold=&riskMaxScore=&cardcountry=LB&shipOptionId=&paymentAmt=&city=&country=&countrySubdivision=&line1=&line2=&line3=&postalCode=&recipientName=&recipientPhoneNumber=&ipcountry=BA&msgVerifier=\/WdMK9tSj6lD\/s1DwNB+0pGFpHlNcN5Cy6iwiR3lZ\/Q="}
qtp1307904972-38 2024-10-26 15:41:37,629 DEBUG    servlet.NotificationServlet - Writing notification response bytes, notificationResponseXmlBytes.length: 1098
qtp1307904972-38 2024-10-26 15:41:37,630 DEBUG    servlet.NotificationServlet - Notification response bytes sent
qtp1307904972-39 2024-10-26 15:41:37,815 DEBUG   servlet.IPGDemoResultServlet - IPG Demo Result servlet redirecting to result page, resultPage: /WEB-INF/jsp/payment3DSResult.jsp
</file>

<file path="dev-plugin_config_option_example.md">
/**
         * Plugin options
         */
        public function init_form_fields()
        {
            $this->form_fields = array(
                'title' => array(
                    'title' => 'Title',
                    'type' => 'text',
                    'description' => 'This controls the title which the user sees during checkout.',
                    'default' => 'Credit Card',
                    'desc_tip' => true
                ),
                'description' => array(
                    'title' => 'Description',
                    'type' => 'textarea',
                    'description' => 'This controls the description which the user sees during checkout.',
                    'default' => 'Pay with your credit card via our IPG payment gateway.'
                ),
                'enabled' => array(
                    'title' => 'Enable/Disable',
                    'label' => 'Enable IPG Gateway',
                    'type' => 'checkbox',
                    'description' => '',
                    'default' => 'no'
                ),
                'MessageType' => array(
                    'title' => 'Message Type',
                    'type' => 'select',
                    'default' => 'VISEC / VIREC first transaction',
                    'class' => 'MessageType wc-enhanced-select',
                    'options' => array(
                        'MessageType' => 'VISEC / VIREC first transaction'
                    )
                ),
                'MessageVersion' => array(
                    'title' => 'Message Version',
                    'type' => 'select',
                    'default' => '1',
                    'class' => 'MessageVersion wc-enhanced-select',
                    'options' => array(
                        '1' => '1'
                    )),
                'TerminalID' => array(
                    'title' => 'Terminal ID:',
                    'type' => 'text',
                    'default' => '89110001'
                ),
                'Password' => array(
                    'title' => 'Password:',
                    'type' => 'password',
                    'default' => 'test1234'
                ),
                'IPGURL' => array(
                    'title' => 'IPG:',
                    'type' => 'text',
                    'default' => 'http://ipg-test:9080/IPGWeb/servlet/PaymentInitRequest'
                ),
                'SecretKey' => array(
                    'title' => 'Secret Key:',
                    'type' => 'text',
                    'default' => 'YXKZPOQ9RRLGPDED5D3PC5BJ'
                ),
                'Action' => array(
                    'title' => 'Action:',
                    'type' => 'select',
                    'default' => '1',
                    'class' => 'Action wc-enhanced-select',
                    'options' => array(
                        '1' => 'PURCHASE',
                        '4' => 'AUTHORIZATION'
                    )
                ),
                'ResponseURL' => array(
                    'title' => 'RESPONSE URL:',
                    'type' => 'text',
                    'default' => get_home_url() . '/wc-api/CALLBACK/?ipg_response_interface=1'
                ),
                'ErrorURL' => array(
                    'title' => 'ERROR URL:',
                    'type' => 'text',
                    'default' => get_home_url() . '/wc-api/CALLBACK/?ipg_response_interface=1'
                ),
                'NotificationFormat' => array(
                    'title' => 'Notiication Format:',
                    'type' => 'select',
                    'default' => 'json',
                    'class' => 'NotificationFormat wc-enhanced-select',
                    'options' => array(
                        'json' => 'JSON'
                    )
                ),
                'PaymentPageMode' => array(
                    'title' => 'Payment Page Mode:',
                    'type' => 'select',
                    'default' => '0',
                    'class' => 'PaymentPageMode wc-enhanced-select',
                    'options' => array(
                        '0' => 'STANDARD'
                    )
                ),
                'PaymentInstrument' => array(
                    'title' => 'Payment Instrument:',
                    'type' => 'text',
                    'default' => ''
                ),
                'CardSHA2' => array(
                    'title' => 'CARD SHA2:',
                    'type' => 'select',
                    'default' => 'Y',
                    'class' => 'CardSHA2 wc-enhanced-select',
                    'options' => array(
                        'Y' => 'Yes',
                        'N' => 'No'
                    )
                ),
                'PaymentTimeout' => array(
                    'title' => 'Payment Timeout:',
                    'type' => 'text',
                    'default' => '30'
                ),
                'Language' => array(
                    'title' => 'Language:',
                    'type' => 'text',
                    'default' => 'USA'
                ),
                'PurchaseInstalData' => array(
                    'title' => 'Installment Number: ',
                    'type' => 'text',
                    'default' => ''
                ),
                
                'CheckoutIconUrl' => array(
                    'title' => 'Checkout Icon URL: ',
                    'type' => 'text',
                    'description' => 'Insert URL of your Checkout Icon, or leave empty to use the default one.',
                    'default' => ''
                )
            );
        }
</file>

<file path="dev-proces_payment_example.md">
public function process_payment($order_id)
        {
            global $woocommerce;
            
            // we need it to get any order detailes
            $order = new WC_Order($order_id);
            
            $args = array(
                "msgName" => "PaymentInitRequest",
                'version' => $this->MessageVersion,
                'id' => $this->TerminalID,
                'password' => $this->Password,
                
                'msgVerifier' => "",
                'langId' => $this->Language,
                
                'CartContent' => $this->CartContent, // JSON [complex]
                                                     
                // 'buyerFirstName' => $this->FirstName,
                                                     // 'buyerFirstName' => "",
                                                     // 'buyerLastName' => "",
                                                     // 'buyerUserId' => "",
                                                     // 'buyerPhoneNumber' => "",
                                                     // 'buyeremailaddress' => "",
                                                     // 'clientIpAddress' => "",
                                                     // 'clientUserAgent' => "",
                                                     // 'clientHttpHeaders' => "",
                                                     
                // 'shippingInfo' => "", // JSON
                                                     // 'billingInfo' => "", // JSON
                                                     
                // 'acctType' => "",
                                                     // 'accountInfo' => "", // JSON
                                                     // 'authenticationInfo' => "", // JSON
                                                     // 'priorAuthenticationInfo'=> "", // JSON
                
                'action' => $this->Action,
                'recurAction' => "",
                'recurContractId' => "",
                'responseURL' => $this->ResponseURL, // responseURL
                'errorURL' => $this->ErrorURL, // errorURL
                'currencycode' => $order->get_currency(),
                'amt' => $order->get_total(),
                'trackid' => $order_id,
                'cardSHA2' => $this->CardSHA2,
                'paymentTimeout' => $this->PaymentTimeout,
                //'pymnDscr' => $this->PaymentDescription,
                'notificationFormat' => $this->NotificationFormat,
                'paymentPageMode' => $this->PaymentPageMode,
                'payinst' => $this->PaymentInstrument,
                'purchaseInstalData' => $this->PurchaseInstalData,
            );
            
            if (! function_exists('write_log')) {

                function write_log($log)
                {
                    if (true === WP_DEBUG) {
                        if (is_array($log) || is_object($log)) {
                            error_log(print_r($log, true));
                        } else {
                            error_log($log);
                        }
                    }
                }
            }
            
            $message_verifier_fields_array = array(
                $args['msgName'],
                $args['version'],
                $args['id'],
                $args['password'],
                $args['amt'],
                $args['trackid'],
                '',
                $this->SecretKey,
                ''
            );
            
            // load message verifier
            $args['msgVerifier'] = getMessageVerifier($message_verifier_fields_array);
            
            $args['errorURL'] = $order->get_checkout_order_received_url();
            /*
             * Your API interaction could be built with wp_remote_post()
             */
            // $response = wp_remote_post( '{payment processor endpoint}', $args );
            
            $ipg_url = $this->IPGURL;
            write_log('Sending request, url: ');
            write_log($ipg_url);
            
            $request_preety_json = json_encode($args, JSON_PRETTY_PRINT);
            write_log('request_preety_json: ');
            write_log($request_preety_json);
            
            $request_json = json_encode($args);
            write_log('request_json: ');
            write_log($request_json);
            
            // $url = 'localhost:9082/IPGWeb/servlet/PaymentInitRequest';
            $response = wp_remote_post($ipg_url, array(
                'headers' => array(
                    'Accept' => 'application/json',
                    'Content-Type' => 'application/json; charset=utf-8'
                ),
                'body' => $request_json,
                'method' => 'POST',
                'data_format' => 'body'
            ));
            
            if (is_wp_error($response) && ! empty($response->errors)) {
                wc_add_notice('HTTP Response Error', 'error');
                wc_add_notice($response->get_error_message(), 'error');
                return;
            }
            
            $response_code = wp_remote_retrieve_response_code($response);
            write_log('Loaded response code, response_code: ');
            write_log($response_code);
            if (! in_array($response_code, array(
                200,
                201
            ))) {
                wc_add_notice('HTTP Status Error', 'error');
                wc_add_notice($response_code, 'error');
                return;
            }
            
            $response_body = wp_remote_retrieve_body($response);
            write_log('Loaded response body, response_body: ');
            write_log($response_body);
            
            $response_json = json_decode($response_body);
            if (json_last_error() > JSON_ERROR_NONE) {
                wc_add_notice('Response JSON Error:', 'error');
                wc_add_notice(json_last_error_msg(), 'error');
                return;
            }
            
            write_log('Loadded JSON response, response_preety_json: ');
            $response_preety_json = json_encode($response_json, JSON_PRETTY_PRINT);
            write_log($response_preety_json);
            
            // it could be different depending on your payment processor
            if ($response_json->type == 'valid') {
                
                $response_url = $response_json->browserRedirectionURL;
                $response_url .= "?PaymentID=";
                $response_url .= $response_json->paymentid;
                
                if (! filter_var($response_url, FILTER_VALIDATE_URL)) {
                    wc_add_notice('Invalid IPG Response Url:', 'error');
                    wc_add_notice($response_url, 'error');
                    return;
                }
                
                // Mark as on-hold (we're awaiting the cheque)
                $order->update_status('on-hold', __('Awaiting IPG payment', 'ipg_plugin'));
                
                // // Reduce stock levels
                // $order->reduce_order_stock();
                
                // // Remove cart
                // $woocommerce->cart->empty_cart();
                
                // Redirect to the thank you page
                return array(
                    'result' => 'success',
                    'redirect' => $response_url
                );
            } else {
                wc_add_notice('IPG Response Error:', 'error');
                wc_add_notice($response_json->errorCode, 'error');
                wc_add_notice($response_json->errorDesc, 'error');
                return;
            }
                        
        }
</file>

<file path="dev-response_interface_example.md">
function ipg_response_interface($template)
    {
        $WC_IPG_POST_Gateway = new WC_IPG_POST_Gateway();
        
        // Load basics
        require_once ('wp-load.php');
        
        $request_body = file_get_contents("php://input");
        error_log('Received JSON request:');
        error_log($request_body);
        
        if (! isset($request_body) || empty($request_body)) {
            error_log('Received Empty JSON:');
            error_log($request_body);
            return $template;
        }
        
        $request_json = json_decode($request_body);
        
        // json request, reply with json response
        header('Content-Type: application/json');
        
        // Process the order
        if (isset($request_json->type) && $request_json->type == 'valid') {
            error_log('IPG JSON Valid Message:');
            // Get vars
            $trackid = intval($request_json->trackid);
            // Create the Order object
            $order = new WC_Order($trackid);
            
            $order->set_transaction_id($request_json->paymentid);
            
            $result_url = $order->get_checkout_order_received_url();
            if (isset($request_json->result) && ($request_json->result == 'CAPTURED' || $request_json->result == 'APPROVED')) {
                $result_url .=  '&result='.$request_json->result.'&ref='.$request_json->ref;
                // Mark order as 'processing'
                $order->payment_complete();
                $order->add_order_note('Received Successful payment from IPG gateway, result: ' . $request_json->result . ', ref: ' . $request_json->ref, 'woocommerce_gateway_ipg');
                // log
                error_log('Received Payment successful from IPG gateway');
                // Order successful URL
            } else {
                $result_url .=  '&result=NOT_CAPTURED&responseCode='.$request_json->responsecode.'&ref='.$request_json->ref.'&responseDescription='.$request_json->responsedescription;
                // Mark order as 'failed'
                $order->update_status('failed', __('Received Payment Declined from IPG gateway , result: ' . $request_json->result . ', responseCode: ' . $request_json->responsecode . ', ref: ' . $request_json->ref.', responseDescription='.$request_json->responsedescription, 'woocommerce_gateway_ipg'));
                // log
                error_log('Received Payment Declined from IPG gateway ');
                // Order successful URL
            }
            // Command the redirection to the ThankYou page
            $message_verifier_fields_array = array(
                'PaymentNotificationResponse',
                '1',
                $request_json->paymentid,
                $WC_IPG_POST_Gateway->get_option('SecretKey'),
                $result_url
            );
            
            // load message verifier
            $msgVerifier = getMessageVerifier($message_verifier_fields_array);
            $successful_json_array = array(
                'paymentID' => $request_json->paymentid,
                'msgVerifier' => $msgVerifier,
                'msgName' => 'PaymentNotificationResponse',
                'version' => '1',
                'browserRedirectionURL' => $result_url
            );
            $response_json = json_encode($successful_json_array, JSON_PRETTY_PRINT);
            error_log('Sending JSON response:');
            error_log($response_json);
            echo $response_json;
        } else {
            error_log('IPG JSON Error Message:');
            error_log($request_json->errorCode);
            error_log($request_json->errorDesc);
            error_log($request_json->paymentid);
            error_log($request_json->trackid);
            
            wc_add_notice('IPG Response Error', 'error');
            wc_add_notice($request_json->errorDesc, 'error');
            
            // Get vars
            $trackid = intval($request_json->trackid);
            // Create the Order object
            $order = new WC_Order($trackid);
            // Mark as 'Processing'
            $order->update_status('failed', __('Received Error from IPG gateway payment, paymentid: ' . $request_json->paymentid . ', errorCode: ' . $request_json->errorCode . ', errorDesc: ' . $request_json->errorDesc, 'woocommerce_gateway_ipg'));
            
            $result_url = $order->get_checkout_order_received_url() . '&errorCode=' . $request_json->errorCode . '&errorDesc=' . $request_json->errorDesc;
            $message_verifier_fields_array = array(
                'PaymentNotificationResponse',
                '1',
                $request_json->paymentid,
                $WC_IPG_POST_Gateway->get_option('SecretKey'),
                // 'YXKZPOQ9RRLGPDED5D3PC5BJ',
                $result_url
            );
            
            // load message verifier
            $msgVerifier = getMessageVerifier($message_verifier_fields_array);
            
            $error_json_array = array(
                'paymentID' => $request_json->paymentid,
                'msgVerifier' => $msgVerifier,
                'msgName' => 'PaymentNotificationResponse',
                'version' => '1',
                'browserRedirectionURL' => $result_url
            );
            $response_json = json_encode($error_json_array, JSON_PRETTY_PRINT);
            error_log('Sending JSON response:');
            error_log($response_json);
            echo $response_json;
        }
        exit();

        return $template;
    }

    function getMessageVerifier($messageVerifierFields)
    {
        $messageVerifierBase = '';
        foreach ($messageVerifierFields as &$messageVerifierField) {
            $messageVerifierBase .= $messageVerifierField;
        }
        error_log('Message Verifier Base loaded: ');
        error_log($messageVerifierBase);
        
        $messageVerifierBase_hash = hash('sha256', $messageVerifierBase);
        error_log('Message Verifier Hash Hex loaded: ');
        error_log($messageVerifierBase_hash);
        
        $messageVerifierBase_hash_bytes = hex2bin($messageVerifierBase_hash);
        
        // Convert binary to base64
        $msgVerifier = base64_encode($messageVerifierBase_hash_bytes);
        error_log('Message Verifier Hash Base64 loaded: ');
        error_log($msgVerifier);
        return $msgVerifier;
    }
</file>

<file path="gateway-33-config.json">
{
  "plugin": {
    "name": "NovaBanka IPG33 Payment Gateway",
    "version": "1.0.2",
    "namespace": "NovaBankaIPG",
    "main_file": "class-novabankaipg.php",
    "description": "3D Secure payment gateway integration for WooCommerce",
    "implementation_notes": {
      "main_class": {
        "file": "class-novabankaipg.php",
        "reference": {
          "current": {
            "startLine": 1,
            "endLine": 37
          }
        },
        "improvements": {
          "container": {
            "description": "Implement proper dependency injection container",
            "example": {
              "code": [
                "private function init_container(): void {",
                "    $this->container = new Container();",
                "    $this->container->singleton('logger', Logger::class);",
                "    $this->container->singleton('config', Config::class);",
                "    $this->container->singleton('api_handler', APIHandler::class);"
              ]
            }
          },
          "initialization": {
            "description": "Add proper plugin activation/deactivation hooks",
            "example": {
              "code": [
                "register_activation_hook(__FILE__, [$this, 'activate']);",
                "register_deactivation_hook(__FILE__, [$this, 'deactivate']);"
              ]
            }
          }
        }
      }
    },
    "core_components": {
      "gateway": {
        "file": "includes/Core/class-novabankaipggateway.php",
        "reference": {
          "current": {
            "startLine": 1,
            "endLine": 185
          }
        },
        "improvements": {
          "blocks_support": {
            "description": "Add WooCommerce Blocks support",
            "example": {
              "code": [
                "public function get_payment_method_script_handles() {",
                "    return ['novabankaipg-payment-method'];",
                "}",
                "",
                "public function get_payment_method_data() {",
                "    return [",
                "        'title' => $this->get_title(),",
                "        'description' => $this->get_description(),",
                "        'supports' => ['products']",
                "    ];",
                "}"
              ]
            }
          }
        }
      }
    },
    "services": {
      "payment_service": {
        "file": "includes/Services/class-paymentservice.php",
        "reference": {
          "current": {
            "startLine": 1,
            "endLine": 51
          }
        },
        "improvements": {
          "transaction_handling": {
            "description": "Add comprehensive transaction state management",
            "example": {
              "code": [
                "private function handle_transaction_state(WC_Order $order, array $response): void {",
                "    $state = new TransactionState($order, $response);",
                "    $state->process();",
                "    $state->update_order();",
                "}"
              ]
            }
          }
        }
      }
    },
    "utils": {
      "api_handler": {
        "improvements": {
          "retry_mechanism": {
            "description": "Add proper retry mechanism for failed requests",
            "example": {
              "code": [
                "private function request_with_retry(string $endpoint, array $data, int $retries = 3): array {",
                "    for ($i = 0; $i < $retries; $i++) {",
                "        try {",
                "            return $this->make_request($endpoint, $data);",
                "        } catch (APIException $e) {",
                "            if ($i === $retries - 1) throw $e;",
                "            sleep(pow(2, $i));",
                "        }",
                "    }",
                "}"
              ]
            }
          }
        }
      },
      "logger": {
        "improvements": {
          "structured_logging": {
            "description": "Implement structured logging with context",
            "example": {
              "code": [
                "public function log(string $level, string $message, array $context = []): void {",
                "    $data = [",
                "        'timestamp' => time(),",
                "        'level' => $level,",
                "        'message' => $message,",
                "        'context' => $this->sanitize_context($context)",
                "    ];",
                "    wc_get_logger()->log($level, json_encode($data));",
                "}"
              ]
            }
          }
        }
      }
    },
    "future_development": {
      "priority_high": [
        {
          "feature": "Block Checkout Integration",
          "description": "Implement full WooCommerce Blocks compatibility",
          "tasks": [
            "Add payment method block registration",
            "Implement payment method frontend components",
            "Add block validation handlers"
          ]
        },
        {
          "feature": "Enhanced Error Handling",
          "description": "Implement comprehensive error handling system",
          "tasks": [
            "Add detailed error logging",
            "Implement user-friendly error messages",
            "Add error recovery mechanisms"
          ]
        }
      ],
      "priority_medium": [
        {
          "feature": "Performance Optimization",
          "description": "Optimize gateway performance",
          "tasks": [
            "Implement request caching",
            "Add response optimization",
            "Optimize database queries"
          ]
        }
      ]
    }
  },
  "directory_structure": {
    "root": {
      "main_plugin_file": {
        "path": "class-novabankaipg.php",
        "purpose": "Plugin bootstrap and initialization",
        "responsibilities": [
          "Define plugin constants",
          "Load dependencies",
          "Initialize core components",
          "Register WooCommerce hooks"
        ],
        "reference": {
          "file": "class-novabankaipg.php",
          "startLine": 1,
          "endLine": 37
        }
      }
    },
    "includes": {
      "Core": {
        "class-novabankaipggateway.php": {
          "purpose": "Main gateway integration with WooCommerce",
          "responsibilities": [
            "Handle WooCommerce payment settings",
            "Process payments",
            "Manage refunds",
            "Configure gateway options"
          ],
          "reference": {
            "file": "includes/Core/class-novabankaipggateway.php",
            "startLine": 1,
            "endLine": 65
          }
        }
      },
      "Services": {
        "class-paymentservice.php": {
          "purpose": "Payment processing business logic",
          "responsibilities": [
            "Handle payment initialization",
            "Process payment responses",
            "Manage order status updates",
            "Handle payment notifications"
          ]
        },
        "class-notificationservice.php": {
          "purpose": "Handle IPG notifications",
          "responsibilities": [
            "Process IPG callbacks",
            "Verify notification signatures",
            "Update order statuses",
            "Store transaction data"
          ]
        }
      },
      "Utils": {
        "class-apihandler.php": {
          "purpose": "Handle API communication",
          "responsibilities": [
            "Make HTTP requests to IPG",
            "Handle API responses",
            "Manage request/response logging",
            "Handle API errors"
          ]
        },
        "class-logger.php": {
          "purpose": "Logging functionality",
          "responsibilities": [
            "Log payment operations",
            "Log errors and debugging info",
            "Format log messages",
            "Handle sensitive data redaction"
          ]
        },
        "class-datahandler.php": {
          "purpose": "Data processing and validation",
          "responsibilities": [
            "Validate payment data",
            "Format amounts and currencies",
            "Sanitize input data",
            "Prepare API requests"
          ]
        },
        "class-messagehandler.php": {
          "purpose": "Message verification and processing",
          "responsibilities": [
            "Generate message verifiers",
            "Verify message signatures",
            "Format API messages",
            "Handle error messages"
          ]
        },
        "class-sharedutilities.php": {
          "purpose": "Common utility functions",
          "responsibilities": [
            "Format amounts",
            "Handle currency codes",
            "Generate unique IDs",
            "Common helper functions"
          ]
        },
        "class-threedshandler.php": {
          "purpose": "3D Secure processing",
          "responsibilities": [
            "Handle 3DS redirections",
            "Process 3DS responses",
            "Validate 3DS data",
            "Manage 3DS state"
          ]
        },
        "class-config.php": {
          "purpose": "Configuration management",
          "responsibilities": [
            "Manage gateway settings",
            "Handle environment configs",
            "Store API credentials",
            "Manage options"
          ]
        }
      },
      "Exceptions": {
        "class-novabankaipgexception.php": {
          "purpose": "Custom exception handling",
          "responsibilities": [
            "Define custom exceptions",
            "Handle error messages",
            "Provide error context",
            "Format error responses"
          ]
        }
      }
    }
  },
  "hooks": {
    "filters": {
      "reference": {
        "file": "developer-log.json",
        "startLine": 223,
        "endLine": 239
      }
    },
    "actions": {
      "reference": {
        "file": "developer-log.json",
        "startLine": 240,
        "endLine": 255
      }
    }
  },
  "dependencies": {
    "wordpress": ">=5.8",
    "woocommerce": ">=5.0",
    "php": ">=7.4"
  },
  "security": {
    "reference": {
      "file": "developer-log.json",
      "startLine": 306,
      "endLine": 312
    }
  }
}
</file>

<file path="ipg-gateway-example-php.md">
<?php
/*
 * Plugin Name: WooCommerce IPG Payment Gateway
 * Plugin URI: https://www.tasgroup.rs/
 * Description: Extends WooCommerce with the IPG Payment Gateway.
 * Author: TAS EE
 * Author URI: https://www.tasgroup.rs/
 * Version: 1.0.4
 *
 * History: 
 *  1.0.1
 *      - Basic purchase functionality
 *  1.0.2
 *  - Added purchaseInstallData
 *  - Added action_woocommerce_order_refunded
 *  1.0.3
 *  - Fixed action woocommerce_api_callback
 *  1.0.4
 *  - Increased Response Title size and fixed default value of response URL 
 *  1.0.5
 *  - Improved NOT CAPTURED error message presentation
 *
 */

add_action( 'woocommerce_thankyou', 'ipg_order_received_title', 1 );
function ipg_order_received_title( ) {
    
    $title = '';
    if (isset($_GET['result']) &&  ($_GET['result'] == 'CAPTURED' || $_GET['result'] == 'APPROVED')) {
        $title.='<div style="color:Green;font-size: 2em;padding-bottom: 0.9em;">';
        $title.='<label>Payment successful.</label><br>';
        $title.='<label>Result: ' . $_GET['result'] . '</label><br>';
        $title.='<label>Reference:'.$_GET['ref'].'</label><br>';
        $title.='</div>';
    } else if (isset($_GET['result']) && $_GET['result'] == 'NOT_CAPTURED') {
        $title.='<div style="color:Red;font-size: 2em;padding-bottom: 0.9em;">';
        $title.='<label>Payment Declined</label><br>';
        $title.='<label>Result: NOT CAPTURED</label><br>';
        $title.='<label>Response Code: '.$_GET['responseCode'].'</label><br>';
        if (isset($_GET['responseDescription'])) {
            $title.='<label>Response Description: '.$_GET['responseDescription'].'</label><br>';
        }
        $title.='<label>Reference: '.$_GET['ref'].'</label><br>';
        $title.='</div>';
    } else  if (isset($_GET['errorCode'])) {
        $title.='<div style="color:Red;font-size: 2em;padding-bottom: 0.9em;">';
        $title.='<label>Error :'.$_GET['errorCode'];
        if (isset($_GET['errorDesc'])) {
            $title.='-'.$_GET['errorDesc'].'';
        }
        $title.='</label>';
        $title.='</div>';
    } else {
        $title.='<div style="color:Red;font-size: 1.4em;padding-bottom: 0.9em;">';
        $title.='<label>Notification Error - Check RESPONSE URL</label><br>';
        $title.='<label>Please contact support</label><br>';
        $title.='</div>';
    }
    $title .= '<B>';
    
    echo $title;
}

add_filter('woocommerce_payment_gateways', 'ipg_gateway_class');
function ipg_gateway_class($gateways)
{
    $gateways[] = 'WC_IPG_POST_Gateway';
    return $gateways;
}

// Setup the responseURL interface
add_filter('query_vars', 'ipg_add_query_vars');

/**
 * Add the 'ipg_response_interface' query variable so WordPress
 * won't remove it.
 */
function ipg_add_query_vars($vars)
{
    $vars[] = "ipg_response_interface";
    return $vars;
}

add_action('woocommerce_before_thankyou', 'ipg_before_thankyou');

function ipg_before_thankyou($order_id)
{
    $has_order_id = isset($order_id);
    error_log('has_order_id ');
    error_log($has_order_id);
    if ($has_order_id != 1)
        return $order_id;
    
    error_log('Could perform something with Order ID: ');
    error_log($order_id);
    
    $order = new WC_Order($order_id);
    $order->set_payment_method_title('TUSAM');
    
}

/*
 * The class itself, please note that it is inside plugins_loaded action hook
 */
add_action('plugins_loaded', 'ipg_init_gateway_class');

function ipg_init_gateway_class()
{
    
    /**
     * check for 'ipg_response_interface' query variable and do what you want if its there
     */
    add_action('woocommerce_api_callback', 'ipg_response_interface');

    function ipg_response_interface($template)
    {
        $WC_IPG_POST_Gateway = new WC_IPG_POST_Gateway();
        
        // Load basics
        require_once ('wp-load.php');
        
        $request_body = file_get_contents("php://input");
        error_log('Received JSON request:');
        error_log($request_body);
        
        if (! isset($request_body) || empty($request_body)) {
            error_log('Received Empty JSON:');
            error_log($request_body);
            return $template;
        }
        
        $request_json = json_decode($request_body);
        
        // json request, reply with json response
        header('Content-Type: application/json');
        
        // Process the order
        if (isset($request_json->type) && $request_json->type == 'valid') {
            error_log('IPG JSON Valid Message:');
            // Get vars
            $trackid = intval($request_json->trackid);
            // Create the Order object
            $order = new WC_Order($trackid);
            
            $order->set_transaction_id($request_json->paymentid);
            
            $result_url = $order->get_checkout_order_received_url();
            if (isset($request_json->result) && ($request_json->result == 'CAPTURED' || $request_json->result == 'APPROVED')) {
                $result_url .=  '&result='.$request_json->result.'&ref='.$request_json->ref;
                // Mark order as 'processing'
                $order->payment_complete();
                $order->add_order_note('Received Successful payment from IPG gateway, result: ' . $request_json->result . ', ref: ' . $request_json->ref, 'woocommerce_gateway_ipg');
                // log
                error_log('Received Payment successful from IPG gateway');
                // Order successful URL
            } else {
                $result_url .=  '&result=NOT_CAPTURED&responseCode='.$request_json->responsecode.'&ref='.$request_json->ref.'&responseDescription='.$request_json->responsedescription;
                // Mark order as 'failed'
                $order->update_status('failed', __('Received Payment Declined from IPG gateway , result: ' . $request_json->result . ', responseCode: ' . $request_json->responsecode . ', ref: ' . $request_json->ref.', responseDescription='.$request_json->responsedescription, 'woocommerce_gateway_ipg'));
                // log
                error_log('Received Payment Declined from IPG gateway ');
                // Order successful URL
            }
            // Command the redirection to the ThankYou page
            $message_verifier_fields_array = array(
                'PaymentNotificationResponse',
                '1',
                $request_json->paymentid,
                $WC_IPG_POST_Gateway->get_option('SecretKey'),
                $result_url
            );
            
            // load message verifier
            $msgVerifier = getMessageVerifier($message_verifier_fields_array);
            $successful_json_array = array(
                'paymentID' => $request_json->paymentid,
                'msgVerifier' => $msgVerifier,
                'msgName' => 'PaymentNotificationResponse',
                'version' => '1',
                'browserRedirectionURL' => $result_url
            );
            $response_json = json_encode($successful_json_array, JSON_PRETTY_PRINT);
            error_log('Sending JSON response:');
            error_log($response_json);
            echo $response_json;
        } else {
            error_log('IPG JSON Error Message:');
            error_log($request_json->errorCode);
            error_log($request_json->errorDesc);
            error_log($request_json->paymentid);
            error_log($request_json->trackid);
            
            wc_add_notice('IPG Response Error', 'error');
            wc_add_notice($request_json->errorDesc, 'error');
            
            // Get vars
            $trackid = intval($request_json->trackid);
            // Create the Order object
            $order = new WC_Order($trackid);
            // Mark as 'Processing'
            $order->update_status('failed', __('Received Error from IPG gateway payment, paymentid: ' . $request_json->paymentid . ', errorCode: ' . $request_json->errorCode . ', errorDesc: ' . $request_json->errorDesc, 'woocommerce_gateway_ipg'));
            
            $result_url = $order->get_checkout_order_received_url() . '&errorCode=' . $request_json->errorCode . '&errorDesc=' . $request_json->errorDesc;
            $message_verifier_fields_array = array(
                'PaymentNotificationResponse',
                '1',
                $request_json->paymentid,
                $WC_IPG_POST_Gateway->get_option('SecretKey'),
                // 'YXKZPOQ9RRLGPDED5D3PC5BJ',
                $result_url
            );
            
            // load message verifier
            $msgVerifier = getMessageVerifier($message_verifier_fields_array);
            
            $error_json_array = array(
                'paymentID' => $request_json->paymentid,
                'msgVerifier' => $msgVerifier,
                'msgName' => 'PaymentNotificationResponse',
                'version' => '1',
                'browserRedirectionURL' => $result_url
            );
            $response_json = json_encode($error_json_array, JSON_PRETTY_PRINT);
            error_log('Sending JSON response:');
            error_log($response_json);
            echo $response_json;
        }
        exit();

        return $template;
    }

    function getMessageVerifier($messageVerifierFields)
    {
        $messageVerifierBase = '';
        foreach ($messageVerifierFields as &$messageVerifierField) {
            $messageVerifierBase .= $messageVerifierField;
        }
        error_log('Message Verifier Base loaded: ');
        error_log($messageVerifierBase);
        
        $messageVerifierBase_hash = hash('sha256', $messageVerifierBase);
        error_log('Message Verifier Hash Hex loaded: ');
        error_log($messageVerifierBase_hash);
        
        $messageVerifierBase_hash_bytes = hex2bin($messageVerifierBase_hash);
        
        // Convert binary to base64
        $msgVerifier = base64_encode($messageVerifierBase_hash_bytes);
        error_log('Message Verifier Hash Base64 loaded: ');
        error_log($msgVerifier);
        return $msgVerifier;
    }

    class WC_IPG_POST_Gateway extends WC_Payment_Gateway
    {

        /**
         * Class constructor
         */
        public function __construct()
        {
            $this->id = 'asoftipg'; // payment gateway plugin ID

            $this->CheckoutIconUrl = $this->get_option('CheckoutIconUrl');
            
            if (empty($this->CheckoutIconUrl)) {
                // Set a default value
                $this->icon = plugin_dir_url(__FILE__) . '../ipg-gateway/assets/img/TASEE.png';
            } else {
                $this->icon = $this->CheckoutIconUrl;
            }
            
            $this->has_fields = false; // true in case you need a custom credit card form
            $this->method_title = 'IPG Gateway';
            $this->method_description = 'Description of IPG payment gateway'; // will be displayed on the options page
                                                                              
            // gateways can support subscriptions, refunds, saved payment methods,
                                                                              // but in this plugin we begin with simple payments
            $this->supports = array(
                'products'
            );
            
            // Method with all the options fields
            $this->init_form_fields();
            
            // Load the settings.
            $this->init_settings();
            $this->title = $this->get_option('title');
            $this->description = $this->get_option('description');
            $this->enabled = $this->get_option('enabled');
            
            $this->MessageType = $this->get_option('MessageType');
            $this->MessageVersion = $this->get_option('MessageVersion');
            $this->TerminalID = $this->get_option('TerminalID');
            $this->Password = $this->get_option('Password');
            $this->IPGURL = $this->get_option('IPGURL');
            $this->IPGSelect = $this->get_option('IPGSelect');
            $this->SecretKey = $this->get_option('SecretKey');
            $this->Action = $this->get_option('Action');
            $this->ResponseURL = $this->get_option('ResponseURL');
            $this->ErrorURL = $this->get_option('ErrorURL');
            $this->NotificationFormat = $this->get_option('NotificationFormat');
            $this->PaymentPageMode = $this->get_option('PaymentPageMode');
            $this->PaymentInstrument = $this->get_option('PaymentInstrument');
            $this->CardSHA2 = $this->get_option('CardSHA2');
            $this->PaymentTimeout = $this->get_option('PaymentTimeout');
            $this->Language = $this->get_option('Language');
            $this->PurchaseInstalData = $this->get_option('PurchaseInstalData');
            $this->CheckoutIconUrl = $this->get_option('CheckoutIconUrl');
            
            
            
            // This action hook saves the settings
            add_action('woocommerce_update_options_payment_gateways_' . $this->id, array(
                $this,
                'process_admin_options'
            ));
            
            // We need custom JavaScript to obtain a token
            // add_action( 'wp_enqueue_scripts', array( $this, 'payment_scripts' ) );
            
            // You can also register a webhook here
            // add_action( 'woocommerce_api_IPG_webhook', array( $this, 'webhook' ) );
        }

        /**
         * Plugin options
         */
        public function init_form_fields()
        {
            $this->form_fields = array(
                'title' => array(
                    'title' => 'Title',
                    'type' => 'text',
                    'description' => 'This controls the title which the user sees during checkout.',
                    'default' => 'Credit Card',
                    'desc_tip' => true
                ),
                'description' => array(
                    'title' => 'Description',
                    'type' => 'textarea',
                    'description' => 'This controls the description which the user sees during checkout.',
                    'default' => 'Pay with your credit card via our IPG payment gateway.'
                ),
                'enabled' => array(
                    'title' => 'Enable/Disable',
                    'label' => 'Enable IPG Gateway',
                    'type' => 'checkbox',
                    'description' => '',
                    'default' => 'no'
                ),
                'MessageType' => array(
                    'title' => 'Message Type',
                    'type' => 'select',
                    'default' => 'VISEC / VIREC first transaction',
                    'class' => 'MessageType wc-enhanced-select',
                    'options' => array(
                        'MessageType' => 'VISEC / VIREC first transaction'
                    )
                ),
                'MessageVersion' => array(
                    'title' => 'Message Version',
                    'type' => 'select',
                    'default' => '1',
                    'class' => 'MessageVersion wc-enhanced-select',
                    'options' => array(
                        '1' => '1'
                    )),
                'TerminalID' => array(
                    'title' => 'Terminal ID:',
                    'type' => 'text',
                    'default' => '89110001'
                ),
                'Password' => array(
                    'title' => 'Password:',
                    'type' => 'password',
                    'default' => 'test1234'
                ),
                'IPGURL' => array(
                    'title' => 'IPG:',
                    'type' => 'text',
                    'default' => 'http://ipg-test:9080/IPGWeb/servlet/PaymentInitRequest'
                ),
                'SecretKey' => array(
                    'title' => 'Secret Key:',
                    'type' => 'text',
                    'default' => 'YXKZPOQ9RRLGPDED5D3PC5BJ'
                ),
                'Action' => array(
                    'title' => 'Action:',
                    'type' => 'select',
                    'default' => '1',
                    'class' => 'Action wc-enhanced-select',
                    'options' => array(
                        '1' => 'PURCHASE',
                        '4' => 'AUTHORIZATION'
                    )
                ),
                'ResponseURL' => array(
                    'title' => 'RESPONSE URL:',
                    'type' => 'text',
                    'default' => get_home_url() . '/wc-api/CALLBACK/?ipg_response_interface=1'
                ),
                'ErrorURL' => array(
                    'title' => 'ERROR URL:',
                    'type' => 'text',
                    'default' => get_home_url() . '/wc-api/CALLBACK/?ipg_response_interface=1'
                ),
                'NotificationFormat' => array(
                    'title' => 'Notiication Format:',
                    'type' => 'select',
                    'default' => 'json',
                    'class' => 'NotificationFormat wc-enhanced-select',
                    'options' => array(
                        'json' => 'JSON'
                    )
                ),
                'PaymentPageMode' => array(
                    'title' => 'Payment Page Mode:',
                    'type' => 'select',
                    'default' => '0',
                    'class' => 'PaymentPageMode wc-enhanced-select',
                    'options' => array(
                        '0' => 'STANDARD'
                    )
                ),
                'PaymentInstrument' => array(
                    'title' => 'Payment Instrument:',
                    'type' => 'text',
                    'default' => ''
                ),
                'CardSHA2' => array(
                    'title' => 'CARD SHA2:',
                    'type' => 'select',
                    'default' => 'Y',
                    'class' => 'CardSHA2 wc-enhanced-select',
                    'options' => array(
                        'Y' => 'Yes',
                        'N' => 'No'
                    )
                ),
                'PaymentTimeout' => array(
                    'title' => 'Payment Timeout:',
                    'type' => 'text',
                    'default' => '30'
                ),
                'Language' => array(
                    'title' => 'Language:',
                    'type' => 'text',
                    'default' => 'USA'
                ),
                'PurchaseInstalData' => array(
                    'title' => 'Installment Number: ',
                    'type' => 'text',
                    'default' => ''
                ),
                
                'CheckoutIconUrl' => array(
                    'title' => 'Checkout Icon URL: ',
                    'type' => 'text',
                    'description' => 'Insert URL of your Checkout Icon, or leave empty to use the default one.',
                    'default' => ''
                )
            );
        }

        public function process_payment($order_id)
        {
            global $woocommerce;
            
            // we need it to get any order detailes
            $order = new WC_Order($order_id);
            
            $args = array(
                "msgName" => "PaymentInitRequest",
                'version' => $this->MessageVersion,
                'id' => $this->TerminalID,
                'password' => $this->Password,
                
                'msgVerifier' => "",
                'langId' => $this->Language,
                
                'CartContent' => $this->CartContent, // JSON [complex]
                                                     
                // 'buyerFirstName' => $this->FirstName,
                                                     // 'buyerFirstName' => "",
                                                     // 'buyerLastName' => "",
                                                     // 'buyerUserId' => "",
                                                     // 'buyerPhoneNumber' => "",
                                                     // 'buyeremailaddress' => "",
                                                     // 'clientIpAddress' => "",
                                                     // 'clientUserAgent' => "",
                                                     // 'clientHttpHeaders' => "",
                                                     
                // 'shippingInfo' => "", // JSON
                                                     // 'billingInfo' => "", // JSON
                                                     
                // 'acctType' => "",
                                                     // 'accountInfo' => "", // JSON
                                                     // 'authenticationInfo' => "", // JSON
                                                     // 'priorAuthenticationInfo'=> "", // JSON
                
                'action' => $this->Action,
                'recurAction' => "",
                'recurContractId' => "",
                'responseURL' => $this->ResponseURL, // responseURL
                'errorURL' => $this->ErrorURL, // errorURL
                'currencycode' => $order->get_currency(),
                'amt' => $order->get_total(),
                'trackid' => $order_id,
                'cardSHA2' => $this->CardSHA2,
                'paymentTimeout' => $this->PaymentTimeout,
                //'pymnDscr' => $this->PaymentDescription,
                'notificationFormat' => $this->NotificationFormat,
                'paymentPageMode' => $this->PaymentPageMode,
                'payinst' => $this->PaymentInstrument,
                'purchaseInstalData' => $this->PurchaseInstalData,
            );
            
            if (! function_exists('write_log')) {

                function write_log($log)
                {
                    if (true === WP_DEBUG) {
                        if (is_array($log) || is_object($log)) {
                            error_log(print_r($log, true));
                        } else {
                            error_log($log);
                        }
                    }
                }
            }
            
            $message_verifier_fields_array = array(
                $args['msgName'],
                $args['version'],
                $args['id'],
                $args['password'],
                $args['amt'],
                $args['trackid'],
                '',
                $this->SecretKey,
                ''
            );
            
            // load message verifier
            $args['msgVerifier'] = getMessageVerifier($message_verifier_fields_array);
            
            $args['errorURL'] = $order->get_checkout_order_received_url();
            /*
             * Your API interaction could be built with wp_remote_post()
             */
            // $response = wp_remote_post( '{payment processor endpoint}', $args );
            
            $ipg_url = $this->IPGURL;
            write_log('Sending request, url: ');
            write_log($ipg_url);
            
            $request_preety_json = json_encode($args, JSON_PRETTY_PRINT);
            write_log('request_preety_json: ');
            write_log($request_preety_json);
            
            $request_json = json_encode($args);
            write_log('request_json: ');
            write_log($request_json);
            
            // $url = 'localhost:9082/IPGWeb/servlet/PaymentInitRequest';
            $response = wp_remote_post($ipg_url, array(
                'headers' => array(
                    'Accept' => 'application/json',
                    'Content-Type' => 'application/json; charset=utf-8'
                ),
                'body' => $request_json,
                'method' => 'POST',
                'data_format' => 'body'
            ));
            
            if (is_wp_error($response) && ! empty($response->errors)) {
                wc_add_notice('HTTP Response Error', 'error');
                wc_add_notice($response->get_error_message(), 'error');
                return;
            }
            
            $response_code = wp_remote_retrieve_response_code($response);
            write_log('Loaded response code, response_code: ');
            write_log($response_code);
            if (! in_array($response_code, array(
                200,
                201
            ))) {
                wc_add_notice('HTTP Status Error', 'error');
                wc_add_notice($response_code, 'error');
                return;
            }
            
            $response_body = wp_remote_retrieve_body($response);
            write_log('Loaded response body, response_body: ');
            write_log($response_body);
            
            $response_json = json_decode($response_body);
            if (json_last_error() > JSON_ERROR_NONE) {
                wc_add_notice('Response JSON Error:', 'error');
                wc_add_notice(json_last_error_msg(), 'error');
                return;
            }
            
            write_log('Loadded JSON response, response_preety_json: ');
            $response_preety_json = json_encode($response_json, JSON_PRETTY_PRINT);
            write_log($response_preety_json);
            
            // it could be different depending on your payment processor
            if ($response_json->type == 'valid') {
                
                $response_url = $response_json->browserRedirectionURL;
                $response_url .= "?PaymentID=";
                $response_url .= $response_json->paymentid;
                
                if (! filter_var($response_url, FILTER_VALIDATE_URL)) {
                    wc_add_notice('Invalid IPG Response Url:', 'error');
                    wc_add_notice($response_url, 'error');
                    return;
                }
                
                // Mark as on-hold (we're awaiting the cheque)
                $order->update_status('on-hold', __('Awaiting IPG payment', 'ipg_plugin'));
                
                // // Reduce stock levels
                // $order->reduce_order_stock();
                
                // // Remove cart
                // $woocommerce->cart->empty_cart();
                
                // Redirect to the thank you page
                return array(
                    'result' => 'success',
                    'redirect' => $response_url
                );
            } else {
                wc_add_notice('IPG Response Error:', 'error');
                wc_add_notice($response_json->errorCode, 'error');
                wc_add_notice($response_json->errorDesc, 'error');
                return;
            }
                        
        }
        
         
    }
    
    
    // REFOUND CALL 1!
    
    // add the action
    add_action( 'woocommerce_order_refunded', 'action_woocommerce_order_refunded', 10, 2 );
    
    // Do the magic line 659
    function action_woocommerce_order_refunded( $order_id, $refund_id )
    {
        // Your code here
        error_log('REFOUND CALL >>> POST');

        error_log('Order ID: ');
        error_log($order_id);
        
        error_log('$refund_id: ');
        error_log($refund_id);        
        
        // we need it to get any order detailes
        $order = new WC_Order($order_id);
        
        $ipg_url =  'http://ipg-test:33666/IPGWeb/servlet/PaymentInitRequest';
        
        //  Sta treba da posaljem, i kako to da dohvatim i spakujem            <<<<<
        
        global $woocommerce;
        $order = new WC_Order($order_id);
        $WC_IPG_POST_Gateway = new WC_IPG_POST_Gateway();
        
       
        $a = array ($WC_IPG_POST_Gateway->get_form_fields());
        $b = $a['SecretKey'][0]->SecretKey;
        $b = 'YXKZPOQ9RRLGPDED5D3PC5BJ';
        
        error_log(' SecretKey == ');
        error_log( $b );
        
        //init_form_fields();

        $args = array(
            'msgName'           => 'FinancialRequest',               
            'version'           => '1',                              
            'id'                => '89110001',     
            'password'          => 'test1234',                       
            'action'            => '2',                             
            'amt'               => '0,01',                           
            'currencycode'      => '840',                            
            'trackid'           => 'CTV-TEST-PureBuy-1',              
            'tranid'            => '980026872121022345', 
            'udf1'               => 'AA',
            'udf2'               => 'BB',
            'udf3'               => 'CC',
            'udf4'               => 'DD',
            'udf5'               => 'EE',
        );
        
        $refund_parameters_message_verifier_fields_array = array(
            $args['msgName'],
            $args['version'],
            $args['id'],
            $args['password'],
            $args['amt'],
            $args['trackid'],
            '',
            $b,
            ''
        );
        
        // Just print to LOG
        $request_preety_json = json_encode($args, JSON_PRETTY_PRINT);
        error_log('request_preety_json: ');
        error_log($request_preety_json);
        
        $refund_parameters_message_verifier_preety_json = json_encode($args, JSON_PRETTY_PRINT);
        error_log('request_preety_json: ');
        error_log($refund_parameters_message_verifier_preety_json);
        
        // load message verifier
        $msgVerifier = getMessageVerifier($refund_parameters_message_verifier_fields_array);
        $args['msgVerifier'] = $msgVerifier;

        error_log(' msgVerifier== ');
        error_log( $msgVerifier );
                
        $json_to_go = json_encode($args);
        error_log($json_to_go);
        
        $response = wp_remote_post($ipg_url, array(
            'headers'     => array('Content-Type' => 'application/json; charset=utf-8'),
            'body'        => json_encode($args),
            'method'      => 'POST',
            'data_format' => 'body',
        ));
        
        error_log('DUMMY TEST NOVAK, received data: ');
        
        error_log(' transactionId== ');
        error_log($response->transactionId);
        
        error_log(' order_number== ');
        error_log($response->order_number);
        

    }
    

    
}
</file>

<file path="java-api-developer-guide.md">
# Developer Documentation: Sending Data to Java API for Payment Initialization

## Overview

This document provides an updated, step-by-step guide for developers integrating with the Java-based payment gateway API. It provides insights into the payment initiation request, response handling, logging, and real-world examples.

### Table of Contents

1. [Introduction](#introduction)
2. [API Endpoint Details](#api-endpoint-details)
3. [Request Payload Structure](#request-payload-structure)
4. [Message Verifier Generation](#message-verifier-generation)
5. [Sending the Request](#sending-the-request)
6. [Handling the Response](#handling-the-response)
7. [PHP Implementation Example](#php-implementation-example)
8. [Error Handling and Troubleshooting](#error-handling-and-troubleshooting)
9. [Testing and Debugging](#testing-and-debugging)

## Introduction

The Java API is used to initiate payment transactions by providing merchant and payment details. This guide ensures that developers prepare the correct request payload, generate required verifications, and manage both responses and errors effectively.

## API Endpoint Details

- **URL**: `https://java-api-endpoint.com/IPGWeb/servlet/`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Authentication**: Requests must include necessary authentication headers if required by the API.

## Request Payload Structure

The payload for the payment initiation request must be in JSON format, with the following fields:

| Field Name           | Type    | Description                                                               | Mandatory |
|----------------------|---------|---------------------------------------------------------------------------|-----------|
| `msgName`            | String  | Name of the message (`PaymentInitRequest`).                               | Yes       |
| `version`            | String  | Version of the API, e.g., `1`.                                            | Yes       |
| `action`             | String  | Type of transaction (`1` for Purchase, `4` for Authorization).            | Yes       |
| `currencyCode`       | String  | Currency code for the transaction, e.g., `USD`, `EUR`.                    | Yes       |
| `amt`                | String  | Transaction amount in the format `NNNNNNNNNN.NN`, e.g., `100.00`.         | Yes       |
| `trackId`            | String  | Unique identifier for the transaction, generated by the merchant.         | Yes       |
| `responseURL`        | String  | URL to which the user will be redirected upon successful payment.         | Yes       |
| `errorURL`           | String  | URL to which the user will be redirected if an error occurs.              | Yes       |
| `recurAction`        | String  | Recurring payment action*                                                 | Yes       |
| `payInst`            | String  | Payment instrument, e.g., `CC` for Credit Card.                           | No        |
| `paymentTimeout`     | String  | Duration of the payment session in minutes, e.g., `30`.                   | No        |
| `cardSHA2`           | String  | Whether the card SHA2 hash should be sent (`Y` or `N`).                   | No        |
| `bankStmtFreeText`   | String  | Free text to be included in the bank statement.                           | No        |
| `notificationFormat` | String  | Format of the notification, either `xml` or `json`.                       | No        |
| `paymentPageMode`    | String  | Payment page mode (`0` for Standard, `1` for Lightbox).                   | No        |
| `langId`             | String  | Language**                                                                | No        |
| `udf1` - `udf5`      | String  | User-defined fields for custom information to be passed back.             | No        |

* recurAction Possible values (case insensitive): `""` for normal e-commerce order, `activation` for new Recurring Payment activation, `consumer_initiated` for card-on-file consumer-initiated payment.
** langId in which HPP will be displayed and for notification email. Supported values are: `ITA` (Italian), `USA` (English), `FRA` (French), `DEU` (German), `ESP` (Spanish), `SLO` (Slovenian), `SRB` (Serbian), `POR` (Portuguese), `RUS` (Russian).

### Message Verifier Generation

To ensure data integrity, the `msgVerifier` field must be generated by concatenating specific fields, hashing them with SHA-256, and encoding the hash in Base64.

The fields used for generating the `msgVerifier` are as follows (concatenated in the exact order):

- `msgName`, `version`, `id`, `password`, `amt`, `trackid`, `udf1`, `SECRET KEY`, `udf5`

**Steps:**
1. **Concatenate the field values** (remove any spaces).
2. **Hash the concatenated string** using SHA-256.
3. **Encode the hash** using Base64 to create the final `msgVerifier` value.

### Example of `msgVerifier` Generation

```java
public static void main(String[] args) { 
    try { 
        String messageVerifierBase = "PaymentInitRequest189110001test123415.00TRACK123AAYXKZPOQ9RRLGPDED5D3PC5BJEE"; 
        MessageDigest digest = MessageDigest.getInstance("SHA-256"); 
        byte[] hashBytes = digest.digest(messageVerifierBase.getBytes()); 
        String msgVerifier = Base64.getEncoder().encodeToString(hashBytes); 
        System.out.println("msgVerifier: " + msgVerifier); 
    } catch (Exception e) {
        e.printStackTrace(); 
    }
}
```

## Sending the Request

To send data to the Java API:

1. **Prepare the JSON Payload**: Create a JSON object with the required parameters.
2. **Initiate the Request**: Use an HTTP client (e.g., cURL, Postman, or a custom script) to send the JSON payload to the API.
3. **Set Headers**: Set `Content-Type` to `application/json`.

## Handling the Response

The Java API responds with a JSON object containing:

- **`paymentId`**: A unique identifier for the payment.
- **`browserRedirectionURL`**: URL to redirect the user to complete payment.

### Sample Response

```json
{
  "paymentId": "1234567890",
  "browserRedirectionURL": "https://payment-gateway.com/redirect?paymentID=1234567890",
  "responsecode": "00",
  "msgVerifier": "s6VGF9LprNkHnYXqFdBmpYkuPKvhtB2kiRs6Zf+qDM4="
}
```

### Redirection

Use the `browserRedirectionURL` to redirect the user to continue the payment process. Store the `paymentId` for tracking purposes.

## PHP Implementation Example

Below is a sample PHP script for sending the payment initiation request following WooCommerce and WordPress coding standards:

```php
<?php
// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

$request_data = [
    'msgName'            => 'PaymentInitRequest',
    'version'            => '1',
    'action'             => '1',
    'currencyCode'       => 'USD',
    'amt'                => '100.00',
    'trackId'            => uniqid( 'TRACK' ),
    'responseURL'        => esc_url( 'https://your-website.com/success' ),
    'errorURL'           => esc_url( 'https://your-website.com/error' ),
    'recurAction'        => '',
    'payInst'            => 'VPAS',
    'paymentTimeout'     => '30',
    'cardSHA2'           => 'Y',
    'notificationFormat' => 'json',
    'paymentPageMode'    => '0',
    'langId'             => 'USA',
    'udf1'               => sanitize_text_field( 'AA' ),
    'udf2'               => sanitize_text_field( 'BB' ),
    'udf3'               => sanitize_text_field( 'CC' ),
    'udf4'               => sanitize_text_field( 'DD' ),
    'udf5'               => sanitize_text_field( 'EE' ),
];

// Convert request data to JSON.
$request_payload = wp_json_encode( $request_data );

// Endpoint URL.
$api_url = esc_url( 'https://java-api-endpoint.com/IPGWeb/servlet/' );

// Use cURL to send the request.
$ch = curl_init( $api_url );
curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
curl_setopt( $ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
] );
curl_setopt( $ch, CURLOPT_POST, true );
curl_setopt( $ch, CURLOPT_POSTFIELDS, $request_payload );

// Execute the request.
$response = curl_exec( $ch );

// Handle response and errors.
if ( curl_errno( $ch ) ) {
    error_log( 'Error: ' . curl_error( $ch ) );
} else {
    // Log the response for debugging purposes.
    error_log( 'Response: ' . print_r( $response, true ) );
}

curl_close( $ch );
?>
```

## Error Handling and Troubleshooting

- **API Errors**: Handle error fields like `errorCode`, `errorService`, and `errorDesc` to understand what went wrong.
- **Network Issues**: Detect issues using `curl_errno()` in PHP, and handle them gracefully.
- **Logging**: Log request and response data using `error_log()`, but **never** log sensitive information.

### Example Error Response

```json
{
  "errorCode": "05",
  "errorService": "Authorization Service",
  "errorDesc": "Do not honor",
  "msgVerifier": "xyzGeneratedVerifier"
}
```

## Testing and Debugging

- **Use Postman**: Validate API responses manually.
- **Mock URLs**: Use mock URLs during development to ensure correct handling of both success and failure responses.
- **Testing Environments**: Use IPG's test environments to validate the end-to-end payment flow.

## Conclusion

This updated developer guide integrates insights from real-world logs, ensuring that developers have the most accurate and comprehensive reference for integrating with the payment gateway API. Proper alignment between the API payload and logging ensures smoother development and testing phases.

Feel free to reach out for more detailed troubleshooting or questions regarding your specific integration scenario.
</file>

</repository_files>
